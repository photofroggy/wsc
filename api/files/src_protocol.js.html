<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>wsc documentation</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <!--<link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">-->
    <link rel="stylesheet" href="/wsc/css/main.css">
    <link rel="stylesheet" href="/wsc/css/features.css">
    <link rel="stylesheet" href="/wsc/css/docs.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
    <script type="text/javascript" src="/wsc/js/zepto.js"></script>
</head>
<body>
    <div class="squeeze">
        <nav class="menu">
            <ul>
                <li><a href="/wsc/">wsc</a></li>
                <li><a href="/wsc/damn/">wsc.dAmn</a></li>
                <li><a href="/wsc/extensions/">making extensions</a></li>
                <li><a href="/wsc/api/" class="active">api documentation</a></li>
            </ul>
        </nav>
        <nav class="contents">
    <h3>Classes</h3>
    <ul>
    
        <li><a href="/wsc/api/classes/Chatterbox.Channel.html">Chatterbox.Channel</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Chatbook.html">Chatterbox.Chatbook</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Control.html">Chatterbox.Control</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Navigation.html">Chatterbox.Navigation</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Pager.html">Chatterbox.Pager</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Popup.html">Chatterbox.Popup</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.html">Chatterbox.Settings</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Config.html">Chatterbox.Settings.Config</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.html">Chatterbox.Settings.Item</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Checkbox.html">Chatterbox.Settings.Item.Checkbox</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Form.html">Chatterbox.Settings.Item.Form</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Form.Checkbox.html">Chatterbox.Settings.Item.Form.Checkbox</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Form.Colour.html">Chatterbox.Settings.Item.Form.Colour</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Form.Field.html">Chatterbox.Settings.Item.Form.Field</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Form.Radio.html">Chatterbox.Settings.Item.Form.Radio</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Items.html">Chatterbox.Settings.Item.Items</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Item.Radio.html">Chatterbox.Settings.Item.Radio</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.Settings.Page.html">Chatterbox.Settings.Page</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.UI.html">Chatterbox.UI</a></li>
    
        <li><a href="/wsc/api/classes/Chatterbox.UI.sound.html">Chatterbox.UI.sound</a></li>
    
        <li><a href="/wsc/api/classes/dAmn.avatar.html">dAmn.avatar</a></li>
    
        <li><a href="/wsc/api/classes/dAmn.Extension.html">dAmn.Extension</a></li>
    
        <li><a href="/wsc/api/classes/dAmn.Stash.html">dAmn.Stash</a></li>
    
        <li><a href="/wsc/api/classes/dAmn.TablumpParser.html">dAmn.TablumpParser</a></li>
    
        <li><a href="/wsc/api/classes/dAmn.TablumpString.html">dAmn.TablumpString</a></li>
    
        <li><a href="/wsc/api/classes/EventEmitter.html">EventEmitter</a></li>
    
        <li><a href="/wsc/api/classes/jQuery.plugin.html">jQuery.plugin</a></li>
    
        <li><a href="/wsc/api/classes/StringSet.html">StringSet</a></li>
    
        <li><a href="/wsc/api/classes/template.html">template</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Channel.html">wsc.Channel</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Client.html">wsc.Client</a></li>
    
        <li><a href="/wsc/api/classes/wsc.defaults.Extension.html">wsc.defaults.Extension</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Flow.html">wsc.Flow</a></li>
    
        <li><a href="/wsc/api/classes/wsc.MessageParser.html">wsc.MessageParser</a></li>
    
        <li><a href="/wsc/api/classes/wsc.MessageString.html">wsc.MessageString</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Middleware.html">wsc.Middleware</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Packet.html">wsc.Packet</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Protocol.html">wsc.Protocol</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Protocol.LogMessage.html">wsc.Protocol.LogMessage</a></li>
    
        <li><a href="/wsc/api/classes/wsc.SocketIO.html">wsc.SocketIO</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Storage.html">wsc.Storage</a></li>
    
        <li><a href="/wsc/api/classes/wsc.Transport.html">wsc.Transport</a></li>
    
        <li><a href="/wsc/api/classes/wsc.WebSocket.html">wsc.WebSocket</a></li>
    
    </ul>
</nav>
        <div class="content">
            <h1 class="file-heading">File: src&#x2F;protocol.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * Parser for dAmn-like protocols.
 * 
 * @class wsc.Protocol
 * @constructor
 * @param [mparser=wsc.MessageParser] {Object} Message parser instance.
 *&#x2F;
wsc.Protocol = function( mparser ) {

    this.mparser = mparser || new wsc.MessageParser;
    this.chains = [[&quot;recv&quot;, &quot;admin&quot;]];
    
    &#x2F;**
     * Mapping object.
     * 
     * This object determines how each protocol packet should be mapped from a &#x60;packet object&#x60;
     * to an &#x60;event object&#x60;. For each packet, there is an entry, where the key is the
     * {{#crossLink &quot;wsc.Protocol&#x2F;event:method&quot;}}event name{{&#x2F;crossLink}} of the packet.
     * 
     * Each entry is an array. The array consists of names under which to store packet data.
     * The array is of the structure &#x60;[ param, args, body ]&#x60;. All items are optional, but
     * positional. To discard a particular piece of data, &#x60;null&#x60; can be used.
     * 
     * When &#x60;args&#x60; is present it must be an array. This array names the arguments to store.
     * Each item in the &#x60;args&#x60; array can be a string or a pair of strings. For strings,
     * the corresponding packet argument is stored using its own name. For pairs, the packet
     * argument named by the first string is stored using the second string as the key.
     * 
     * When &#x60;body&#x60; is present, it can either be a string or an array. If a string is provided,
     * the entire body is stored using the string as the key. If an array is provided, it
     * treated as another mapping array. This is handled recursively.
     * 
     * Keys in the mapping array can start with an asterisks (&#x60;*&#x60;). This indicates that the
     * value is a formatted string and needs to be parsed using a
     * {{#crossLink &quot;wsc.MessageParser&quot;}}message parser{{&#x2F;crossLink}}. The asterisks is
     * removed from the key in the final object.
     * 
     * As an example, property packets use this mapping array:
     * 
     *      this.maps[&#x27;property&#x27;] = [&#x27;ns&#x27;, [&#x27;p&#x27;, &#x27;by&#x27;, &#x27;ts&#x27;], &#x27;*value&#x27; ];
     * 
     * When mapping a property packet, the returned object looks like the following:
     *      
     *      {
     *          &quot;name&quot;: &quot;property&quot;,
     *          &quot;ns&quot;: pkt.param,
     *          &quot;p&quot;: pkt.arg.p,
     *          &quot;by&quot;: pkt.arg.by,
     *          &quot;ts&quot;: pkt.arg.ts,
     *          &quot;value&quot;: pkt.body
     *      }
     * 
     * For an example of arguments being mapped to different keys, kick
     * (error) packets use this mapping array:
     * 
     *      this.maps[&#x27;kick&#x27;] = [&#x27;ns&#x27;, [[&#x27;u&#x27;, &#x27;user&#x27;], &#x27;e&#x27;]];
     * 
     * For this array, the returned object looks like the following:
     *      
     *      {
     *          &quot;name&quot;: &quot;kick&quot;,
     *          &quot;ns&quot;: pkt.param,
     *          &quot;user&quot;: pkt.arg.u,
     *          &quot;e&quot;: pkt.body
     *      }
     *
     * @property maps
     * @type Object
     *&#x2F;
    this.maps = {
        &#x27;chatserver&#x27;: [&#x27;version&#x27;],
        &#x27;login&#x27;: [&#x27;username&#x27;, [&#x27;e&#x27;], &#x27;data&#x27;],
        &#x27;join&#x27;: [&#x27;ns&#x27;, [&#x27;e&#x27;] ],
        &#x27;part&#x27;: [&#x27;ns&#x27;, [&#x27;e&#x27;, &#x27;*r&#x27;] ],
        &#x27;property&#x27;: [&#x27;ns&#x27;, [&#x27;p&#x27;, &#x27;by&#x27;, &#x27;ts&#x27;], &#x27;*value&#x27; ],
        &#x27;recv_msg&#x27;: [null, [[&#x27;from&#x27;, &#x27;user&#x27;]], &#x27;*message&#x27;],
        &#x27;recv_npmsg&#x27;: [null, [[&#x27;from&#x27;, &#x27;user&#x27;]], &#x27;message&#x27;],
        &#x27;recv_action&#x27;: [null, [&#x27;s&#x27;, [&#x27;from&#x27;, &#x27;user&#x27;]], &#x27;*message&#x27;],
        &#x27;recv_join&#x27;: [&#x27;user&#x27;, [&#x27;s&#x27;], &#x27;*info&#x27;],
        &#x27;recv_part&#x27;: [&#x27;user&#x27;, [&#x27;s&#x27;, &#x27;r&#x27;]],
        &#x27;recv_privchg&#x27;: [&#x27;user&#x27;, [&#x27;s&#x27;, &#x27;by&#x27;, &#x27;pc&#x27;]],
        &#x27;recv_kicked&#x27;: [&#x27;user&#x27;, [[&#x27;i&#x27;, &#x27;s&#x27;], &#x27;by&#x27;], &#x27;*r&#x27;],
        &#x27;recv_admin_create&#x27;: [null, [&#x27;p&#x27;, [&#x27;by&#x27;, &#x27;user&#x27;], [&#x27;name&#x27;, &#x27;pc&#x27;], &#x27;privs&#x27;]],
        &#x27;recv_admin_update&#x27;: [null, [&#x27;p&#x27;, [&#x27;by&#x27;, &#x27;user&#x27;], [&#x27;name&#x27;, &#x27;pc&#x27;], &#x27;privs&#x27;]],
        &#x27;recv_admin_rename&#x27;: [null, [&#x27;p&#x27;, [&#x27;by&#x27;, &#x27;user&#x27;], &#x27;prev&#x27;, [&#x27;name&#x27;, &#x27;pc&#x27;]]],
        &#x27;recv_admin_move&#x27;: [null, [&#x27;p&#x27;, [&#x27;by&#x27;, &#x27;user&#x27;], &#x27;prev&#x27;, [&#x27;name&#x27;, &#x27;pc&#x27;], [&#x27;n&#x27;, &#x27;affected&#x27;]]],
        &#x27;recv_admin_remove&#x27;: [null, [&#x27;p&#x27;, [&#x27;by&#x27;, &#x27;user&#x27;], [&#x27;name&#x27;, &#x27;pc&#x27;], [&#x27;n&#x27;, &#x27;affected&#x27;]]],
        &#x27;recv_admin_show&#x27;: [null, [&#x27;p&#x27;], &#x27;info&#x27;],
        &#x27;recv_admin_showverbose&#x27;: [null, [&#x27;p&#x27;], &#x27;info&#x27;],
        &#x27;recv_admin_privclass&#x27;: [null, [&#x27;p&#x27;, &#x27;e&#x27;], &#x27;command&#x27;],
        &#x27;kicked&#x27;: [&#x27;ns&#x27;, [[&#x27;by&#x27;, &#x27;user&#x27;]], &#x27;*r&#x27;],
        &#x27;ping&#x27;: [],
        &#x27;disconnect&#x27;: [null, [&#x27;e&#x27;]],
        &#x27;send&#x27;: [&#x27;ns&#x27;, [&#x27;e&#x27;]],
        &#x27;kick&#x27;: [&#x27;ns&#x27;, [[&#x27;u&#x27;, &#x27;user&#x27;], &#x27;e&#x27;]],
        &#x27;get&#x27;: [&#x27;ns&#x27;, [&#x27;p&#x27;, &#x27;e&#x27;]],
        &#x27;set&#x27;: [&#x27;ns&#x27;, [&#x27;p&#x27;, &#x27;e&#x27;]],
        &#x27;kill&#x27;: [&#x27;ns&#x27;, [&#x27;e&#x27;]],
        &#x27;unknown&#x27;: [null, null, null, &#x27;packet&#x27;],
    };
    
    &#x2F;&#x2F; Mapping callbacks!
    var p = this;
    this.mapper = {
        &quot;recv&quot;: function( packet, args, mapping ) {
            args.ns = packet.param;
            return p.map(packet.sub[0], args, mapping);
        }
        
    };
    
    &#x2F;**
     * Messages object.
     * 
     * This object determines how each protocol packet should be rendered based
     * data from an &#x60;event object&#x60;. For each packet, there is an entry, where the key is the
     * {{#crossLink &quot;wsc.Protocol&#x2F;event:method&quot;}}event name{{&#x2F;crossLink}} of the packet.
     * 
     * Each entry is an array. The array consists of options for rendering and
     * logging. The array is of the structure &#x60;[ renderers, monitor, global ]&#x60;.
     * All items are optional, but positional. There are default options that
     * can be used.
     * 
     * When &#x60;renderers&#x60; is present it must be an array. This array contains
     * renderers for different kinds of formats. Renderers can be either a
     * formatted string or a callback that returns a string. There must be at
     * least one renderer, for text output. Otherwise the array should contain
     * a renderer for text ouput, a renderer for HTML output, and a renderer
     * for ANSI output. If a renderer is missing then everything falls back to
     * text renderer.
     * 
     * The &#x60;monitor&#x60; option determines whether or not to display the log
     * message in the monitor channel. The default for this is &#x60;false&#x60;.
     * 
     * The &#x60;global&#x60; option determines whether or not to display the log message
     * in every open channel. The default for this is also &#x60;false&#x60;.
     * 
     * An example for an entry in this object:
     *      
     *      { &#x27;join&#x27;: [
     *          [
     *              &#x27;** Join {ns}: &quot;{e}&quot; *&#x27;,
     *              &#x27;&lt;span class=&quot;servermsg&quot;&gt;** Join {ns}: &quot;{e}&quot; *&lt;&#x2F;span&gt;&#x27;
     *          ],
     *          true
     *      ] }
     * 
     * This shows how the join packet will render in the monitor channel. If a
     * channel is set to display in the monitor channel, then it should not
     * be displayed in the event channel.
     *
     * At the moment, we only have to render using HTML, so the &#x60;renderers&#x60;
     * array in the entries are only HTML renderers at the moment. No array,
     * just formatting strings.
     * 
     * To display absolutely nothing for an event, the whole entry can simply
     * be &#x60;null&#x60;.
     * @property messages
     * @type Object
     *&#x2F;
    &#x2F;&#x2F;  &#x27;event&#x27;: [ template, monitor, global ]
    this.messages = {
        &#x27;chatserver&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Connected to llama {version} *&lt;&#x2F;span&gt;&#x27;, false, true ],
        &#x27;login&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Login as {username}: &quot;{e}&quot; *&lt;&#x2F;span&gt;&#x27;, false, true],
        &#x27;join&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Join {ns}: &quot;{e}&quot; *&lt;&#x2F;span&gt;&#x27;, true],
        &#x27;part&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Part {ns}: &quot;{e}&quot; * &lt;em&gt;{r}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;, true],
        &#x27;property&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Got {p} for {ns} *&lt;&#x2F;span&gt;&#x27;, true],
        &#x27;recv_msg&#x27;: [&#x27;&lt;span class=&quot;cmsg user u-{user}&quot;&gt;&lt;strong&gt;&amp;lt;{user}&amp;gt;&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;cmsg u-{user}&quot;&gt;{message}&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_npmsg&#x27;: [&#x27;&lt;span class=&quot;cmsg user u-{user}&quot;&gt;&lt;strong&gt;&amp;lt;{user}&amp;gt;&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;cmsg u-{user}&quot;&gt;{message}&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_action&#x27;: [&#x27;&lt;span class=&quot;caction user u-{user}&quot;&gt;&lt;em&gt;* {user}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&lt;span class=&quot;caction u-{user}&quot;&gt;{message}&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_join&#x27;: [&#x27;&lt;span class=&quot;cevent bg&quot;&gt;** {user} has joined *&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_part&#x27;: [&#x27;&lt;span class=&quot;cevent bg&quot;&gt;** {user} has left * &lt;em&gt;{r}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_privchg&#x27;: [&#x27;&lt;span class=&quot;cevent&quot;&gt;** {user} has been made a member of {pc} by {by} *&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_kicked&#x27;: [&#x27;&lt;span class=&quot;cevent&quot;&gt;** {user} has been kicked by {by} * &lt;em&gt;{r}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_admin_create&#x27;: [&#x27;&lt;span class=&quot;cevent admin&quot;&gt;** Privilege class {pc} has been created by {user} * &lt;em&gt;{privs}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_admin_update&#x27;: [&#x27;&lt;span class=&quot;cevent admin&quot;&gt;** Privilege class {pc} has been updated by {user} * &lt;em&gt;{privs}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_admin_rename&#x27;: [&#x27;&lt;span class=&quot;cevent admin&quot;&gt;** Privilege class {prev} has been renamed to {pc} by {user} *&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_admin_move&#x27;: [&#x27;&lt;span class=&quot;cevent admin&quot;&gt;** All members of {prev} have been moved to {pc} by {user} * &lt;em&gt;{affected} affected user(s)&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_admin_remove&#x27;: [&#x27;&lt;span class=&quot;cevent admin&quot;&gt;** Privilege class {pc} has been removed by {user} * &lt;em&gt;{affected} affected user(s)&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;recv_admin_show&#x27;: null,
        &#x27;recv_admin_showverbose&#x27;: null,
        &#x27;recv_admin_privclass&#x27;: [&#x27;&lt;span class=&quot;cevent admin&quot;&gt;** Admin command &quot;{command}&quot; failed * &lt;em&gt;{e}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;kicked&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** You have been kicked by {user} * &lt;em&gt;{r}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;ping&#x27;: null, &#x2F;&#x2F;[&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Ping...&lt;&#x2F;span&gt;&#x27;, true],
        &#x27;disconnect&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** You have been disconnected * &lt;em&gt;{e}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;, false, true],
        &#x2F;&#x2F; Stuff here is errors, yes?
        &#x27;send&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Send error: &lt;em&gt;{e}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;kick&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Could not kick {user} * &lt;em&gt;{e}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;get&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Could not get {p} info for {ns} * &lt;em&gt;{e}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;set&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Could not set {p} * &lt;em&gt;{e}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;kill&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Kill error * &lt;em&gt;{e}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;],
        &#x27;unknown&#x27;: [&#x27;&lt;span class=&quot;servermsg&quot;&gt;** Received unknown packet in {ns} * &lt;em&gt;{packet}&lt;&#x2F;em&gt;&lt;&#x2F;span&gt;&#x27;, true],
    };

};

&#x2F;**
 * Extend the protocol maps.
 * 
 * @method extend_maps
 * @param maps {Object} An object containing packet mappings.
 *&#x2F;
wsc.Protocol.prototype.extend_maps = function( maps ) {

    for( key in maps ) {
        this.maps[key] = maps[key];
    }

};

&#x2F;**
 * Extend the protocol message renderers.
 * 
 * @method extend_messages
 * @param messages {Object} An object containing packet rendering methods.
 *&#x2F;
wsc.Protocol.prototype.extend_messages = function( messages ) {

    for( key in messages ) {
        this.messages[key] = messages[key];
    }

};

&#x2F;**
 * Parse a packet.
 * 
 * @method parse
 * @param packet {Object} Packet object.
 *&#x2F;
wsc.Protocol.prototype.parse = function( packet ) {

    name = this.event( packet );
    
    if( !(name in this.maps) ) {
        console.log(&#x27;unknown: &#x27;,name);
        console.log(this.maps);
        mapping = this.maps.unknown;
        name = &#x27;unknown&#x27;;
    } else {
        mapping = this.maps[name];
    }
    
    var args = { &#x27;name&#x27;: name, &#x27;pkt&#x27;: packet, &#x27;ns&#x27;: null };
    cmd = packet.cmd;
    
    if( this.mapper[cmd] )
        this.mapper[cmd](packet, args, mapping);
    else
        this.map(packet, args, mapping);
    
    return args;

};

&#x2F;**
 * Get the event name of a packet.
 * 
 * @method event
 * @param pkt {Object} Packet object.
 * @return {String} Packet event name.
 *&#x2F;
wsc.Protocol.prototype.event = function( pkt ) {

    var name = pkt[&quot;cmd&quot;];
    var cmds = null;
    for(var index in this.chains) {
        
        cmds = this.chains[index];
        
        if(cmds[0] != name)
            continue;
        
        var sub = pkt.sub[0];
        name = name + &#x27;_&#x27; + sub[&quot;cmd&quot;];
        
        if(cmds.length &gt; 1 &amp;&amp; sub[&quot;param&quot;] != undefined) {
            if(cmds[1] == sub[&quot;cmd&quot;])
                return name + &#x27;_&#x27; + sub[&quot;param&quot;];
        }
    
    }
    
    return name;

};

&#x2F;**
 * Map a packet to an event object.
 * 
 * @method map
 * @param packet {Object} Packet object.
 * @param event {Object} Event data object.
 * @param mapping {Object} Packet mapping data.
 *&#x2F;
wsc.Protocol.prototype.map = function( packet, event, mapping ) {

    for(var i in mapping) {
        if( mapping[i] == null)
            continue;
        
        var key = mapping[i];
        var skey = key;
        var k = &#x27;&#x27;, val = &#x27;&#x27;;
        
        switch(parseInt(i)) {
            &#x2F;&#x2F; e.&lt;map[event][0]&gt; = packet.param
            case 0:
                event[key] = packet[&#x27;param&#x27;];
                break;
            &#x2F;&#x2F; for n in map[event][1]: e.&lt;map[event][1][n]&gt; = packet.arg.&lt;map[event][1][n]&gt;
            case 1:
                if( mapping[1] instanceof Array ) {
                    for( var n in mapping[1] ) {
                        key = mapping[1][n];
                        if( key instanceof Array ) {
                            event[key[1]] = packet[&#x27;arg&#x27;][key[0]];
                            skey = key[1];
                        } else {
                            var k = key[0] == &#x27;*&#x27; ? key.slice(1) : key;
                            event[key] = packet[&#x27;arg&#x27;][k] || &#x27;&#x27;;
                            skey = key;
                        }
                    }
                }
                
                if( typeof mapping[1] == &#x27;string&#x27; ) {
                    &#x2F;&#x2F; Here we want to accept the packet args as they are. All of them.
                    event[key] = packet.arg.slice(0);
                }
                break;
            &#x2F;&#x2F; e.&lt;map[event][2]&gt; = packet.body
            case 2:
                if( key instanceof Array ) {
                    packet.sub[0].sub = packet.sub.slice(1);
                    this.map(packet.sub[0], event, key);
                } else {
                    event[key] = packet[&#x27;body&#x27;];
                }
                break;
            case 3:
                event[key] = packet.raw;
                break;
        }
        
        if( skey[0] != &#x27;*&#x27; )
            continue;
        
        k = skey.slice(1);
        val = this.mparser.parse( event[skey] );
        event[k] = val;
    }

};

&#x2F;**
 * Render a protocol message in the given format.
 * 
 * @method render
 * @param format {String} Format to render the event in
 * @param event {Object} Event data
 * @return {String} Rendered event
 *&#x2F;
wsc.Protocol.prototype.render = function( event, format ) {

    var msgm = this.messages[event.name];
    
    if( !msgm )
        return &#x27;&#x27;;
    
    var msg = msgm[0];
    var d = &#x27;&#x27;;
    
    for( key in event ) {
        if( !event.hasOwnProperty(key) || key == &#x27;pkt&#x27; )
            continue;
        
        d = event[key];
        
        if( key == &#x27;ns&#x27; || key == &#x27;sns&#x27; ) {
            key = &#x27;ns&#x27;;
            d = event[&#x27;sns&#x27;];
        }
        if( d.hasOwnProperty(&#x27;_parser&#x27;) ) {
            switch(format) {
                case &#x27;text&#x27;:
                    d = d.text();
                    break;
                case &#x27;html&#x27;:
                    d = d.html();
                    break;
                case &#x27;ansi&#x27;:
                    d = d.ansi();
                    break;
                default:
                    d = d.text();
                    break;
            }
        }
        msg = replaceAll(msg, &#x27;{&#x27;+key+&#x27;}&#x27;, d);
    }
    
    return msg;

};

&#x2F;**
 * Produce a log message for an event.
 * @method log
 * @param event {Object} Event data to produce a log message with
 * @return {Object} A log message object on success. Null if failed.
 *&#x2F;
wsc.Protocol.prototype.log = function( event ) {

    var msgm = this.messages[event.name];
    
    if( !msgm )
        return null;
    
    return new wsc.Protocol.LogMessage( event, msgm );

};


&#x2F;**
 * Log message object represents a log message.
 * @class wsc.Protocol.LogMessage
 * @constructor
 * @param event {Object} Event data
 * @param options {Array} Log message options
 *&#x2F;
wsc.Protocol.LogMessage = function( event, options ) {

    this.event = event;
    this.template = options[0] || &#x27;&#x27;;
    this.monitor = options[1] || false;
    this.global = options[2] || false;
    this._html = false;
    this._text = false;
    this._ansi = false;

};

&#x2F;**
 * Get a text rendition.
 * @method text
 * @return {String} Rendered message
 *&#x2F;
wsc.Protocol.LogMessage.prototype.text = function(  ) {

    if( this._text === false )
        this._text = this.render( 0 );
    
    return this._text;

};

&#x2F;**
 * Get an HTML rendition.
 * @method html
 * @return {String} Rendered message
 *&#x2F;
wsc.Protocol.LogMessage.prototype.html = function(  ) {

    if( this._html === false )
        this._html = this.render( 1 );
    
    return this._html;

};

&#x2F;**
 * Get an ANSI rendition.
 * @method ansi
 * @return {String} Rendered message
 *&#x2F;
wsc.Protocol.LogMessage.prototype.ansi = function(  ) {

    if( this._ansi === false )
        this._ansi = this.render( 2 );
    
    return this._ansi;

};

&#x2F;**
 * Render a log message in the given format.
 * 
 * @method render
 * @param [format=0] {Integer} What rendering format to use. 0 is text, 1 is
 *      html, 2 is ansi.
 * @return {String} Rendered event
 *&#x2F;
wsc.Protocol.LogMessage.prototype.render = function( format ) {
    
    if( format === undefined )
        format = 0;
    
    &#x2F;*
    var render = this.render[ format ];
    
    try {
        return render( this, this.event );
    } catch( err ) {
    *&#x2F;
    
    var render = this.template;
    var d = &#x27;&#x27;;
    
    for( var key in this.event ) {
        if( !this.event.hasOwnProperty(key) || key == &#x27;pkt&#x27; )
            continue;
        
        d = this.event[key];
        
        if( key == &#x27;ns&#x27; || key == &#x27;sns&#x27; ) {
            key = &#x27;ns&#x27;;
            d = this.event[&#x27;sns&#x27;];
        }
        
        if( d.hasOwnProperty(&#x27;_parser&#x27;) ) {
            switch(format) {
                case 1:
                    d = d.html();
                    break;
                case 2:
                    d = d.ansi();
                    break;
                case 0:
                default:
                    d = d.text();
                    break;
            }
        }
        render = replaceAll( render, &#x27;{&#x27; + key + &#x27;}&#x27;, d );
    }
    
    return render;
    
    &#x2F;*
    }
    *&#x2F;

};


    </pre>
</div>

        </div>
    </div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
<script src="/wsc/js/docs.js"></script>
</body>
</html>
