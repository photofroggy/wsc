var Chatterbox={};Chatterbox.VERSION="0.19.95";Chatterbox.STATE="beta";Chatterbox.UI=function(b,a,c,e,d){this.client=b;this.events=d||new EventEmitter();this.mozilla=e;this.umuted=[];this.viewing=true;this.settings={themes:["wsct_dAmn","wsct_dark"],theme:"wsct_dark",monitor:["~Monitor",true],username:"",domain:"website.com",clock:true,tabclose:true,developer:false,media:"/static/"};var f=this;this.sound={bank:{m:null},add:function(g,h){if(f.sound.hasOwnProperty(g)){return false}f.sound.bank[g]=h;h.load();f.sound[g]=function(){f.sound.play(f.sound.bank[g])};return true},play:function(g){g.pause();g.currentTime=0;g.play()},toggle:function(h){for(var g in f.sound.bank){if(!f.sound.bank.hasOwnProperty(g)){continue}f.sound.bank[g].muted=h}},mute:function(){f.sound.toggle(true)},unmute:function(){f.sound.toggle(false)},};a.extend(this.settings,c);a.append('<div class="wsc '+this.settings.theme+'"></div>');this.mw=new wsc.Middleware();this.view=a.find(".wsc");this.mns=this.format_ns(this.settings.monitor[0]);
this.lun=this.settings.username.toLowerCase();this.monitoro=null;this.swidth=(function(){if($.browser.msie){var j=$('<textarea cols="10" rows="2"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body"),h=$('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body");scrollbarWidth=j.width()-h.width();j.add(h).remove()}else{var g=$("<div />").css({width:100,height:100,overflow:"auto",position:"absolute",top:-1000,left:-1000}).prependTo("body").append("<div />").find("div").css({width:"100%",height:200});scrollbarWidth=100-g.width();g.parent().remove()}return scrollbarWidth})();this.LIB="Chatterbox";this.VERSION=Chatterbox.VERSION;this.STATE=Chatterbox.STATE};wsc.defaults.UI=Chatterbox.UI;Chatterbox.UI.prototype.trigger=function(a,b){this.events.emit(a,b,this)};Chatterbox.UI.prototype.on=function(b,a){this.events.addListener(b,a)};Chatterbox.UI.prototype.middle=function(a,b){return this.mw.add(a,b)
};Chatterbox.UI.prototype.cascade=function(a,c,b){this.mw.run(a,c,b)};Chatterbox.UI.prototype.remove_listeners=function(){this.events.removeListeners()};Chatterbox.UI.prototype.deform_ns=function(b){var a=b[0];if(a=="#"||a=="@"||a=="~"||a=="+"){return b}if(b.indexOf("chat:")==0){return"#"+b.slice(5)}if(b.indexOf("server:")==0){return"~"+b.slice(7)}if(b.indexOf("feed:")==0){return"#"+b.slice(5)}if(b.indexOf("login:")==0){return"@"+b.slice(6)}if(b.indexOf("pchat:")==0){var c=b.split(":");c.shift();for(i in c){name=c[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}return"#"+b};Chatterbox.UI.prototype.format_ns=function(a){var c=a.slice(1);switch(a[0]){case"@":var b=[c,this.lun];b.sort(caseInsensitiveSort);b.unshift("pchat");a=b.join(":");break;case"~":a="server:"+c;break;case"+":a="feed:"+c;break;case"#":a="chat:"+c;break;default:if(a.indexOf("chat:")==0||a.indexOf("pchat:")==0||a.indexOf("server:")==0||a.indexOf("feed:")==0){break}a="chat:"+c;break}return a};Chatterbox.UI.prototype.set_events=function(a){this.events=a||this.events
};Chatterbox.UI.prototype.clock=function(a){if(a===undefined||a==this.settings.clock){return this.settings.clock}this.settings.clock=a;this.chatbook.retime();return this.settings.clock};Chatterbox.UI.prototype.build=function(f,a,b){this.view.append(Chatterbox.render("ui",this.settings));this.control=new (f||Chatterbox.Control)(this);this.nav=new (a||Chatterbox.Navigation)(this);this.chatbook=new (b||Chatterbox.Chatbook)(this);this.pager=new Chatterbox.Pager(this);this.monitoro=this.chatbook.create_channel(this.mns,this.settings.monitor[1],true);this.monitoro.show();this.control.focus();this.sound.bank.m=this.view.find("div.soundbank");this.sound.add("click",this.sound.bank.m.find("audio.click")[0]);var d=false;var c=this.nav.add_button({label:"",icon:"volume",href:"#mute",title:"Mute the client",handler:function(){if(!d){sound.mute();c.removeClass("volume");c.addClass("volume_mute");c.prop("title","Unmute the client");d=true;return false}sound.unmute();c.removeClass("volume_mute");c.addClass("volume");
c.prop("title","Mute the client");d=false;return false}});var e=this;$(window).focus(function(){e.viewing=true});$(window).blur(function(){e.viewing=false});this.client.bind("pkt",function(h,g){e.packet(h,g)});this.client.middle("ns.remove",function(h,g){e.remove_channel(h.ns);g(h)});this.client.bind("ns.create",function(h,g){e.create_channel(h.chan.raw,h.chan.hidden)});this.client.bind("ns.user.list",function(g){e.channel(g.ns).set_user_list(g.users)});this.client.middle("ns.user.privchg",function(h,g){e.channel(h.ns).privchg(h,g)});this.client.bind("ns.user.remove",function(h,g){e.channel(h.ns).remove_one_user(h.user)});this.client.bind("ns.user.registered",function(g){e.channel(g.ns).register_user(g.user)})};Chatterbox.UI.prototype.resize=function(){this.control.resize();this.view.height(this.view.parent().height());this.nav.resize();this.chatbook.resize(((this.view.parent().height()-this.nav.height())-this.control.height())-5)};Chatterbox.UI.prototype.loop=function(){this.chatbook.loop()
};Chatterbox.UI.prototype.packet=function(b,a){var c=this;var d=a.protocol.log(b);if(d){if(this.settings.developer){console.log(">>>",b.sns,"|",d.text())}if(b.hasOwnProperty("s")&&b.s=="0"){this.chatbook.handle(b,a);return}b.html=d.html();this.cascade("log_message",function(f,e){c.chatbook.log_message(f.message,f.event)},{message:d,event:b})}this.chatbook.handle(b,a)};Chatterbox.UI.prototype.create_channel=function(b,a){this.chatbook.create_channel(b,a)};Chatterbox.UI.prototype.remove_channel=function(a){this.chatbook.remove_channel(a)};Chatterbox.UI.prototype.toggle_channel=function(a){return this.chatbook.toggle_channel(a)};Chatterbox.UI.prototype.channel=function(a,b){return this.chatbook.channel(a,b)};Chatterbox.UI.prototype.channels=function(){return this.chatbook.channels()};Chatterbox.UI.prototype.channel_left=function(){this.chatbook.channel_left()};Chatterbox.UI.prototype.channel_right=function(){this.chatbook.channel_right()};Chatterbox.UI.prototype.monitor=function(b,a){this.monitoro.server_message(b,a)
};Chatterbox.UI.prototype.server_message=function(b,a){this.chatbook.server_message(b,a)};Chatterbox.UI.prototype.log_item=function(a){this.chatbook.log_item(a)};Chatterbox.UI.prototype.log=function(a){this.chatbook.log(a)};Chatterbox.UI.prototype.mute_user=function(a){if(!a){return false}a=a.toLowerCase();if(this.umuted.indexOf(a)!=-1){return false}this.umuted.push(a);this.chatbook.each(function(b,c){c.mute_user(a)});return true};Chatterbox.UI.prototype.unmute_user=function(a){if(!a){return false}a=a.toLowerCase();var b=this.umuted.indexOf(a);if(b==-1){return false}this.umuted.splice(b,1);this.chatbook.each(function(c,d){d.unmute_user(a)});return true};Chatterbox.UI.prototype.clear_user=function(a){this.chatbook.each(function(b,c){c.clear_user(a)})};Chatterbox.UI.prototype.theme=function(a){if(this.settings.theme==a){return this.settings.theme}if(this.settings.themes.indexOf(a)==-1){a="wsct_"+a;if(this.settings.themes.indexOf(a)==-1){return this.settings.theme}}this.view.removeClass(this.settings.theme).addClass(a);
this.settings.theme=a;this.trigger("theme.set",{name:"theme.set",theme:a});return this.settings.theme};Chatterbox.UI.prototype.add_theme=function(a){if(this.settings.themes.indexOf(a)>-1){return}this.settings.themes.push(a)};Chatterbox.UI.prototype.developer=function(a){this.settings.developer=a;this.chatbook.developer()};Chatterbox.BaseTab=function(d,b,c,a){this.manager=d;this.hidden=c;this.monitor=(a==undefined?false:a);this.built=false;this.raw=b;this.selector="t-"+(b||"chan").toLowerCase();this.namespace=b;this.visible=false;this.st=0;this.el={t:{o:null,l:null,c:null,},m:null,l:{p:null,w:null,},u:null,h:{title:null,topic:null}};this.mulw=0;this.d={u:[0,0],h:{title:[0,0],topic:[0,0]}};if(!d){return}this.raw=d.format_ns(b);this.selector=(this.raw.substr(0,2)=="pc"?"pc":"c")+"-"+d.deform_ns(b).slice(1).toLowerCase();this.namespace=d.deform_ns(b)};Chatterbox.BaseTab.prototype.build=function(b){if(!this.manager){return}if(this.built){return}var a=this.selector;var d=this.namespace;var c=this.raw;
this.el.t.o=this.manager.nav.add_tab(a,d);this.el.t.l=this.el.t.o.find(".tab");this.el.t.c=this.el.t.o.find(".close");this.manager.chatbook.view.append(b||Chatterbox.render("basetab",{selector:a,ns:d}));this.el.m=this.window=this.manager.chatbook.view.find("#"+a+"-window");var e=this;this.el.t.l.click(function(){e.manager.toggle_channel(c);return false});this.el.t.c.click(function(f){e.manager.trigger("tab.close.clicked",{ns:e.raw,chan:e,e:f});return false});if(this.hidden&&!this.manager.settings.developer){this.el.t.o.toggleClass("hidden")}this.built=true};Chatterbox.BaseTab.prototype.hide=function(){this.el.m.css({display:"none"});this.el.t.o.removeClass("active");this.visible=false};Chatterbox.BaseTab.prototype.show=function(){this.visible=true;this.el.m.css({display:"block"});this.el.t.o.addClass("active");this.el.t.o.removeClass("noise chatting tabbed fill");var a=this;setTimeout(function(){a.el.l.w.scrollTop(a.el.l.w.prop("scrollHeight")-a.el.l.w.innerHeight());a.resize();a.el.l.w.scrollTop(a.el.l.w.prop("scrollHeight")-a.el.l.w.innerHeight())
},100)};Chatterbox.BaseTab.prototype.developer=function(){if(this.manager.settings.developer){this.el.t.o.removeClass("hidden");return}if(this.hidden){this.el.t.o.addClass("hidden")}};Chatterbox.BaseTab.prototype.remove=function(){this.el.t.o.remove();this.el.m.remove()};Chatterbox.BaseTab.prototype.resize=function(b,a){this.el.m.css({height:a||this.manager.chatbook.height(),width:(b||this.manager.chatbook.width())-10})};Chatterbox.BaseTab.prototype.loop=function(){};Chatterbox.Channel=function(d,b,c,a){Chatterbox.BaseTab.call(this,d,b,c,a)};Chatterbox.Channel.prototype=new Chatterbox.BaseTab;Chatterbox.Channel.prototype.constructor=Chatterbox.Channel;Chatterbox.Channel.prototype.build=function(){if(!this.manager){return}if(this.built){return}var a=this.selector;var c=this.namespace;var b=this.raw;Chatterbox.BaseTab.prototype.build.call(this,Chatterbox.render("channel",{selector:a,ns:c}));this.el.l.p=this.el.m.find("#"+a+"-log");this.el.l.w=this.el.l.p.find("ul.logwrap");this.el.u=this.el.m.find("#"+a+"-users");
this.mulw=parseInt(this.el.u.css("max-width").slice(0,-2));var d=this;var e=false;this.el.l.w.click(function(){if(!e){return}d.manager.control.focus()});this.el.l.w.mousedown(function(){e=true});this.el.l.w.mousemove(function(){e=false});this.el.t.l.click(function(){d.manager.toggle_channel(b);return false});this.setup_header("title");this.setup_header("topic");if(this.namespace[0]=="@"){this.build_user_list({100:"Room Members"},[100])}this.built=true};Chatterbox.Channel.prototype.setup_header=function(a){var c=this;var b={};b.m=this.el.m.find("header."+a+" div");b.e=this.el.m.find("header."+a+" a[href=#edit]");b.t=this.el.m.find("header."+a+" textarea");b.s=this.el.m.find("header."+a+" a[href=#save]");b.c=this.el.m.find("header."+a+" a[href=#cancel]");this.el.h[a]=b.m;b.m.parent().mouseover(function(f){if(!b.editing){b.e.css("display","block");return}b.s.css("display","block");b.c.css("display","block")});b.m.parent().mouseout(function(f){if(!b.editing){b.e.css("display","none");return
}b.s.css("display","none");b.c.css("display","none")});b.e.click(function(f){b.t.text(c.manager.client.channel(c.namespace).info[a].content);b.t.css({display:"block",width:c.el.h[a].innerWidth()-10,});c.el.h[a].css("display","none");b.e.css("display","none");b.editing=true;c.resize();return false});var d=function(){var e=b.t.val();b.t.text("");b.t.css("display","none");c.el.h[a].css("display","block");b.s.css("display","none");b.c.css("display","none");b.editing=false;c.resize();return e};b.s.click(function(f){var g=d();c.manager.trigger(a+".save",{ns:c.raw,value:g});b.t.text("");return false});b.c.click(function(f){d();return false})};Chatterbox.Channel.prototype.scroll=function(){this.pad();var a=this.el.l.w.prop("scrollWidth")-this.el.l.w.innerWidth();var b=this.el.l.w.prop("scrollHeight")-this.el.l.w.innerHeight();if(a>0){b+=a}if(b<0||(b-this.el.l.w.scrollTop())>100){return}this.el.l.w.scrollTop(b)};Chatterbox.Channel.prototype.pad=function(){this.el.l.w.css({"padding-top":0,height:"auto"});
var b=this.el.l.w.innerHeight();var a=this.el.l.p.innerHeight()-this.el.h.topic.parent().outerHeight();var c=a-b;if(c>0){this.el.l.w.css({"padding-top":c})}else{this.el.l.w.css({"padding-top":0,height:a})}this.el.l.w.scrollTop(this.st)};Chatterbox.Channel.prototype.resize=function(f,a){Chatterbox.BaseTab.prototype.resize.call(this,f,a);var g={title:{m:this.el.m.find("header div.title"),e:this.el.m.find("header.title a[href=#edit]")},topic:{m:this.el.m.find("header div.topic"),e:this.el.m.find("header.topic a[href=#edit]")}};this.el.l.w.css({"padding-top":0});a=a||this.manager.chatbook.height();f=f||this.manager.chatbook.width();var c=a;var b=this.el.m.width();this.el.u.width(1);this.d.u[0]=this.el.u[0].scrollWidth+this.manager.swidth+5;if(this.d.u[0]>this.mulw){this.d.u[0]=this.mulw}this.el.u.width(this.d.u[0]);b=b-this.d.u[0];c=c-g.title.m.parent().outerHeight();this.el.l.p.css({height:c-3,width:b-10});this.scroll();this.d.u[1]=this.el.l.p.innerHeight();this.el.u.css({height:this.d.u[1]});
for(var e in g){if(!g.hasOwnProperty(e)){continue}if(g[e].m.html().length==0){continue}var d=(g[e].m.outerHeight(true)-5)*(-1);g[e].e.css("top",d)}};Chatterbox.Channel.prototype.loop=function(){var a=this.el.l.p.find(".logmsg");if(a.length<200){return}a.slice(0,a.length-200).remove();this.resize()};Chatterbox.Channel.prototype.log=function(b){var a=this;this.manager.cascade("log",function(c){a.log_item({html:Chatterbox.render("logmsg",{message:c.message})})},{ns:this.raw,sns:this.namespace,message:b})};Chatterbox.Channel.prototype.log_item=function(c){var a=new Date();var b="";if(this.manager.settings.clock){b=formatTime("{HH}:{mm}:{ss}",a)}else{b=formatTime("{hh}:{mm}:{ss} {mr}",a)}var d=this;this.manager.cascade("log_item",function(e){if(d.visible){d.st=d.el.l.w.scrollTop()}d.el.l.w.append(Chatterbox.render("logitem",e));d.manager.trigger("log_item.after",{item:d.el.l.w.find("li").last(),chan:d});if(d.visible){d.st+=d.el.l.w.find("li.logmsg").last().height();d.el.l.w.scrollTop(d.st)}d.scroll();
d.noise()},{ns:this.namespace,ts:b,ms:a.getTime(),message:c.html,user:(c.user||"system").toLowerCase()})};Chatterbox.Channel.prototype.retime=function(){var a="";var b=this.el.l.w;if(this.manager.settings.clock){a="{HH}:{mm}:{ss}"}else{a="{hh}:{mm}:{ss} {mr}"}b.find("span.ts").each(function(c,d){el=b.find(d);time=new Date(parseInt(el.prop("id")));el.text(formatTime(a,time))})};Chatterbox.Channel.prototype.server_message=function(c,b){var a=this;this.manager.cascade("server_message",function(d){a.log_item({html:Chatterbox.render("servermsg",{message:d.message,info:d.info})})},{ns:this.namespace,message:c,info:b})};Chatterbox.Channel.prototype.clear=function(){this.el.l.p.find("li.logmsg").remove();this.el.l.p.find("li.loginfo").remove();this.el.l.w.height(0);this.resize()};Chatterbox.Channel.prototype.log_info=function(e,d){var g={ns:this.namespace,ref:e,content:d};this.manager.trigger("log_info.before",g);delete g.ns;var a=this.el.l.w.append(Chatterbox.render("loginfobox",g));this.scroll();
var f=this;var c=this.el.l.w.find("li."+g.ref);c.find("a.close").click(function(b){f.el.l.w.find(this).parent().remove();f.resize();return false});this.scroll();return c};Chatterbox.Channel.prototype.log_whois=function(j){var e={avatar:'<a href="#"><img height="50" width="50" alt="avatar"/></a>',username:"<b>"+j.symbol+j.username+"</b>",info:[],conns:[],raw:j,};for(var k in j.connections){var h=j.connections[k];var m=[];if(h.online){var a=(new Date-(h.online*1000));m.push(["online",DateStamp(a/1000)+formatTime(" [{HH}:{mm}:{ss}]",new Date(a))])}if(h.idle){m.push(["idle",timeLengthString(h.idle)])}if(h.agent){m.push(["agent",h.agent])}if(h.debug){m.push(["debug",h.debug])}m.push(["chatrooms",h.channels.join(" ")]);e.conns.push(m)}this.manager.trigger("log_whois.before",e);var b="";for(var k in e.conns){var g=e.conns[k];var o='<section class="conn"><p><em>connection '+((parseInt(k)+1).toString())+":</em></p>";o+="<ul>";for(var n in g){o+="<li><strong>"+g[n][0]+":</strong> "+g[n][1]+"</li>"
}o+="</ul>";b+=o+"</section>"}var f="";for(var k in e.info){f+="<li>"+e.info[k]+"</li>"}var l=this.log_info("whois-"+j.username,Chatterbox.render("whoiswrap",{avatar:e.avatar,info:Chatterbox.render("whoisinfo",{username:e.username,info:f,connections:b})}));var d=l.find("div.avatar");var c=l.find("div.info");c.width(l.find(".whoiswrap").width()-100);d.height(l.height()-10);this.scroll()};Chatterbox.Channel.prototype.log_pc=function(d,e){contents="";for(var c in e){if(!e.hasOwnProperty(c)){continue}var b=e[c];var a="";if(b[2].length==0){a="<em>"+(d?"default privileges":"no members")+"</em>"}else{a=b[2]}contents+=String.format("<li><em>{0}</em> <strong>{1}</strong>:<ul><li>{2}</li></ul></li>",[b[1],b[0],a])}var f={title:"Privilege class "+(d?"permissions":"members"),info:"<ul>"+contents+"</ul>"};this.log_info("pc-"+(d?"permissions":"members"),Chatterbox.render("pcinfo",f))};Chatterbox.Channel.prototype.set_header=function(a,d,f,c){a=a.toLowerCase();var b=this.el.m.find("header."+a+" a[href=#edit]");
if(this.el.h[a].html()!=""){if(d.html().length!=0){this.server_message(a+" set by "+f)}}this.el.h[a].html(d.html());var e=this;setTimeout(function(){if(d.text().length>0){e.el.h[a].css({display:"block"});var g=(e.el.h[a].outerHeight(true)-5)*(-1);b.css("top",g)}else{e.el.h[a].css({display:"none"})}e.resize()},100)};Chatterbox.Channel.prototype.get_header=function(a){return this.el.h[a.toLowerCase()]};Chatterbox.Channel.prototype.build_user_list=function(d,a){var f=this.el.m.find("div.chatusers");var c="";var e=null;f.html("");for(var b in a){var c=d[a[b]];f.append('<div class="pc" id="'+replaceAll(c," ","-")+'"><h3>'+c+"</h3><ul></ul>");e=f.find(".pc#"+c);e.css("display","none")}};Chatterbox.Channel.prototype.reveal_user_list=function(){var f=this.el.m.find("div.chatusers");var d=0;var b=0;var a=null;f.find("div.pc").each(function(c,g){a=f.find(this);b=a.find("ul li").length;d+=b;a.css("display",(b==0?"none":"block"))});f.css("display",(d==0?"none":"block"));var e=this;setTimeout(function(){e.resize()
},100)};Chatterbox.Channel.prototype.set_user_list=function(d){if(Object.size(d)==0){return}var c=this.el.m.find("div.chatusers");var a=null;for(var b in d){a=d[b];this.set_user(a,true)}this.reveal_user_list()};Chatterbox.Channel.prototype.set_user=function(f,d){var h=this.el.m.find("div.chatusers div.pc#"+replaceAll(f.pc," ","-"));var a=h.find("ul");var b=f.conn==1?"":"["+f.conn+"]";var g='<li><a target="_blank" id="'+f.name+'" href="http://'+f.name+"."+this.manager.settings.domain+'"><em>'+f.symbol+"</em>"+f.name+"</a>"+b+"</li>";if(a.find("a#"+f.name).length==1){return}if(a.find("li").length==0){a.append(g)}else{var j=f.name.toLowerCase();var l=null;var e=false;a.find("li a").each(function(){if(e){return}l=a.find(this);if(j<l.prop("id").toLowerCase()){l.parent().before(g);e=true}});if(!e){a.append(g)}}var k=this;this.manager.cascade("user.hover",function(c){k.userinfo(c)},f.hover);d=d||false;if(!(d)){this.reveal_user_list()}};Chatterbox.Channel.prototype.remove_user=function(a,b){this.el.m.find("div.chatusers div.pc ul li a#"+a).parent().remove();
b=b||false;if(!(b)){this.reveal_user_list()}};Chatterbox.Channel.prototype.remove_one_user=function(a){this.remove_user(a,true);var b=this.manager.client.channel(this.namespace).info.members[a];if(!b){this.reveal_user_list();return}this.set_user(b)};Chatterbox.Channel.prototype.privchg=function(b,a){this.remove_user(b.user,true);var c=this.manager.client.channel(this.namespace).info.members[b.user];if(!c){this.reveal_user_list();a(b);return}c=Object.extend(c,{});c.pc=b.pc;this.set_user(c);a(b)};Chatterbox.Channel.prototype.register_user=function(a){this.remove_user(a,true);var b=this.manager.client.channel(this.namespace).info.members[a];if(!b){this.reveal_user_list();return}this.set_user(b)};Chatterbox.Channel.prototype.highlight=function(a){var b=this;this.manager.cascade("highlight",function(g,c){var d=b.el.t.o;var f=g.message;if(f!==false){(f||b.el.l.w.find(".logmsg").last()).addClass("highlight")}if(d.hasClass("active")){if(!b.manager.viewing){b.manager.sound.click()}return}if(!b.hidden){b.manager.sound.click()
}if(d.hasClass("tabbed")){return}if(d.hasClass("chatting")){d.removeClass("chatting")}var h=0;d.addClass("tabbed");function e(){h++;d.toggleClass("fill");if(h==6){return}setTimeout(e,1000)}e()},{c:b,message:a})};Chatterbox.Channel.prototype.noise=function(){var b="";var a=0;var d=this.el.m.find(".logmsg").last();for(var c in this.manager.umuted){if(!this.manager.umuted.hasOwnProperty(c)){continue}if(d.hasClass("u-"+this.manager.umuted[c])){d.css({display:"none"});this.scroll();return}}if(!this.el.t.o.hasClass("active")){this.el.t.o.addClass("noise");if(!this.el.t.o.hasClass("tabbed")){if(d.find(".cevent").length==0){this.el.t.o.addClass("chatting")}}}};Chatterbox.Channel.prototype.userinfo=function(b){var e=this.el.m.find("a#"+b.name);if(e.length==0){return}var f=this;var d=null;var a=function(h){var g="";for(index in b.info){g+="<li>"+b.info[index]+"</li>"}f.window.append(Chatterbox.render("userinfo",{username:b.name,avatar:b.avatar,link:b.link,info:g}));d=f.window.find(".userinfo#"+b.name);
f.window.find("div.userinfo:not('#"+b.name+"')").remove();var j=e.offset();d.css({top:(j.top-e.height())+10,left:(j.left-(d.width()))-6});d.find(".info").height(d.height());d.hover(function(){d.data("hover",1)},function(k){d.data("hover",0);f.unhover_user(d,k)});d.data("hover",0)};var c=function(g){e.data("hover",0);f.unhover_user(d,g)};e.off("mouseenter",a);e.off("mouseleave",c);e.on("mouseenter",a);e.on("mouseleave",c)};Chatterbox.Channel.prototype.unhover_user=function(d,c){var e=d.offset();var b=d.outerHeight(true)+e.top;var g=d.outerWidth(true)+e.left;var a=c.pageX;var f=c.pageY;if(a>e.left&&a<g&&f>e.top&&f<b){return}if(a<(g+15)&&a>e.left&&f>e.top&&f<(e.top+15)){return}d.remove()};Chatterbox.Channel.prototype.mute_user=function(a){if(!a){return}this.el.l.w.find("li.logmsg.u-"+a.toLowerCase()).css({display:"none"});this.scroll()};Chatterbox.Channel.prototype.unmute_user=function(a){if(!a){return}this.el.l.w.find("li.logmsg.u-"+a.toLowerCase()).css({display:"list-item"});this.scroll()
};Chatterbox.Channel.prototype.clear_user=function(a){if(!a){return}this.el.l.w.find("li.logmsg.u-"+a.toLowerCase()).remove();this.scroll()};Chatterbox.Channel.prototype.pkt_join=function(b,a){if(b.e!="ok"){return}this.set_header("title",(new wsc.MessageString("")),"","");this.set_header("topic",(new wsc.MessageString("")),"","")};Chatterbox.Channel.prototype.pkt_recv_msg=function(b,a){var d=this;this.manager.cascade("chan.recv_msg",function(g,c){var f=d.manager.client.settings.username.toLowerCase();if(f==g.user.toLowerCase()){return}var j=g.message.toLowerCase();var h=j.indexOf(f)!=-1;if(!h&&g.sns[0]!="@"){return}if(h){d.highlight()}else{d.highlight(false)}d.trigger("pkt.recv_msg.highlighted",g)},b)};Chatterbox.Channel.prototype.pkt_property=function(b,a){var e=b.pkt.arg.p;var d=a.channel(this.namespace);switch(e){case"title":case"topic":this.set_header(e,b.value||(new wsc.MessageString("")),b.by,b.ts);break;case"privclasses":this.build_user_list(d.info.pc,d.info.pc_order.slice(0));break;
case"members":break;default:break}};Chatterbox.Chatbook=function(a){this.manager=a;this.view=this.manager.view.find("div.chatbook");this.chan={};this.trail=[];this.current=null;this.manager.on("tab.close.clicked",function(b,c){c.chatbook.remove_channel(b.ns)})};Chatterbox.Chatbook.prototype.height=function(){return this.view.height()};Chatterbox.Chatbook.prototype.width=function(){return this.view.width()};Chatterbox.Chatbook.prototype.resize=function(b){b=b||600;var c=this.view.innerWidth();for(var a in this.chan){if(!this.chan.hasOwnProperty(a)){continue}var d=this.chan[a];d.resize(c,b)}};Chatterbox.Chatbook.prototype.loop=function(){for(select in this.chan){this.chan[select].loop()}};Chatterbox.Chatbook.prototype.channel=function(a,b){a=this.manager.format_ns(a).toLowerCase();if(!this.chan[a]&&b){this.chan[a]=b}return this.chan[a]};Chatterbox.Chatbook.prototype.channels=function(){chans=-1;for(ns in this.chan){if(this.chan[ns].hidden){continue}chans++}return chans};Chatterbox.Chatbook.prototype.create_channel=function(b,c,a){var d=this.channel(b,this.channel_object(b,c,a));
d.build();if(this.trail.indexOf(d.namespace)==-1){this.trail.push(d.namespace)}if(!d.visible){this.toggle_channel(b)}this.manager.resize();return d};Chatterbox.Chatbook.prototype.create_feed=function(c,b,a,e){var d=this.channel(c,this.feed_object(c,b,a,e));d.build();if(this.trail.indexOf(d.namespace)==-1){this.trail.push(d.namespace)}if(!d.visible){this.toggle_channel(c)}this.manager.resize();return d};Chatterbox.Chatbook.prototype.channel_object=function(a){return new Chatterbox.Channel(this.manager,a)};Chatterbox.Chatbook.prototype.feed_object=function(c,b,a,d){return new Chatterbox.Feed(this.manager,c,b,a,d)};Chatterbox.Chatbook.prototype.toggle_channel=function(a){var c=this.channel(a);var b=c;if(!c){return}if(c.hidden){if(this.current&&this.current==c){return}if(!this.manager.settings.developer){c.hide();return}}if(this.current){if(this.current==c){return}this.current.hide();b=this.current}else{if(this.manager.monitoro!==null){this.manager.monitoro.hide()}}c.show();this.manager.control.focus();
this.current=c;this.manager.resize();this.manager.control.cache_input(b,c);this.manager.trigger("channel.selected",{ns:c.raw,chan:c,prev:b});this.manager.client.select_ns(c.raw)};Chatterbox.Chatbook.prototype.remove_channel=function(a){var b=this.channel(a);if(this.channels()==0&&!b.hidden){return}b.remove();delete this.chan[b.raw.toLowerCase()];if(this.current==b){this.channel_left()}var c=this.trail.indexOf(b.namespace);this.trail.splice(c,1)};Chatterbox.Chatbook.prototype.channel_left=function(){var b=this.current.namespace;var a=this.trail.indexOf(b);if(a<0){return}var d=null;while(true){try{d=this.channel(this.trail[--a])}catch(c){a=this.trail.length-1;d=this.channel(this.trail[a])}if(!d.hidden){break}if(this.manager.settings.developer){break}}this.toggle_channel(d.namespace)};Chatterbox.Chatbook.prototype.channel_right=function(){var b=this.current.namespace;var a=this.trail.indexOf(b);if(a==-1){return}var d=null;while(true){try{d=this.channel(this.trail[++a])}catch(c){a=0;d=this.channel(this.trail[0])
}if(!d.hidden){break}if(this.manager.settings.developer){break}}this.toggle_channel(d.namespace)};Chatterbox.Chatbook.prototype.each=function(c){var b=null;for(var a in this.chan){if(!this.chan.hasOwnProperty(a)){continue}b=this.chan[a];if(c(b.namespace,b)===false){break}}};Chatterbox.Chatbook.prototype.server_message=function(b,a){for(ns in this.chan){this.chan[ns].server_message(b,a)}};Chatterbox.Chatbook.prototype.log_item=function(a){for(ns in this.chan){this.chan[ns].log_item(a)}};Chatterbox.Chatbook.prototype.log=function(a){for(ns in this.chan){this.chan[ns].log(a)}};Chatterbox.Chatbook.prototype.log_message=function(c,b){try{if(!c.global){if(!c.monitor){this.channel(b.ns).log_item(b)}else{this.manager.monitoro.log_item(b)}}else{this.log_item(b)}}catch(a){try{this.ui.monitoro.server_message("Failed to log for",b.sns,b.html)}catch(a){console.log(">> Failed to log message for",b.sns,"::");console.log(">>",b.html)}}};Chatterbox.Chatbook.prototype.retime=function(){for(ns in this.chan){this.chan[ns].retime()
}};Chatterbox.Chatbook.prototype.developer=function(){this.each(function(a,b){b.developer()})};Chatterbox.Chatbook.prototype.handle=function(d,b){var e=this.manager;var f=this.channel(d.ns);if(!f){return}var a="pkt_"+d.name;try{f[a](d,b)}catch(c){}};Chatterbox.Control=function(b){this.manager=b;this.manager.view.append(Chatterbox.template.control);this.view=this.manager.view.find("div.chatcontrol");this.ml=false;this.history={};this.tab={hit:false,cache:"",matched:[],index:-1,type:0,prefix:["","/",""],};this.el={form:this.view.find("form.msg"),i:{s:this.view.find("form.msg input.msg"),m:this.view.find("form.msg textarea.msg"),c:null,t:this.view.find("ul.buttons a[href~=#multiline].button")},brow:{m:this.view.find("div.brow"),b:this.view.find("div.brow ul.buttons"),s:this.view.find("div.brow ul.states")}};this.el.i.c=this.el.i.s;var a=this;this.el.i.t.click(function(c){a.multiline(!a.multiline());return false});this.el.i.s.keydown(function(c){return a.keypress(c)});this.el.i.m.keydown(function(c){return a.keypress(c)
});this.el.form.submit(function(c){return a.submit(c)});this.add_button({label:"<b>b</b>",icon:false,href:"#bold",title:"Bold text",handler:function(){a.surroundtext(a.el.i.c[0],"<b>","</b>")}});this.add_button({label:"<i>i</i>",icon:false,href:"#italic",title:"Italic text",handler:function(){a.surroundtext(a.el.i.c[0],"<i>","</i>")}});this.add_button({label:"<u>u</u>",icon:false,href:"#underline",title:"Underline text",handler:function(){a.surroundtext(a.el.i.c[0],"<u>","</u>")}});this.add_button({label:"<sup>sup</sup>",icon:false,href:"#sup",title:"Superscript",handler:function(){a.surroundtext(a.el.i.c[0],"<sup>","</sup>")}});this.add_button({label:"<sub>sub</sub>",icon:false,href:"#sub",title:"Subscript",handler:function(){a.surroundtext(a.el.i.c[0],"<sub>","</sub>")}})};Chatterbox.Control.prototype.surroundtext=function(h,g,b){var f=h.scrollTop;var a=h.value,c=h.selectionStart,d=h.selectionEnd;var j=h.value.substring(c,d);h.value=a.substring(0,c)+g+j+b+a.substring(d);h.selectionStart=c+g.length;
h.selectionEnd=c+g.length+j.length;h.scrollTop=f;h.focus()};Chatterbox.Control.prototype.focus=function(){this.el.i.c.focus()};Chatterbox.Control.prototype.resize=function(){w=this.manager.view.width();this.view.css({width:"100%"});this.el.form.css({width:this.manager.view.width()-20});this.el.i.s.css({width:this.manager.view.width()-100});this.el.i.m.css({width:this.manager.view.width()-90})};Chatterbox.Control.prototype.height=function(){var a=this.view.outerHeight();return a};Chatterbox.Control.prototype.multiline=function(a){if(a==undefined||this.ml==a){return this.ml}this.ml=a;var b=(this.ml?"s":"m");a=(this.ml?"m":"s");this.el.i[b].css("display","none");this.el.i[a].css("display","inline-block");this.el.i.c=this.el.i[a];this.manager.resize();return this.ml};Chatterbox.Control.prototype.add_button=function(a){a=Object.extend({label:"New",icon:false,href:"#button",title:"Button.",handler:function(){}},(a||{}));if(a.icon!==false){a.icon=" iconic "+a.icon}else{a.icon=" text"}this.el.brow.b.append(Chatterbox.render("brow_button",a));
var b=this.el.brow.b.find("a[href="+a.href+"].button");b.click(function(c){a.handler();return false});return b};Chatterbox.Control.prototype.add_state=function(a){a=Object.extend({ref:"state",label:"some state"},(a||{}));var b=this.el.brow.s.find("li#"+a.ref);if(b.length==0){this.el.brow.s.append(Chatterbox.render("brow_state",a));return this.el.brow.s.find("li#"+a.ref)}b.html(a.label);return b};Chatterbox.Control.prototype.rem_state=function(a){return this.el.brow.s.find("li#"+a).remove()};Chatterbox.Control.prototype.chomp=function(){var c=this.el.i.c.val();var b=c.lastIndexOf(" ");if(b==-1){this.el.i.c.val("");return c}var a=c.slice(b+1);this.el.i.c.val(c.slice(0,b));if(a.length==0){return this.chomp()}return a};Chatterbox.Control.prototype.unchomp=function(a){var b=this.el.i.c.val();if(!b){this.el.i.c.val(a)}else{this.el.i.c.val(b+" "+a)}};Chatterbox.Control.prototype.get_text=function(a){if(a==undefined){return this.el.i.c.val()}this.el.i.c.val(a||"");return this.el.i.c.val()};Chatterbox.Control.prototype.set_text=function(a){this.el.i.c.val(a||"")
};Chatterbox.Control.prototype.cache_input=function(b,c){var a=this.get_history(b.namespace);if(a.index>-1){return}a.tmp=this.get_text();this.set_text(this.get_history(c.namespace).tmp)};Chatterbox.Control.prototype.get_history=function(a){if(!a){if(!this.manager.chatbook.current){a="~monitor"}}a=a||this.manager.chatbook.current.namespace;if(!this.history[a]){this.history[a]={index:-1,list:[],tmp:""}}return this.history[a]};Chatterbox.Control.prototype.append_history=function(b){if(!b){return}var a=this.get_history();a.list.unshift(b);a.index=-1;if(a.list.length>100){a.list.pop()}};Chatterbox.Control.prototype.scroll_history=function(a){var c=this.get_history();var b=this.get_text();if(c.index==-1){if(b){c.tmp=b}else{c.list[c.index]=b}}if(a){if(c.list.length>0&&c.index<(c.list.length-1)){c.index++}}else{if(c.index>-1){c.index--}}this.set_text(c.list[c.index]||c.tmp)};Chatterbox.Control.prototype.tab_item=function(b){if(!this.tab.hit){this.start_tab(b)}this.chomp();this.tab.index++;if(this.tab.index>=this.tab.matched.length){this.tab.index=-1
}if(this.tab.index==-1){this.unchomp(this.tab.prefix[this.tab.type]+this.tab.cache);return}var a=this.get_text()==""?(this.tab.type==0?": ":" "):"";this.unchomp(this.tab.prefix[this.tab.type]+this.tab.matched[this.tab.index]+a)};Chatterbox.Control.prototype.start_tab=function(d){this.tab.hit=true;this.tab.index=-1;this.tab.matched=[];this.tab.type=0;var g=this.chomp();this.unchomp(g);if(g[0]=="/"||g[0]=="#"||g[0]=="@"){this.tab.type=g[0]=="/"?1:2;if(g[0]=="/"){g=g.slice(1)}}else{this.tab.type=0}this.tab.cache=g;g=g.toLowerCase();this.tab.matched=[];if(this.tab.type==0){var h=this.manager.client.channel(this.manager.chatbook.current.namespace);for(var a in h.info.members){if(a.toLowerCase().indexOf(g)==0){this.tab.matched.push(a)}}}else{if(this.tab.type==1){var f="";for(var b in this.manager.client.cmds){f=this.manager.client.cmds[b];if(f.indexOf(g)==0){this.tab.matched.push(f)}}}else{if(this.tab.type==2){var e=this;this.manager.client.each_channel(function(c,j){if(j.namespace.toLowerCase().indexOf(g)==0){e.tab.matched.push(j.namespace)
}})}}}};Chatterbox.Control.prototype.end_tab=function(a){this.tab.hit=false;this.tab.matched=[];this.tab.cache="";this.tab.index=-1};Chatterbox.Control.prototype.submit=function(a){var b=this.get_text();this.append_history(b);this.set_text("");this.handle(a,b);return false};Chatterbox.Control.prototype.keypress=function(c){var b=c.which||c.keyCode;var d=this.tab.hit;var a=false;switch(b){case 13:if(!this.multiline()){this.submit(c)}else{if(c.shiftKey){this.submit(c)}else{a=true}}break;case 38:if(!this.multiline()){this.scroll_history(true);break}a=true;break;case 40:if(!this.multiline()){this.scroll_history(false);break}a=true;break;case 9:if(c.shiftKey){this.manager.channel_right()}else{this.tab_item(c);d=false}break;case 219:if(c.ctrlKey){this.manager.channel_left()}else{a=true}break;case 221:if(c.ctrlKey){this.manager.channel_right()}else{a=true}break;default:a=true;break}if(d){this.end_tab(c)}return a};Chatterbox.Control.prototype.handle=function(b,e){if(e==""){return}if(!this.manager.chatbook.current){return
}var h=false;if(e[0]!="/"){h=true}e=(b.shiftKey?"/npmsg ":(e[0]=="/"?"":"/say "))+e;e=e.slice(1);var j=e.split(" ");var c=j.shift().toLowerCase();var g=this.manager.chatbook.current.namespace;var f=g;if(!h&&j[0]){var d=j[0][0];if((d=="#"||d=="@")&&j[0].length>1){f=this.manager.format_ns(j.shift())}}var k=j.join(" ");var a=this.manager.client.trigger("cmd."+c,{name:"cmd",cmd:c,args:k,target:f,ns:g});if(a==0){this.manager.pager.notice({ref:"cmd-fail",heading:"Command failed",content:'"'+c+'" is not a command.'},false,5000)}};Chatterbox.Feed=function(d,b,a,c){Chatterbox.BaseTab.call(this,d,b);this.name=this.namespace.substr(1);this.type=a;this.description=c||""};Chatterbox.Feed.prototype=new Chatterbox.BaseTab;Chatterbox.Feed.prototype.constructor=Chatterbox.Feed;Chatterbox.Feed.prototype.build=function(){if(!this.manager){return}if(this.built){return}var a=this.selector;var c=this.namespace;var b=this.raw;Chatterbox.BaseTab.prototype.build.call(this,Chatterbox.render("feed",{selector:a,type:"quiet",name:this.name,info:this.description,}));
this.el.l.p=this.el.m.find("#"+a+"-log");this.el.l.w=this.el.l.p.find("ul.logwrap");this.el.u=this.el.m.find("#"+a+"-users");this.mulw=parseInt(this.el.u.css("max-width").slice(0,-2));this.built=true};Chatterbox.Feed.prototype.resize=function(b,a){Chatterbox.BaseTab.prototype.resize.call(this,b,a)};Chatterbox.Feed.prototype.add_item=function(b){b=Object.extend({ref:"item0001",icon:"",title:"Feed Item 0001",content:"<p>This is a feed item</p>"},b);var c=Chatterbox.render("feedmsg",b);this.el.l.w.prepend(c);var a=this.el.l.w.find("li#"+b.ref);return a};Chatterbox.Navigation=function(a){this.manager=a;this.showclose=this.manager.settings.tabclose;this.settings={};this.settings.open=false;this.el={n:this.manager.view.find("nav.tabs"),tw:this.manager.view.find("nav.tabs div.tabwrap"),t:this.manager.view.find("nav.tabs #chattabs"),b:this.manager.view.find("nav.tabs #tabnav"),l:this.manager.view.find("nav.tabs #tabnav .arrow_left"),r:this.manager.view.find("nav.tabs #tabnav .arrow_right"),s:this.manager.view.find("nav.tabs #tabnav #settings-button"),};
if(!this.showclose){if(!this.el.t.hasClass("hc")){this.el.t.addClass("hc")}}var b=this;this.el.s.click(function(e){if(b.settings.open){return false}var c={e:e,settings:new Chatterbox.Settings.Config(b.manager)};b.configure_page(c);b.manager.trigger("settings.open",c);b.manager.trigger("settings.open.ran",c);var d=c.settings.page("About");d.item("text",{ref:"about-chatterbox",wclass:"centered faint",text:'Using <a href="http://github.com/photofroggy/wsc/">Chatterbox</a> version '+Chatterbox.VERSION+" "+Chatterbox.STATE+' by ~<a href="http://photofroggy.deviantart.com/">photofroggy</a>.'});b.settings.window=new Chatterbox.Settings(b.manager,c.settings);b.settings.window.build();b.settings.open=true;return false});this.el.l.click(function(){b.manager.channel_left();return false});this.el.r.click(function(){b.manager.channel_right();return false})};Chatterbox.Navigation.prototype.configure_page=function(b){var d=this.manager;var c=b.settings.page("Main");var e={};e.theme=replaceAll(d.settings.theme,"wsct_","");
e.clock=d.clock();e.tc=d.nav.closer();var a=[];for(i in d.settings.themes){name=replaceAll(d.settings.themes[i],"wsct_","");a.push({value:name,title:name,selected:e.theme==name})}c.item("Form",{ref:"ui",title:"UI",hint:"<b>Timestamp</b><br/>Choose between a 24 hour clock and                a 12 hour clock.\n\n<b>Theme</b><br/>Change the look of the                client.\n\n<b>Close Buttons</b><br/>Turn tab close buttons on/off.",fields:[["Dropdown",{ref:"theme",label:"Theme",items:a}],["Dropdown",{ref:"clock",label:"Timestamp Format",items:[{value:"24",title:"24 hour",selected:e.clock},{value:"12",title:"12 hour",selected:!e.clock}]}],["Checkbox",{ref:"tabclose",label:"Close Buttons",items:[{value:"yes",title:"On",selected:e.tc}]}],],event:{change:function(f){d.clock(f.data.clock=="24");d.theme(f.data.theme);d.nav.closer(f.data.tabclose.indexOf("yes")>-1)},save:function(f){e.clock=d.clock();e.theme=replaceAll(d.theme(),"wsct_","");e.tc=d.nav.closer();d.trigger("settings.save.ui",{clock:e.clock,tabclose:e.tc,theme:"wsct_"+e.theme})
},close:function(f){d.clock(e.clock);d.theme(e.theme);d.nav.closer(e.tc)}}})};Chatterbox.Navigation.prototype.height=function(){var a=this.el.n.outerHeight();return a};Chatterbox.Navigation.prototype.add_button=function(a){a=Object.extend({label:"New",icon:false,href:"#button",title:"Button.",handler:function(){}},(a||{}));if(a.icon!==false){a.icon=" iconic "+a.icon}else{a.icon=" text"}this.el.b.prepend(Chatterbox.render("nav_button",a));var b=this.el.b.find("a[href="+a.href+"].button");b.click(function(c){a.handler();return false});this.resize();return b};Chatterbox.Navigation.prototype.add_tab=function(a,b){this.el.t.append(Chatterbox.render("tab",{selector:a,ns:b}));return this.el.t.find("#"+a+"-tab")};Chatterbox.Navigation.prototype.resize=function(){this.el.tw.width(this.el.n.width()-this.el.b.outerWidth()-20);if(this.settings.open){this.settings.window.resize()}};Chatterbox.Navigation.prototype.closer=function(a){if(a==undefined||a==this.showclose){return this.showclose}this.showclose=a;
if(this.showclose){if(!this.el.t.hasClass("hc")){return}this.el.t.removeClass("hc");return}if(this.el.t.hasClass("hc")){return}this.el.t.addClass("hc")};Chatterbox.Pager=function(a){this.manager=a;this.lifespan=20000;this.halflife=5000;this.el={m:null,click:null};this.sound={click:function(){},};this.notices=[];this.build()};Chatterbox.Pager.prototype.build=function(){this.el.m=this.manager.view.find("div.pager")};Chatterbox.Pager.prototype.notice=function(d,j,h,c){var f={frame:null,close:null,foot:null,b:{},options:Object.extend({ref:"notice",icon:"",heading:"Some notice",content:"Notice content goes here."},(d||{})),onclose:function(){},ondestroy:function(){}};f.options.ref+="-"+(new Date()).valueOf();f.options.content=f.options.content.split("\n").join("</p><p>");this.notices.push(f);this.el.m.append(Chatterbox.render("pager.notice",f.options));f.frame=this.el.m.find("#"+f.options.ref).last();f.close=f.frame.find("a.close_notice");f.foot=f.frame.find("footer.buttons");var e={};for(var a in f.options.buttons){if(!f.options.buttons.hasOwnProperty(a)){continue
}e=f.options.buttons[a];f.foot.append(Chatterbox.render("pager.button",e));f.b[a]=f.foot.find("a#"+e.ref);f.b[a].click(e.click)}var g=this;f.close.click(function(){f.onclose();g.remove_notice(f);return false});if(!j){if(!h){h=g.lifespan}setTimeout(function(){g.remove_notice(f,true)},h)}if(c!==true){this.manager.sound.click()}return f};Chatterbox.Pager.prototype.remove_notice=function(a,c){var b=this;if(this.notices.indexOf(a)==-1){return false}a.frame.fadeTo((c?this.halflife:300),0).slideUp(function(){a.frame.remove();b.notices.splice(b.notices.indexOf(a),1);a.ondestroy()});if(c){a.frame.mouseenter(function(){if(b.notices.indexOf(a)==-1){return}a.frame.stop(true);a.frame.slideDown(function(){a.frame.fadeTo(300,1);a.frame.mouseleave(function(){setTimeout(function(){b.remove_notice(a,true)},b.lifespan)})})})}};Chatterbox.Pager.prototype.find_notice=function(a){for(var b in this.notices){if(this.notices[b].options.ref==a){return this.notices[b]}}return null};Chatterbox.Popup=function(b,a){this.manager=b;
this.pview=(this.manager||{view:{find:function(){}}}).view;this.window=null;this.closeb=null;this.options=Object.extend({ref:"popup",title:"Popup",close:true,content:""},(a||{}))};Chatterbox.Popup.prototype.build=function(){var b=this.options;if(this.options.close){b.title+='<a href="#close" class="close iconic x"></a>'}this.pview.append(Chatterbox.render("popup",b));this.window=this.pview.find(".floater."+b.ref);if(this.options.close){this.closeb=this.window.find("a.close");var a=this;this.closeb.click(function(c){a.close();return false})}};Chatterbox.Popup.prototype.close=function(){this.window.remove()};Chatterbox.Popup.Prompt=function(b,a){a=a||{};a=Object.extend({position:[0,0],ref:"prompt",title:"Input",close:false,label:"","default":"","submit-button":"Submit",event:{submit:function(){},cancel:function(){}}},a);Chatterbox.Popup.call(this,b,a);this.data=this.options["default"]};Chatterbox.Popup.Prompt.prototype=new Chatterbox.Popup();Chatterbox.Popup.Prompt.prototype.constructor=Chatterbox.Popup.Prompt;
Chatterbox.Popup.Prompt.prototype.build=function(){this.options.content=Chatterbox.template.prompt.main;Chatterbox.Popup.prototype.build.call(this);this.window.css({left:this.options.position[0],top:this.options.position[1]});var a=this;this.window.find(".button.close").click(function(){a.options.event.cancel(a);a.close();return false});this.window.find(".button.submit").click(function(){a.data=a.window.find("input").val();a.options.event.submit(a);a.close();return false});this.window.find("form").submit(function(){a.data=a.window.find("input").val();a.options.event.submit(a);a.close();return false})};Chatterbox.Popup.ItemPicker=function(b,a){a=a||{};a=Object.extend({position:[100,60],ref:"item-picker",title:"Items",event:{select:function(c){}}},a);Chatterbox.Popup.call(this,b,a);this.pview=this.pview.find(".chatbook");this.data=this.options["default"];this.pages=[];this.cpage=null};Chatterbox.Popup.ItemPicker.prototype=new Chatterbox.Popup();Chatterbox.Popup.ItemPicker.prototype.constructor=Chatterbox.Popup.ItemPicker;
Chatterbox.Popup.ItemPicker.prototype.build=function(){this.options.content=Chatterbox.render("ip.main",{});Chatterbox.Popup.prototype.build.call(this);this.window.css({right:this.options.position[0],bottom:this.options.position[1]});this.closeb.removeClass("medium");this.pbook=this.window.find("section.pages");this.tabs=this.window.find("section.tabs ul");this.buttons=this.window.find("section.buttons");var c=this;var b=null;for(var a in this.pages){if(!this.pages.hasOwnProperty(a)){continue}b=this.pages[a];b.build();if(a==0){this.select_page(b)}}};Chatterbox.Popup.ItemPicker.prototype.refresh=function(){if(this.cpage==null){return}else{this.cpage.refresh()}};Chatterbox.Popup.ItemPicker.prototype.page=function(b,a){b=b.toLowerCase();for(var c in this.pages){if(!this.pages.hasOwnProperty(c)){continue}if(this.pages[c].name.toLowerCase()==b){return this.pages[c]}}return(a||null)};Chatterbox.Popup.ItemPicker.prototype.add_page=function(a,b){this.pages.push(new (b||Chatterbox.Popup.ItemPicker.Page)(this,a))
};Chatterbox.Popup.ItemPicker.prototype.add_button=function(a){a=Object.extend({href:"#button",title:"Button",label:"Button"},(a||{}));this.buttons.append(Chatterbox.render("ip.button",a));return this.buttons.find("a[href="+a.href+"]")};Chatterbox.Popup.ItemPicker.prototype.select=function(a){this.options.event.select(a)};Chatterbox.Popup.ItemPicker.prototype.select_page=function(a){if(!a){return}if(this.cpage!=null){this.cpage.hide()}this.cpage=a||null;if(this.cpage!=null){this.cpage.show()}};Chatterbox.Popup.ItemPicker.Page=function(b,a){this.picker=b;this.options=Object.extend({ref:"page",href:"#page",label:"Page",title:"page",items:[],content:"<em>No items on this page.</em>",},(a||{}));this.name=this.options.label;this.nrefresh=true};Chatterbox.Popup.ItemPicker.Page.prototype.build=function(){this.picker.pbook.append(Chatterbox.render("ip.page",this.options));this.picker.tabs.append(Chatterbox.render("ip.tab",this.options));this.view=this.picker.pbook.find("div.page#"+this.options.ref);
this.items=this.view.find("ul");this.tab=this.picker.tabs.find("#"+this.options.ref);this.refresh();var a=this;this.tab.find("a").click(function(){a.picker.select_page(a);return false})};Chatterbox.Popup.ItemPicker.Page.prototype.refresh=function(){var a=this.build_list();if(a.length==0){this.options.content="<em>No items on this page.</em>"}else{this.options.content="<ul>"+a+"</ul>"}this.view.html(this.options.content);this.items=this.view.find("ul");this.hook_events();this.nrefresh=false};Chatterbox.Popup.ItemPicker.Page.prototype.hook_events=function(){var a=this;this.items.find("li").each(function(b,d){var e=a.view.find(d);var c=e.find(".value").html();e.click(function(){a.picker.select(c)})})};Chatterbox.Popup.ItemPicker.Page.prototype.build_list=function(){var c=[];var d=null;var f,e,b;for(var a in this.options.items){if(!this.options.items.hasOwnProperty(a)){continue}d=this.options.items[a];e=d.value||d;f=d.title||e;b=d.html||false;c.push('<li class="item" title="'+f+'">            <span class="hicon"><i class="iconic check"></i></span>            '+(b?e:'<span class="value">'+e+"</span>")+"            </li>")
}return c.join("")};Chatterbox.Popup.ItemPicker.Page.prototype.show=function(){this.tab.addClass("selected");this.view.css("display","block");this.refresh()};Chatterbox.Popup.ItemPicker.Page.prototype.hide=function(){this.tab.removeClass("selected");this.view.css("display","none")};Chatterbox.Settings=function(b,a){Chatterbox.Popup.call(this,b,{ref:"settings",title:"Settings",close:false,content:""});this.config=a;this.saveb=null;this.scb=null;this.tabs=null;this.book=null;this.changed=false;this.manager=b};Chatterbox.Settings.prototype=new Chatterbox.Popup();Chatterbox.Settings.prototype.constructor=Chatterbox.Settings;Chatterbox.Settings.prototype.build=function(){this.options.content=Chatterbox.template.settings.main;Chatterbox.Popup.prototype.build.call(this);this.saveb=this.window.find("a.button.save");this.closeb=this.window.find("a.close");this.scb=this.window.find("a.button.saveclose");this.tabs=this.window.find("nav.tabs ul.tabs");this.book=this.window.find("div.book");this.config.build(this.manager,this);
this.window.find("ul.tabs li").first().addClass("active");this.window.find("div.book div.page").first().addClass("active");var a=this;this.window.find("form").bind("change",function(){a.changed=true});this.config.each_page(function(b,c){c.each_item(function(d,e){e._onchange=function(f){a.changed=true}})});this.saveb.click(function(b){a.save();return false});this.closeb.click(function(b){if(a.changed){if(!confirm("Are you sure? You will lose any unsaved changes.")){return false}}a.close();return false});this.scb.click(function(b){a.save();a.close();return false});this.resize()};Chatterbox.Settings.prototype.resize=function(){var a=this.window.find(".inner");var c=a.find("h2");var d=a.find(".bookwrap");var b=a.find("footer");d.height(a.height()-b.outerHeight()-c.outerHeight()-15);this.book.height(d.innerHeight()-this.tabs.outerHeight()-25);this.book.width(d.innerWidth()-20);this.config.resize()};Chatterbox.Settings.prototype.switch_page=function(b){var c=this.tabs.find("li.active").first();
var a=c.prop("id").split("-",1)[0];c=this.config.page(a.split("_").join(" "));c.hide();b.show()};Chatterbox.Settings.prototype.save=function(){this.config.save(this);this.changed=false;this.manager.trigger("settings.save",{config:this.config})};Chatterbox.Settings.prototype.close=function(){this.window.remove();this.manager.nav.settings.open=false;this.manager.nav.settings.window=null;this.config.close(this);this.manager.trigger("settings.close",{config:this.config})};Chatterbox.Settings.Config=function(a){this.manager=a||null;this.pages=[]};Chatterbox.Settings.Config.prototype.find_page=function(b){var d=b.toLowerCase();var c;for(var a in this.pages){c=this.pages[a];if(c.lname==d){return c}}return null};Chatterbox.Settings.Config.prototype.build=function(c,b){c=c||this.manager;for(var a in this.pages){this.pages[a].build(c,b)}};Chatterbox.Settings.Config.prototype.resize=function(){for(var a in this.pages){this.pages[a].resize()}};Chatterbox.Settings.Config.prototype.page=function(b,a){var c=this.find_page(b);
a=a||true;if(c==null){c=new Chatterbox.Settings.Page(b,this.manager);if(a){this.pages.push(c)}else{this.pages.unshift(c)}}return c};Chatterbox.Settings.Config.prototype.each_page=function(d){var c=null;var a=null;for(var b in this.pages){if(!this.pages.hasOwnProperty(b)){continue}c=this.pages[b];a=d(b,c);if(a===false){break}}};Chatterbox.Settings.Config.prototype.save=function(b){for(var a in this.pages){this.pages[a].save(b)}};Chatterbox.Settings.Config.prototype.close=function(b){for(var a in this.pages){this.pages[a].close(b)}};Chatterbox.Settings.Page=function(a,b){this.name=a;this.lname=a.toLowerCase();this.ref=replaceAll(this.lname," ","_");this.items=[];this.itemo={};this.manager=b};Chatterbox.Settings.Page.prototype.build=function(d,b){var a=replaceAll(Chatterbox.template.settings.tab,"{ref}",this.ref);a=replaceAll(a,"{name}",this.name);var c=replaceAll(Chatterbox.template.settings.page,"{ref}",this.ref);c=replaceAll(c,"{page-name}",this.name);b.tabs.append(a);b.book.append(c);this.view=b.book.find("div#"+this.ref+"-page");
this.tab=b.tabs.find("li#"+this.ref+"-tab");var c=this;this.tab.find("a").click(function(e){if(c.tab.hasClass("active")){return false}b.switch_page(c);return false});this.content()};Chatterbox.Settings.Page.prototype.content=function(){for(var a in this.items){this.items[a].build(this.view)}};Chatterbox.Settings.Page.prototype.resize=function(){for(var a in this.items){this.items[a].resize()}};Chatterbox.Settings.Page.prototype.show=function(){if(!this.tab.hasClass("active")){this.tab.addClass("active")}if(!this.view.hasClass("active")){this.view.addClass("active")}this.resize()};Chatterbox.Settings.Page.prototype.hide=function(){if(this.tab.hasClass("active")){this.tab.removeClass("active")}if(this.view.hasClass("active")){this.view.removeClass("active")}};Chatterbox.Settings.Page.prototype.item=function(c,b,a){a=a||false;var d=Chatterbox.Settings.Item.get(c,b,this.manager);if(a){this.items.unshift(d)}else{this.items.push(d)}if(b.hasOwnProperty("ref")){this.itemo[b.ref]=d}return d};Chatterbox.Settings.Page.prototype.get=function(a){if(this.itemo.hasOwnProperty(a)){return this.itemo[a]
}return null};Chatterbox.Settings.Page.prototype.each_item=function(d){var c=null;var a=null;for(var b in this.items){if(!this.items.hasOwnProperty(b)){continue}c=this.items[b];a=d(b,c);if(a===false){break}}};Chatterbox.Settings.Page.prototype.save=function(b){for(var a in this.items){this.items[a].save(b,this)}};Chatterbox.Settings.Page.prototype.close=function(b){for(var a in this.items){this.items[a].close(b,this)}};Chatterbox.Settings.Item=function(b,a,c){this.manager=c||null;this.options=a||{};this.type=b||"base";this.selector=this.type.toLowerCase();this.items=[];this.itemo={};this.view=null;this.val=null;this._onchange=this._event_stub};Chatterbox.Settings.Item.prototype.build=function(g){if(!this.options.hasOwnProperty("ref")){return}var f=this.content();if(f.length==0){return}var a="";if(this.options.hasOwnProperty("wclass")){a=" "+this.options.wclass}var e=Chatterbox.render("settings.item.wrap",{type:this.type.toLowerCase().split(".").join("-"),ref:this.options.ref,"class":a});
e=replaceAll(e,"{content}",f);g.append(e);this.view=g.find(".item."+this.options.ref);this.hooks(this.view);if(!this.options.hasOwnProperty("subitems")){return}var h;var d;var c;var b;for(i in this.options.subitems){h=this.options.subitems[i];d=h[0];c=h[1];sitem=Chatterbox.Settings.Item.get(d,c);b=["stacked"];if(sitem.options.wclass){b.push(sitem.options.wclass)}sitem.options.wclass=b.join(" ");sitem.build(this.view);this.items.push(sitem);if(c.hasOwnProperty("ref")){this.itemo[c.ref]=sitem}}};Chatterbox.Settings.Item.prototype.content=function(){return Chatterbox.render("settings.item."+this.selector,this.options)};Chatterbox.Settings.Item.prototype.resize=function(){for(var a in this.items){this.items[a].resize()}};Chatterbox.Settings.Item.prototype.hooks=function(c){if(!this.options.hasOwnProperty("event")){return}var b=this.options.event;var e=Chatterbox.template.settings.item.get(this.selector);if(e==false){return}if(!e.hasOwnProperty("events")){return}var d=[];for(var a in e.events){d=e.events[a];
if(!b.hasOwnProperty(d[0])){continue}c.find(d[1]).bind(d[0],b[d[0]])}};Chatterbox.Settings.Item.prototype._event_stub=function(){};Chatterbox.Settings.Item.prototype._get_cb=function(a){if(!this.options.hasOwnProperty("event")){return this._event_stub}return this.options.event[a]||this._event_stub};Chatterbox.Settings.Item.prototype._get_ep=function(b){var d=Chatterbox.template.settings.item.get(this.selector);if(d==null){return false}if(!d.hasOwnProperty("events")){return false}var c=[];for(var a in d.events){c=d.events[a];if(c[0]==b){return c}}};Chatterbox.Settings.Item.prototype.save=function(d,e){var f=this._get_ep("inspect");var b=f?this.view.find(f[1]):null;var a=this._get_cb("save");if(typeof a=="function"){a({input:b,item:this,page:e,window:d})}else{for(var c in a){var g=b.hasOwnProperty("slice")?b.slice(c,1):b;a[c]({input:g,item:this,page:e,window:d})}}for(var c in this.items){this.items[c].save(d,e)}};Chatterbox.Settings.Item.prototype.close=function(d,e){var f=this._get_ep("inspect");
var b=f?this.view.find(f[1]):null;var a=this._get_cb("close");if(typeof a=="function"){a({input:b,item:this,page:e,window:d});return}for(var c in a){var g=b.hasOwnProperty("slice")?b.slice(c,1):b;a[c]({input:g,item:this,page:e,window:d})}for(var c in this.items){this.items[c].close(d,e)}};Chatterbox.Settings.Item.get=function(e,j,f,b,a){var d=e.split(".");var g=b||Chatterbox.Settings.Item;var h;for(var c in d){h=d[c];if(!g.hasOwnProperty(h)){g=a||Chatterbox.Settings.Item;break}g=g[h]}return new g(e,j,f)};Chatterbox.Settings.Item.Form=function(b,a){Chatterbox.Settings.Item.call(this,b,a);this.form=null;this.fields=[];this.lsection=null;this.fsection=null;this.fieldo={}};Chatterbox.Settings.Item.Form.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Form.prototype.constructor=Chatterbox.Settings.Item.Form;Chatterbox.Settings.Item.Form.field=function(b,a){return Chatterbox.Settings.Item.get(b,a,this.manager,Chatterbox.Settings.Item.Form,Chatterbox.Settings.Item.Form.Field)};
Chatterbox.Settings.Item.Form.prototype.build=function(d){Chatterbox.Settings.Item.prototype.build.call(this,d);if(this.view==null){return}this.lsection=this.view.find("section.labels");this.fsection=this.view.find("section.fields");if(!this.options.hasOwnProperty("fields")){return}var c;var e;for(var a in this.options.fields){c=this.options.fields[a];e=Chatterbox.Settings.Item.Form.field(c[0],c[1]);this.fields.push(e);e.build(this);if(c[1].hasOwnProperty("ref")){this.fieldo[c[1].ref]=e}}this.form=this.view.find("form");var b=this;this.form.bind("change",function(f){b.change()})};Chatterbox.Settings.Item.Form.prototype.resize=function(){for(var a in this.fields){this.fields[a].resize()}};Chatterbox.Settings.Item.Form.prototype.change=function(){var c={};var d;for(var b in this.fields){d=this.fields[b];c[d.ref]=d.get()}var a=this._get_cb("change");if(typeof a=="function"){a({data:c,form:this})}else{for(var b in a){a[b]({data:c,form:this})}}};Chatterbox.Settings.Item.Form.prototype.save=function(d,f){var e={};
var b;for(var c in this.fields){field=this.fields[c];e[field.ref]=field.get()}var a=this._get_cb("save");if(typeof a=="function"){a({data:e,form:this,page:f,window:d})}else{for(var c in a){a[c]({data:e,form:this,page:f,window:d})}}};Chatterbox.Settings.Item.Form.prototype.close=function(c,e){var d={};var f;for(var b in this.fields){f=this.fields[b];d[f.ref]=f.get()}var a=this._get_cb("close");if(typeof a=="function"){a({data:d,form:this,page:e,window:c})}else{for(var b in a){a[b]({data:d,form:this,page:e,window:c})}}};Chatterbox.Settings.Item.Form.Field=function(b,a){Chatterbox.Settings.Item.call(this,b,a);this.ref=this.options.ref||"ref";this.label=null;this.field=null;this.value=""};Chatterbox.Settings.Item.Form.Field.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Form.Field.prototype.constructor=Chatterbox.Settings.Item.Form.Field;Chatterbox.Settings.Item.Form.Field.prototype.build=function(a){a.lsection.append(Chatterbox.render("settings.item.form.label",{ref:this.ref,label:this.options.label||"","class":(this.options["class"]?" "+this.options["class"]:"")}));
this.label=a.lsection.find("label."+this.ref);this.lwrap=a.lsection.find("."+this.ref+".label");a.fsection.append(Chatterbox.render("settings.item.form.field.wrap",{ref:this.ref,field:Chatterbox.render("settings.item.form.field."+this.selector,this.options)}));this.fwrap=a.fsection.find("div."+this.ref+".field");this.field=this.fwrap.find("."+this.ref);this.view=this.fwrap;var b=this;this.value=this.field.val();this.field.bind("change",function(c){b.value=b.view.find(this).val()})};Chatterbox.Settings.Item.Form.Field.prototype.resize=function(){this.lwrap.height(this.field.height())};Chatterbox.Settings.Item.Form.Field.prototype.get=function(){return this.value};Chatterbox.Settings.Item.Form.Radio=function(b,a){a=a||{};a["class"]=(a["class"]?(a["class"]+" "):"")+"box";Chatterbox.Settings.Item.Form.Field.call(this,b,a);this.items={};this.value=""};Chatterbox.Settings.Item.Form.Radio.prototype=new Chatterbox.Settings.Item.Form.Field();Chatterbox.Settings.Item.Form.Radio.prototype.constructor=Chatterbox.Settings.Item.Form.Radio;
Chatterbox.Settings.Item.Form.Radio.prototype.build=function(c){c.lsection.append(Chatterbox.render("settings.item.form.label",{ref:this.ref,label:this.options.label||""}));this.label=c.lsection.find("label."+this.ref);this.lwrap=c.lsection.find("."+this.ref+".label");if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.ref;this.items[b.ref]=""}}c.fsection.append(Chatterbox.render("settings.item.form.field.wrap",{ref:this.ref,field:Chatterbox.render("settings.item.form.field.radio",this.options)}));this.fwrap=c.fsection.find("div."+this.ref+".field");this.field=this.fwrap.find("input:radio");this.value=this.fwrap.find("input[checked]:radio").val();var a=this;this.field.bind("change",function(d){a.value=a.fwrap.find(this).val()})};Chatterbox.Settings.Item.Form.Radio.prototype.resize=function(){this.lwrap.height(this.fwrap.find(".radiobox").height())};Chatterbox.Settings.Item.Form.Radio.prototype.get=function(){return this.value};Chatterbox.Settings.Item.Form.Checkbox=function(b,a){Chatterbox.Settings.Item.Form.Radio.call(this,b,a);
this.value=[]};Chatterbox.Settings.Item.Form.Checkbox.prototype=new Chatterbox.Settings.Item.Form.Radio();Chatterbox.Settings.Item.Form.Checkbox.prototype.constructor=Chatterbox.Settings.Item.Form.Checkbox;Chatterbox.Settings.Item.Form.Checkbox.prototype.build=function(c){c.lsection.append(Chatterbox.render("settings.item.form.label",{ref:this.ref,label:this.options.label||""}));this.label=c.lsection.find("label."+this.ref);this.lwrap=c.lsection.find("."+this.ref+".label");if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.ref;this.items[b.ref]=""}}c.fsection.append(Chatterbox.render("settings.item.form.field.wrap",{ref:this.ref,field:Chatterbox.render("settings.item.form.field.checkbox",this.options)}));this.fwrap=c.fsection.find("div."+this.ref+".field");this.field=this.fwrap.find("input:checkbox");var a=this;this.value=[];this.fwrap.find("input[checked]:checkbox").each(function(){a.value.push(a.fwrap.find(this).val())});this.field.bind("change",function(d){a.value=[];
a.fwrap.find("input[checked]:checkbox").each(function(){a.value.push(a.fwrap.find(this).val())})})};Chatterbox.Settings.Item.Form.Checkbox.prototype.resize=function(){this.lwrap.height(this.fwrap.find(".checkbox").height())};Chatterbox.Settings.Item.Form.Colour=function(b,a){Chatterbox.Settings.Item.Form.Field.call(this,b,a)};Chatterbox.Settings.Item.Form.Colour.prototype=new Chatterbox.Settings.Item.Form.Field();Chatterbox.Settings.Item.Form.Colour.prototype.constructor=Chatterbox.Settings.Item.Form.Colour;Chatterbox.Settings.Item.Form.Colour.prototype.build=function(a){Chatterbox.Settings.Item.Form.Field.prototype.build.call(this,a);this.resize()};Chatterbox.Settings.Item.Form.Colour.prototype.resize=function(){this.lwrap.height(this.fwrap.height())};Chatterbox.Settings.Item.Radio=function(b,a){Chatterbox.Settings.Item.call(this,b,a);this.value=""};Chatterbox.Settings.Item.Radio.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Radio.prototype.constructor=Chatterbox.Settings.Item.Radio;
Chatterbox.Settings.Item.Radio.prototype.build=function(c){if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.options.ref||"ref"}}Chatterbox.Settings.Item.prototype.build.call(this,c);this.field=this.view.find("input:radio");this.value=this.view.find("input[checked]:radio").val();var a=this;this.field.bind("change",function(d){a.value=a.view.find(this).val()})};Chatterbox.Settings.Item.Checkbox=function(b,a){Chatterbox.Settings.Item.Radio.call(this,b,a);this.value=[]};Chatterbox.Settings.Item.Checkbox.prototype=new Chatterbox.Settings.Item.Radio();Chatterbox.Settings.Item.Checkbox.prototype.constructor=Chatterbox.Settings.Item.Checkbox;Chatterbox.Settings.Item.Checkbox.prototype.build=function(c){if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.options.ref||"ref"}}Chatterbox.Settings.Item.prototype.build.call(this,c);this.field=this.view.find("input:checkbox");var a=this;
this.value=[];this.view.find("input[checked]:checkbox").each(function(){a.value.push(a.view.find(this).val())});this.field.bind("change",function(d){a.value=[];a.view.find("input[checked]:checkbox").each(function(){a.value.push(a.view.find(this).val())})})};Chatterbox.Settings.Item.Items=function(b,a,c){a=Object.extend({prompt:{title:"Add Item",label:"Item:","submit-button":"Add"}},(a||{}));Chatterbox.Settings.Item.call(this,b,a,c);this.selected=false};Chatterbox.Settings.Item.Items.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Items.prototype.constructor=Chatterbox.Settings.Item.Items;Chatterbox.Settings.Item.Items.prototype.build=function(b){Chatterbox.Settings.Item.prototype.build.call(this,b);var a=this;this.list=this.view.find("ul");this.buttons=this.view.find("section.buttons p");var c=this.list.find("li");c.click(function(e){var d=a.list.find(this);a.list.find("li.selected").removeClass("selected");a.selected=d.find(".item").html();d.addClass("selected")});c.each(function(d,f){var e=a.list.find(f);
e.find("a.close").click(function(g){a.list.find("li.selected").removeClass("selected");a.selected=e.find(".item").html();e.addClass("selected");a.remove_item();return false})});this.buttons.find("a.button.up").click(function(d){a.shift_item(true);return false});this.buttons.find("a.button.down").click(function(d){a.shift_item();return false});this.buttons.find("a.button.add").click(function(d){var e=new Chatterbox.Popup.Prompt(a.manager,{position:[d.clientX-100,d.clientY-50],title:a.options.prompt.title,label:a.options.prompt.label,"submit-button":a.options.prompt["submit-button"],event:{submit:function(f){var h=f.data;if(!h){f.options.event.cancel(f);return}h=h.toLowerCase();var g=a.options.items.indexOf(h);if(g!=-1){f.options.event.cancel(f);return}a._fevent("add",{item:h});a.refresh();a._onchange({})},cancel:function(f){a._fevent("cancel",{});a.refresh();a._onchange({})}}});e.build();return false});this.buttons.find("a.button.close").click(function(d){a.remove_item();return false})};
Chatterbox.Settings.Item.Items.prototype.shift_item=function(b){if(this.selected===false){return}var c=this.options.items.indexOf(this.selected);var a=c+1;if(b){a=c-1}if(c==-1||c>=this.options.items.length){return}if(a<0||a>=this.options.items.length){return}this._fevent((b?"up":"down"),{swap:{"this":{index:c,item:this.options.items[c]},that:{index:a,item:this.options.items[a]}}});this.refresh();this._onchange({});return};Chatterbox.Settings.Item.Items.prototype.remove_item=function(){if(this.selected===false){return false}var a=this.options.items.indexOf(this.selected);if(a==-1||a>=this.options.items.length){return}this._fevent("remove",{index:a,item:this.selected});this.selected=false;this.refresh();this._onchange({})};Chatterbox.Settings.Item.Items.prototype.refresh=function(){this.view.find("section.mitems").html(Chatterbox.template.settings.krender.manageditems(this.options.items));this.list=this.view.find("ul");this.list.find("li[title="+(this.selected||"").toLowerCase()+"]").addClass("selected");
var a=this;var b=this.list.find("li");b.click(function(d){var c=a.list.find(this);a.list.find("li.selected").removeClass("selected");a.selected=c.find(".item").html();c.addClass("selected")});b.each(function(c,e){var d=a.list.find(e);d.find("a.close").click(function(f){a.list.find("li.selected").removeClass("selected");a.selected=d.find(".item").html();d.addClass("selected");a.remove_item();return false})})};Chatterbox.Settings.Item.Items.prototype._fevent=function(b,d){var f=this._get_ep("inspect");var c=f?this.view.find(f[1]):null;var a=this._get_cb(b);if(typeof a=="function"){a({input:c,item:this,args:d})}else{for(var e in a){var g=c.hasOwnProperty("slice")?c.slice(e,1):c;a[e]({input:g,item:this,args:d})}}};Chatterbox.Settings.Item.Items.prototype.save=function(){this._fevent("save",{items:this.options.items||[]})};Chatterbox.template={};Chatterbox.render=function(h,k,a,b){var e=b||Chatterbox.template;var f={};var g=null;var c=null;if(a!==undefined&&a===true){e=h}else{var j=h.split(".");
for(var d in j){c=j[d];if(!e.hasOwnProperty(c)){return""}e=e[c]}}if(e.hasOwnProperty("frame")){g=e;f=e.render||{};e=e.frame;if(g.hasOwnProperty("pre")){if(typeof g.pre=="function"){e=g.pre(e,k)}else{for(i in g.pre){e=g.pre[i](e,k)}}}}for(key in k){e=replaceAll(e,"{"+key+"}",(f[key]||Chatterbox.template.render_stub)(k[key]||""))}if(g!=null){if(g.hasOwnProperty("post")){if(typeof g.post=="function"){e=g.post(e,k)}else{for(i in g.post){e=g.post[i](e,k)}}}}return e};Chatterbox.template.render_stub=function(a){return a};Chatterbox.template.clean=function(a){return function(b,c){for(i in a){b=replaceAll(b,"{"+a[i]+"}","")}return b}};Chatterbox.template.ui='<div class="soundbank">            <audio class="click">                <source src="{media}click.ogg" type="audio/ogg">                <source src="{media}click.mp3" type="audio/mpeg">            </audio>        </div>        <div class="pager">        </div>        <nav class="tabs"><div class="tabwrap"><ul id="chattabs" class="tabs"></ul></div>        <ul id="tabnav">            <li><a href="#left" class="button iconic arrow_left"></a></li>            <li><a href="#right" class="button iconic arrow_right"></a></li>            <li><a href="#settings" title="Change client settings" class="button iconic cog" id="settings-button"></a></li>        </ul>        </nav>        <div class="chatbook"></div>';
Chatterbox.template.control='<div class="chatcontrol">            <div class="brow">                <ul class="buttons">                    <li><a href="#multiline" title="Toggle multiline input" class="button iconic list"></a></li>                </ul>                <ul class="states">                </ul>            </div>            <form class="msg">                <input type="text" class="msg" />                <textarea class="msg"></textarea>                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';Chatterbox.template.brow_button='<li><a href="{href}" title="{title}" class="button{icon}">{label}</a></li>';Chatterbox.template.brow_state='<li id="{ref}">{label}</li>';Chatterbox.template.nav_button='<li><a href="{href}" title="{title}" class="button{icon}">{label}</a></li>';Chatterbox.template.tab='<li id="{selector}-tab"><a href="#{selector}" class="tab">{ns}<a href="#{selector}" class="close iconic x"></a></a></li>';Chatterbox.template.basetab='<div class="chatwindow" id="{selector}-window"></div>';
Chatterbox.template.feed='<div class="chatwindow feed" id="{selector}-window">                    <header class="info">                        <h2>{name}<span class="type">{type} feed</span></h2>                        <p>{info}</p>                        <ul class="control">                            <li><a href="#post" class="button iconic pen" title="Post a message on"></a></li>                            <li><a href="#refresh" class="button iconic spin" title="Get updates"></a></li>                            <li><a href="#close" class="button iconic x" title="Close feed reader"></a></li>                        </ul>                    </header>                    <div class="log" id="{selector}-log">                        <ul class="logwrap"></ul>                    </div>                    <div class="users" id="{selector}-users"></div>                </div>';Chatterbox.template.feedmsg='<li id="{ref}">                                <article>                                    <a href="#close" class="iconic x" title="Remove feed message"></a>                                    <section class="label">{icon}</section>                                    <section class="content">                                        <h3>{title}</h3>                                        {content}                                    </section>                                </article>                            </li>';
Chatterbox.template.channel='<div class="chatwindow" id="{selector}-window">                    <header class="title">                        <div class="title"></div>                        <textarea></textarea>                        <a href="#edit" class="button iconic pen" title="Edit the title"></a>                        <a href="#save" class="button iconic check" title="Save changes"></a>                        <a href="#cancel" class="button iconic x" title="Cancel"></a>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header class="topic">                            <div class="topic"></div>                            <textarea></textarea>                            <a href="#edit" class="button iconic pen" title="Edit the topic"></a>                            <a href="#save" class="button iconic check" title="Save changes"></a>                            <a href="#cancel" class="button iconic x" title="Cancel"></a>                        </header>                        <ul class="logwrap"></ul>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';
Chatterbox.template.header='<div class="{head}">{content}</div>';Chatterbox.template.logmsg='<span class="message">{message}</span>';Chatterbox.template.logitem='<li class="logmsg u-{user}"><span class="ts" id="{ms}">{ts}</span> {message}</li>';Chatterbox.template.servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';Chatterbox.template.usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';Chatterbox.template.userinfo='<div class="userinfo" id="{username}">                            <div class="avatar">                                {avatar}                            </div><div class="info">                            <strong>                            {link}                            </strong>                            <ul>{info}</ul></div>                        </div>';Chatterbox.template.loginfobox='<li class="loginfo {ref}"><a href="#{ref}" class="close iconic x"></a>{content}</li>';Chatterbox.template.whois={};Chatterbox.template.whoiswrap='<div class="whoiswrap">                                <div class="avatar">{avatar}</div>                                <div class="info">{info}</div>                                </div>';
Chatterbox.template.whoisinfo="<p>{username}</p><ul>{info}</ul>{connections}";Chatterbox.template.pcinfo='<section class="pcinfo"><strong>{title}</strong>{info}</section>';Chatterbox.template.popup='<div class="floater {ref}"><div class="inner"><h2>{title}</h2><div class="content">{content}</div></div></div>';Chatterbox.template.ip={};Chatterbox.template.ip.main={};Chatterbox.template.ip.main.frame='<section class="tabs"><ul></ul></section>        <section class="pages"></section>        <section class="buttons"></section>';Chatterbox.template.ip.page={frame:'<div class="page" id="{ref}">{content}</div>'};Chatterbox.template.ip.button={frame:'<a href="{href}" title="{title}" class="button text">{label}</a>'};Chatterbox.template.ip.tab={frame:'<li class="tab" id="{ref}"><a href="{href}" title="{title}">{label}</a></li>'};Chatterbox.template.prompt={};Chatterbox.template.prompt.main='<span class="label">{label}</span>    <span class="input"><form><input type="text" value="{default}" /></form></span>    <span class="buttons">    <a href="#submit" class="button submit">{submit-button}</a>    <a href="#remove" class="button close big square iconic x"></a>    </span>';
Chatterbox.template.pager={notice:{frame:'<div class="notice" id="{ref}">            <a href="#close" class="close_notice iconic x"></a>            <div class="icon">{icon}</div>            <div class="content">                <h3>{heading}</h3>                <p>{content}</p>                <footer class="buttons"></footer>            </div>            </div>'},button:{frame:'<a href="#{target}" title="{title}" id="{ref}" class="button text">{label}</a>'}};Chatterbox.template.settings={};Chatterbox.template.settings.main='<div class="bookwrap">                                <nav class="tabs">                                    <ul class="tabs"></ul>                                </nav>                                <div class="book"></div>                            </div>                            <footer>                                <a href="#save" class="button save">Save</a> <a href="#saveclose" class="button saveclose">Save & Close</a> <a href="#close" class="button close big square iconic x"></a>                            </footer>';
Chatterbox.template.settings.page='<div class="page" id="{ref}-page"></div>';Chatterbox.template.settings.tab='<li id="{ref}-tab"><a href="#{ref}" class="tab" id="{ref}-tab">{name}</a></li>';Chatterbox.template.settings.krender={};Chatterbox.template.settings.krender.title=function(a){if(a.length==0){return""}return"<h3>"+a+"</h3>"};Chatterbox.template.settings.krender.text=function(a){return replaceAll(a,"\n\n","\n</p><p>\n")};Chatterbox.template.settings.krender.dditems=function(a){if(a.length==0){return""}render="";for(i in a){item=a[i];render+='<option value="'+item.value+'"';if(item.selected){render+=' selected="yes"'}render+=">"+item.title+"</option>"}return render};Chatterbox.template.settings.krender.radioitems=function(a){if(a.length==0){return""}render="";labels=[];fields=[];for(i in a){item=a[i];labels.push(Chatterbox.render("settings.item.form.label",{ref:item.value,label:item.title}));ritem='<div class="'+item.value+' field radio"><input class="'+item.value+'" type="radio" name="'+item.name+'" value="'+item.value+'"';
if(item.selected){ritem+=' checked="yes"'}fields.push(ritem+" /></div>")}return'<section class="labels">'+labels.join("")+'</section><section class="fields">'+fields.join("")+"</section>"};Chatterbox.template.settings.krender.checkitems=function(a){if(a.length==0){return""}render="";labels=[];fields=[];for(i in a){item=a[i];if("title" in item){labels.push(Chatterbox.render("settings.item.form.label",{ref:item.value,label:item.title}))}ritem='<div class="'+item.value+' field check"><input class="'+item.value+'" type="checkbox" name="'+item.name+'" value="'+item.value+'"';if(item.selected){ritem+=' checked="yes"'}fields.push(ritem+" /></div>")}if(labels.length>0){render+='<section class="labels">'+labels.join("")+"</section>"}return render+'<section class="fields">'+fields.join("")+"</section>"};Chatterbox.template.settings.krender.manageditems=function(b){if(b.length==0){return"<i>No items in this list</i>"}var d="<ul>";var f=[];var a=[];var e;for(var c in b){if(!b.hasOwnProperty(c)){continue
}e=b[c];d+='<li title="'+e.toLowerCase()+'">                  <span class="remove"><a href="#remove" title="Remove item" class="close iconic x"></a></span>                  <span class="item">'+e+"</span>                  </li>"}return d+"</ul>"};Chatterbox.template.settings.item={};Chatterbox.template.settings.item.get=function(a){var c=a.split(".");var b=Chatterbox.template.settings.item;for(i in c){tc=c[i];if(b.hasOwnProperty(tc)){b=b[tc];continue}return null}return b};Chatterbox.template.settings.item.wrap='<section class="item {type} {ref}{class}">                                    {content}                                </section>';Chatterbox.template.settings.item.hint={};Chatterbox.template.settings.item.hint.frame='<aside class="hint">{hint}</aside>{content}';Chatterbox.template.settings.item.hint.prep=function(a,b){if(!b.hasOwnProperty("hint")){return a}return Chatterbox.render("settings.item.hint",{hint:b.hint,content:a})};Chatterbox.template.settings.item.twopane={};Chatterbox.template.settings.item.twopane.frame='{title}<div class="twopane">                                        <div class="text left">                                            <p>{text}</p>                                        </div>                                        <div class="right">                                            {template}                                        </div>                                    </div>';
Chatterbox.template.settings.item.twopane.wrap=function(a,b){if(!b.hasOwnProperty("text")){return a}a=replaceAll(Chatterbox.template.settings.item.twopane.frame,"{template}",replaceAll(a,"{title}",""));return a};Chatterbox.template.settings.item.text={};Chatterbox.template.settings.item.text.pre=Chatterbox.template.settings.item.hint.prep;Chatterbox.template.settings.item.text.post=Chatterbox.template.clean(["title","text"]);Chatterbox.template.settings.item.text.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.text.frame="{title}<p>                                        {text}                                    </p>";Chatterbox.template.settings.item.dropdown={};Chatterbox.template.settings.item.dropdown.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.dropdown.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.dditems};
Chatterbox.template.settings.item.dropdown.post=Chatterbox.template.clean(["title","items"]);Chatterbox.template.settings.item.dropdown.events=[["change","select"],["inspect","select"]];Chatterbox.template.settings.item.dropdown.frame="{title}<form>                                                <select>                                                    {items}                                                </select>                                            </form>";Chatterbox.template.settings.item.radio={};Chatterbox.template.settings.item.radio.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.radio.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.radioitems};Chatterbox.template.settings.item.radio.post=Chatterbox.template.clean(["ref","title","items"]);Chatterbox.template.settings.item.radio.events=[["change","input:radio"],["inspect","input:radio"]];
Chatterbox.template.settings.item.radio.frame='{title}<div class="{ref} radiobox"><form>{items}</form></div>';Chatterbox.template.settings.item.checkbox={};Chatterbox.template.settings.item.checkbox.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.checkbox.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.checkitems};Chatterbox.template.settings.item.checkbox.post=Chatterbox.template.clean(["ref","title","items"]);Chatterbox.template.settings.item.checkbox.events=[["change","input:checkbox"],["inspect","input:checkbox"]];Chatterbox.template.settings.item.checkbox.frame='{title}<div class="{ref} checkbox"><form>{items}</form></div>';Chatterbox.template.settings.item.textfield={};Chatterbox.template.settings.item.textfield.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];
Chatterbox.template.settings.item.textfield.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.textfield.post=Chatterbox.template.clean(["ref","title","default"]);Chatterbox.template.settings.item.textfield.events=[["blur","input"],["inspect","input"]];Chatterbox.template.settings.item.textfield.frame='{title}<div class="{ref} textfield"><form><input type="text" value="{default}" /></form></div>';Chatterbox.template.settings.item.textarea={};Chatterbox.template.settings.item.textarea.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.textarea.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.textarea.post=Chatterbox.template.clean(["ref","title","default"]);Chatterbox.template.settings.item.textarea.events=[["blur","textarea"],["inspect","textarea"]];
Chatterbox.template.settings.item.textarea.frame='{title}<div class="{ref} textarea"><form><textarea rows="4" cols="20" value="{default}"></textarea></form></div>';Chatterbox.template.settings.item.items={};Chatterbox.template.settings.item.items.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.items.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.manageditems};Chatterbox.template.settings.item.items.post=Chatterbox.template.clean(["ref","title","items"]);Chatterbox.template.settings.item.items.events=[];Chatterbox.template.settings.item.items.frame='{title}<div class="{ref} items">    <section class="buttons"><p><a href="#up" title="Move item up" class="button up iconic arrow_up"></a>    <a href="#down" title="Move item down" class="button down iconic arrow_down"></a>    <a href="#add" title="Add an item" class="button add iconic plus"></a>    <a href="#remove" title="Remove item from list" class="button close big square iconic x"></a>    </p></section>    <section class="mitems">{items}</section>    </div>';
Chatterbox.template.settings.item.colour={};Chatterbox.template.settings.item.colour.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.colour.render={title:Chatterbox.template.settings.krender.title};Chatterbox.template.settings.item.colour.post=Chatterbox.template.clean(["ref","title","default"]);Chatterbox.template.settings.item.colour.events=[["blur","input"],["inspect","input"]];Chatterbox.template.settings.item.colour.frame='{title}<div class="{ref} textfield"><form><input type="color" value="{default}" /></form></div>';Chatterbox.template.settings.item.form={};Chatterbox.template.settings.item.form.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.form.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.dditems};Chatterbox.template.settings.item.form.post=Chatterbox.template.clean(["title","text","items"]);
Chatterbox.template.settings.item.form.frame='{title}<form>                                                <section class="labels"></section>                                                <section class="fields"></section>                                            </form>';Chatterbox.template.settings.item.form.label={};Chatterbox.template.settings.item.form.label.post=Chatterbox.template.clean(["ref","label","class"]);Chatterbox.template.settings.item.form.label.frame='<div class="{ref} label{class}"><label for="{ref}">{label}</label></div>';Chatterbox.template.settings.item.form.field={};Chatterbox.template.settings.item.form.field.wrap={};Chatterbox.template.settings.item.form.field.wrap.post=Chatterbox.template.clean(["ref","field"]);Chatterbox.template.settings.item.form.field.wrap.frame='<div class="{ref} field">{field}</div>';Chatterbox.template.settings.item.form.field.dropdown={};Chatterbox.template.settings.item.form.field.dropdown.render={items:Chatterbox.template.settings.krender.dditems};
Chatterbox.template.settings.item.form.field.dropdown.post=Chatterbox.template.clean(["ref","items"]);Chatterbox.template.settings.item.form.field.dropdown.frame='<select class="{ref}">{items}</select>';Chatterbox.template.settings.item.form.field.textfield={};Chatterbox.template.settings.item.form.field.textfield.post=Chatterbox.template.clean(["ref","default"]);Chatterbox.template.settings.item.form.field.textfield.frame='<input class="{ref}" type="text" value="{default}" />';Chatterbox.template.settings.item.form.field.textarea={};Chatterbox.template.settings.item.form.field.textarea.post=Chatterbox.template.clean(["ref","default"]);Chatterbox.template.settings.item.form.field.textarea.frame='<textarea class="{ref}" rows="4" cols="20" value="{default}"></textarea>';Chatterbox.template.settings.item.form.field.radio={};Chatterbox.template.settings.item.form.field.radio.render={items:Chatterbox.template.settings.krender.radioitems};Chatterbox.template.settings.item.form.field.radio.post=Chatterbox.template.clean(["ref","items"]);
Chatterbox.template.settings.item.form.field.radio.frame='<div class="{ref} radiobox">{items}</div>';Chatterbox.template.settings.item.form.field.checkbox={};Chatterbox.template.settings.item.form.field.checkbox.render={items:Chatterbox.template.settings.krender.checkitems};Chatterbox.template.settings.item.form.field.checkbox.post=Chatterbox.template.clean(["ref","items"]);Chatterbox.template.settings.item.form.field.checkbox.frame='<div class="{ref} checkbox">{items}</div>';Chatterbox.template.settings.item.form.field.text={};Chatterbox.template.settings.item.form.field.text.pre=Chatterbox.template.settings.item.hint.prep;Chatterbox.template.settings.item.form.field.text.post=Chatterbox.template.clean(["title","text"]);Chatterbox.template.settings.item.form.field.text.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.form.field.text.frame="{title}<p>                                        {text}                                    </p>";
Chatterbox.template.settings.item.form.field.colour={};Chatterbox.template.settings.item.form.field.colour.post=Chatterbox.template.clean(["ref","default"]);Chatterbox.template.settings.item.form.field.colour.frame='<input class="{ref}" type="color" value="{default}" />';