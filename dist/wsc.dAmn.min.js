var wsc={};wsc.VERSION="1.7.42";wsc.STATE="release candidate";wsc.REVISION="0.21.127";wsc.defaults={};wsc.defaults.theme="wsct_dark";wsc.defaults.themes=["wsct_dAmn","wsct_dark"];function EventEmitter(){var h={},a=this;function g(l,m){var k=h[l]||false;if(k===false){h[l]=[m];return a}h[l].unshift(m);return a}function f(k){h[k]=[];return a}function b(){var k=Array.prototype.slice.call(arguments);var o=k.shift();var n=h[o]||false;var m=0;if(n===false){return m}for(var l in n){if(n.hasOwnProperty(l)){bubble=n[l].apply({},k);m++;if(bubble===false){break}}}return m}function j(k){return h[k]||[]}this.addListener=g;this.removeListeners=f;this.emit=b;this.listeners=j}var CryptoJS=CryptoJS||function(E,h){var o={},x=o.lib={},j=function(){},b=x.Base={extend:function(a){j.prototype=this;var g=new j;a&&g.mixIn(a);g.hasOwnProperty("init")||(g.init=function(){g.$super.init.apply(this,arguments)});g.init.prototype=g;g.$super=this;return g},create:function(){var a=this.extend();a.init.apply(a,arguments);
return a},init:function(){},mixIn:function(a){for(var g in a){a.hasOwnProperty(g)&&(this[g]=a[g])}a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},f=x.WordArray=b.extend({init:function(a,g){a=this.words=a||[];this.sigBytes=g!=h?g:4*a.length},toString:function(a){return(a||D).stringify(this)},concat:function(k){var n=this.words,l=k.words,m=this.sigBytes;k=k.sigBytes;this.clamp();if(m%4){for(var p=0;p<k;p++){n[m+p>>>2]|=(l[p>>>2]>>>24-8*(p%4)&255)<<24-8*((m+p)%4)}}else{if(65535<l.length){for(p=0;p<k;p+=4){n[m+p>>>2]=l[p>>>2]}}else{n.push.apply(n,l)}}this.sigBytes+=k;return this},clamp:function(){var a=this.words,g=this.sigBytes;a[g>>>2]&=4294967295<<32-8*(g%4);a.length=E.ceil(g/4)},clone:function(){var a=b.clone.call(this);a.words=this.words.slice(0);return a},random:function(g){for(var l=[],k=0;k<g;k+=4){l.push(4294967296*E.random()|0)}return new f.init(l,g)}}),B=o.enc={},D=B.Hex={stringify:function(l){var m=l.words;l=l.sigBytes;
for(var q=[],p=0;p<l;p++){var n=m[p>>>2]>>>24-8*(p%4)&255;q.push((n>>>4).toString(16));q.push((n&15).toString(16))}return q.join("")},parse:function(k){for(var l=k.length,n=[],m=0;m<l;m+=2){n[m>>>3]|=parseInt(k.substr(m,2),16)<<24-4*(m%8)}return new f.init(n,l/2)}},A=B.Latin1={stringify:function(k){var l=k.words;k=k.sigBytes;for(var n=[],m=0;m<k;m++){n.push(String.fromCharCode(l[m>>>2]>>>24-8*(m%4)&255))}return n.join("")},parse:function(k){for(var l=k.length,n=[],m=0;m<l;m++){n[m>>>2]|=(k.charCodeAt(m)&255)<<24-8*(m%4)}return new f.init(n,l)}},C=B.Utf8={stringify:function(a){try{return decodeURIComponent(escape(A.stringify(a)))}catch(k){throw Error("Malformed UTF-8 data")}},parse:function(a){return A.parse(unescape(encodeURIComponent(a)))}},z=x.BufferedBlockAlgorithm=b.extend({reset:function(){this._data=new f.init;this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=C.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(p){var r=this._data,v=r.words,u=r.sigBytes,s=this.blockSize,n=u/(4*s),n=p?E.ceil(n):E.max((n|0)-this._minBufferSize,0);
p=n*s;u=E.min(4*p,u);if(p){for(var q=0;q<p;q+=s){this._doProcessBlock(v,q)}q=v.splice(0,p);r.sigBytes-=u}return new f.init(q,u)},clone:function(){var a=b.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});x.Hasher=z.extend({cfg:b.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset()},reset:function(){z.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);return this._doFinalize()},blockSize:16,_createHelper:function(a){return function(k,l){return(new a.init(l)).finalize(k)}},_createHmacHelper:function(a){return function(k,l){return(new y.HMAC.init(a,l)).finalize(k)}}});var y=o.algo={};return o}(Math);(function(A){function g(r,s,p,v,q,u,n){r=r+(s&p|~s&v)+q+n;return(r<<u|r>>>32-u)+s}function j(r,s,p,v,q,u,n){r=r+(s&v|p&~v)+q+n;return(r<<u|r>>>32-u)+s}function k(r,s,p,v,q,u,n){r=r+(s^p^v)+q+n;return(r<<u|r>>>32-u)+s}function h(r,s,p,v,q,u,n){r=r+(p^(s|~v))+q+n;return(r<<u|r>>>32-u)+s
}for(var b=CryptoJS,f=b.lib,x=f.WordArray,z=f.Hasher,f=b.algo,o=[],y=0;64>y;y++){o[y]=4294967296*A.abs(A.sin(y+1))|0}f=f.MD5=z.extend({_doReset:function(){this._hash=new x.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(Q,N){for(var V=0;16>V;V++){var P=N+V,n=Q[P];Q[P]=(n<<8|n>>>24)&16711935|(n<<24|n>>>8)&4278255360}var V=this._hash.words,P=Q[N+0],n=Q[N+1],O=Q[N+2],L=Q[N+3],J=Q[N+4],H=Q[N+5],F=Q[N+6],E=Q[N+7],p=Q[N+8],m=Q[N+9],l=Q[N+10],a=Q[N+11],M=Q[N+12],K=Q[N+13],I=Q[N+14],G=Q[N+15],U=V[0],T=V[1],S=V[2],R=V[3],U=g(U,T,S,R,P,7,o[0]),R=g(R,U,T,S,n,12,o[1]),S=g(S,R,U,T,O,17,o[2]),T=g(T,S,R,U,L,22,o[3]),U=g(U,T,S,R,J,7,o[4]),R=g(R,U,T,S,H,12,o[5]),S=g(S,R,U,T,F,17,o[6]),T=g(T,S,R,U,E,22,o[7]),U=g(U,T,S,R,p,7,o[8]),R=g(R,U,T,S,m,12,o[9]),S=g(S,R,U,T,l,17,o[10]),T=g(T,S,R,U,a,22,o[11]),U=g(U,T,S,R,M,7,o[12]),R=g(R,U,T,S,K,12,o[13]),S=g(S,R,U,T,I,17,o[14]),T=g(T,S,R,U,G,22,o[15]),U=j(U,T,S,R,n,5,o[16]),R=j(R,U,T,S,F,9,o[17]),S=j(S,R,U,T,a,14,o[18]),T=j(T,S,R,U,P,20,o[19]),U=j(U,T,S,R,H,5,o[20]),R=j(R,U,T,S,l,9,o[21]),S=j(S,R,U,T,G,14,o[22]),T=j(T,S,R,U,J,20,o[23]),U=j(U,T,S,R,m,5,o[24]),R=j(R,U,T,S,I,9,o[25]),S=j(S,R,U,T,L,14,o[26]),T=j(T,S,R,U,p,20,o[27]),U=j(U,T,S,R,K,5,o[28]),R=j(R,U,T,S,O,9,o[29]),S=j(S,R,U,T,E,14,o[30]),T=j(T,S,R,U,M,20,o[31]),U=k(U,T,S,R,H,4,o[32]),R=k(R,U,T,S,p,11,o[33]),S=k(S,R,U,T,a,16,o[34]),T=k(T,S,R,U,I,23,o[35]),U=k(U,T,S,R,n,4,o[36]),R=k(R,U,T,S,J,11,o[37]),S=k(S,R,U,T,E,16,o[38]),T=k(T,S,R,U,l,23,o[39]),U=k(U,T,S,R,K,4,o[40]),R=k(R,U,T,S,P,11,o[41]),S=k(S,R,U,T,L,16,o[42]),T=k(T,S,R,U,F,23,o[43]),U=k(U,T,S,R,m,4,o[44]),R=k(R,U,T,S,M,11,o[45]),S=k(S,R,U,T,G,16,o[46]),T=k(T,S,R,U,O,23,o[47]),U=h(U,T,S,R,P,6,o[48]),R=h(R,U,T,S,E,10,o[49]),S=h(S,R,U,T,I,15,o[50]),T=h(T,S,R,U,H,21,o[51]),U=h(U,T,S,R,M,6,o[52]),R=h(R,U,T,S,L,10,o[53]),S=h(S,R,U,T,l,15,o[54]),T=h(T,S,R,U,n,21,o[55]),U=h(U,T,S,R,p,6,o[56]),R=h(R,U,T,S,G,10,o[57]),S=h(S,R,U,T,F,15,o[58]),T=h(T,S,R,U,K,21,o[59]),U=h(U,T,S,R,J,6,o[60]),R=h(R,U,T,S,a,10,o[61]),S=h(S,R,U,T,O,15,o[62]),T=h(T,S,R,U,m,21,o[63]);
V[0]=V[0]+U|0;V[1]=V[1]+T|0;V[2]=V[2]+S|0;V[3]=V[3]+R|0},_doFinalize:function(){var p=this._data,q=p.words,m=8*this._nDataBytes,r=8*p.sigBytes;q[r>>>5]|=128<<24-r%32;var n=A.floor(m/4294967296);q[(r+64>>>9<<4)+15]=(n<<8|n>>>24)&16711935|(n<<24|n>>>8)&4278255360;q[(r+64>>>9<<4)+14]=(m<<8|m>>>24)&16711935|(m<<24|m>>>8)&4278255360;p.sigBytes=4*(q.length+1);this._process();p=this._hash;q=p.words;for(m=0;4>m;m++){r=q[m],q[m]=(r<<8|r>>>24)&16711935|(r<<24|r>>>8)&4278255360}return p},clone:function(){var l=z.clone.call(this);l._hash=this._hash.clone();return l}});b.MD5=z._createHelper(f);b.HmacMD5=z._createHmacHelper(f)})(Math);wsc.Transport=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.Transport.Create=function(g,b,f,a){if(typeof io!=="undefined"){return new wsc.SocketIO(g,b,f,a)}if(!window.WebSocket){throw"This browser does not support websockets."}return new wsc.WebSocket(g,b,f,a)};wsc.Transport.prototype.open=function(a){this._open=a||this.sopen
};wsc.Transport.prototype.message=function(a){this._message=a||this.smessage};wsc.Transport.prototype.disconnect=function(a){this._disconnect=a||this.sdisconnect};wsc.Transport.prototype.sopen=function(){};wsc.Transport.prototype.smessage=function(){};wsc.Transport.prototype.sdisconnect=function(){};wsc.Transport.prototype._open=function(b,a){};wsc.Transport.prototype._message=function(a){};wsc.Transport.prototype._disconnect=function(a){};wsc.Transport.prototype.connect=function(){};wsc.Transport.prototype.send=function(a){};wsc.Transport.prototype.close=function(){};wsc.WebSocket=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.WebSocket.prototype=new wsc.Transport;wsc.WebSocket.prototype.constructor=wsc.WebSocket;wsc.WebSocket.prototype.onopen=function(b,a){this.sock=a||this.conn;this._open(b,this)};wsc.WebSocket.prototype.ondisconnect=function(a){this.sock=null;this.conn=null;this._disconnect(a)};wsc.WebSocket.prototype.connect=function(){var a=this;
this.conn=new WebSocket(this.server);this.conn.onopen=function(f,b){a.onopen(f,b)};this.conn.onmessage=this._message;this.conn.onclose=function(b){a.ondisconnect(b)}};wsc.WebSocket.prototype.send=function(a){if(this.sock==null){return -1}return this.sock.send(replaceAll(escape(a).replace(/\%u([\dA-F]{4})/g,"%26%23x$1%3B"),"+","%2B"))};wsc.WebSocket.prototype.close=function(){if(this.sock==null){return}this.sock.close()};wsc.SocketIO=function(g,b,f,a){this.sock=null;this.conn=null;this.server=g;this.open(b);this.message(f);this.disconnect(a)};wsc.SocketIO.prototype=new wsc.Transport("");wsc.SocketIO.prototype.constructor=wsc.SocketIO;wsc.SocketIO.prototype.connect=function(){var a=this;this.conn=io.connect(this.server);this.conn.on("connect",function(f,b){a.onopen(f,b)});this.conn.on("message",function(b){a._message({data:b})});this.conn.on("close",function(b){a.ondisconnect(b)})};wsc.SocketIO.prototype.onopen=function(b,a){this.sock=a||this.conn;this._open(b,this)};wsc.SocketIO.prototype.ondisconnect=function(a){this.sock=null;
this.conn=null;this._disconnect(a)};wsc.SocketIO.prototype.send=function(a){if(this.sock==null){return -1}return this.sock.send(replaceAll(escape(a).replace(/\%u([\dA-F]{4})/g,"%26%23x$1%3B"),"+","%2B"))};wsc.SocketIO.prototype.close=function(){if(this.sock==null){return}this.sock.close()};function $_GET(f,b){b=b||window.location.search;var a=new RegExp("&"+f+"(?:=([^&]*))?(?=&|$)","i");b=b.replace(/^\?/,"&").match(a);if(b){return typeof b[1]!="undefined"?decodeURIComponent(b[1].replace(/\+/g,"%20")):""}}function UnixTimestamp(a){ret=new Date(a*1000);return ret}var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];function PosEnd(a){return a=="1"?"st":(a=="2"?"nd":(a=="3"?"rd":"th"))}function DateStamp(a){a=UnixTimestamp(a);date=String(a.getDate());month=a.getMonth();df=date[date.length-1];return date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()}function caseInsensitiveSort(g,f){g=g.toLowerCase();f=f.toLowerCase();
return((g>f)?1:(g<f?-1:0))}function EscapeRegExp(a){return a.replace((new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g")),"\\$1")}String.format=function(){var a=Array.prototype.slice.call(arguments);var f=a.shift();a=a.shift();if(a.length==0){return f}var b=a.length;return f.replace(/{(\d+)}/g,function(g,h){if(b<=parseInt(h)){return g}return typeof a[h]!="undefined"?a[h]:g})};replaceAllRaw=function(f,b,a){while(f.indexOf(b)>-1){f=f.replace(b,a)}return f};replaceAll=function(f,b,a){return f.split(b).join(a)};Object.size=function(f){var b=0,a;for(a in f){if(f.hasOwnProperty(a)){b++}}return b};Object.steal=function(g,f){for(var h in f){if(!g.hasOwnProperty(h)&&!f.hasOwnProperty(h)){continue}if(typeof g[h]=="object"){g[h]=Object.extend(g[h],f[h])}else{g[h]=f[h]}}};Object.extend=function(g,f){var h={};Object.steal(h,g);Object.steal(h,f);return h};function zeroPad(b,a){a=a||2;a-=b.toString().length;if(a>0){return new Array(a+(/\./.test(b)?2:1)).join("0")+b
}return b+""}function formatTime(b,a){a=a||new Date();HH=a.getHours();hh=HH;b=replaceAll(b,"{mm}",zeroPad(a.getMinutes(),2));b=replaceAll(b,"{ss}",zeroPad(a.getSeconds(),2));mr="am";if(hh>11){mr="pm";if(hh>12){hh=hh-12}}else{if(hh==0){hh="12"}}b=replaceAll(b,"{hh}",zeroPad(hh,2));b=replaceAll(b,"{HH}",zeroPad(HH,2));b=replaceAll(b,"{mr}",mr);return b}function oxlist(a){last=a.pop();ret=a.join(", ");return ret+(ret.length>0?", and ":"")+last}function pluralise(b,a){return b+(a==1?"":"s")}function timeLengthString(f){if(f<=0){return"0 seconds."}var a=f;var g=[];g.unshift(["second",Math.round(a%60)]);a/=Math.round(60);g.unshift(["minute",Math.round(a%60)]);a/=Math.round(60);g.unshift(["hour",Math.round(a%24)]);a/=Math.round(24);g.unshift(["day",a]);var b=[];for(i in g){lapse=g[i];if(lapse[1]<1){continue}b.push(lapse[1].toString()+" "+pluralise(lapse[0],lapse[1]))}return oxlist(b)}function StringSet(a){this.items=a||[]}StringSet.prototype.add=function(b,a){if(!b){return false}b=b.toLowerCase();
if(this.contains(b)){return true}if(a){this.items.unshift(b)}else{this.items.push(b)}return true};StringSet.prototype.remove=function(a){if(!a){return false}a=a.toLowerCase();if(!this.contains(a)){return true}this.items.splice(this.items.indexOf(a),1);return true};StringSet.prototype.contains=function(a){if(!a){return false}return this.items.indexOf(a.toLowerCase())!=-1};wsc.Middleware=function(){this.callbacks={}};wsc.Middleware.prototype.add=function(b,f){var a=this.callbacks[b]||false;if(a===false){this.callbacks[b]=[]}this.callbacks[b].push(f);return this.callbacks[b].length};wsc.Middleware.prototype.run=function(b,h,f){var g=(this.callbacks[b]||[]).slice();g.push(h);var a=function(j){g.shift()(j,a)};a(f)};wsc.Storage=function(b,a){this.ns=b||null;this.parent=a||null};wsc.Storage.prototype.folder=function(a){if(this.ns!=null){a=this.ns+"."+a}return new wsc.Storage(a,this)};wsc.Storage.prototype.get=function(a,f){if(this.ns!=null){a=this.ns+"."+a}try{if(!localStorage.hasOwnProperty(a)){return f
}return localStorage[a]}catch(b){return f}};wsc.Storage.prototype.set=function(a,f){if(this.ns!=null){a=this.ns+"."+a}try{localStorage[a]=f}catch(b){}};wsc.Storage.prototype.remove=function(a){if(this.ns!=null){a=this.ns+"."+a}try{if(!localStorage.hasOwnProperty(a)){return false}return delete localStorage[a]}catch(b){}return false};var chains=[["recv","admin"]];wsc.Packet=function(g,j,a){if(!(g)){return null}if(a===undefined){a=true}j=j||"=";var b={cmd:null,param:null,arg:{},body:null,sub:[],raw:g};var l=null;var m=-1;try{m=g.indexOf("\n\n");if(m>-1){b.body=g.substr(m+2);g=g.substr(0,m)}l=g.split("\n");if(l[0].indexOf(j)==-1){cline=l.shift().split(" ");b.cmd=cline.shift()||null;b.param=cline.join(" ")||null}for(var f in l){arg=l[f];m=arg.search(j);if(m==-1){continue}b.arg[arg.substr(0,m)]=arg.substr(m+j.length)||""}if(b.body!=null&&a){subs=b.body.split("\n\n");for(var h in subs){sub=wsc.Packet(subs[h],j,false);if(sub==null){break}sub.body=subs.slice(h+1).join("\n\n");b.sub.push(sub)}}}catch(k){return null
}b.toString=function(){return packetToString(b)};b.name=packetEvtName(b);return b};function wsc_packetstr(h,j,f,a){var b="";if(h){b=h;if(j){b=b+" "+j}}if(f){for(var g in f){b=b+"\n"+g+"="+f[g]}}b=b+"\n";if(a){b=b+"\n"+a}return b}function packetToString(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function packetEvtName(b){var g=b.cmd;var a=null;for(var f in chains){a=chains[f];if(a[0]!=g){continue}var h=b.sub[0];g=g+"_"+h.cmd;if(a.length>1&&h.param!=undefined){if(a[1]==h.cmd){return g+"_"+h.param}}}return g}wsc.Channel=function(b,f,g,a){this.info={members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""},};this.client=b;this.hidden=g;this.monitor=(a==undefined?false:a);this.raw=b.format_ns(f);this.selector=(this.raw.substr(0,2)=="pc"?"pc":"c")+"-"+b.deform_ns(f).slice(1).toLowerCase();this.namespace=b.deform_ns(f);this.monitor=Object.size(this.client.channelo)==0};wsc.Channel.prototype.build=function(){this.info.members={};if(this.namespace[0]=="@"){this.set_privclasses({pkt:{body:""}})
}};wsc.Channel.prototype.property=function(a){var b=a.pkt.arg.p;switch(b){case"title":case"topic":this.set_header(b,a);break;case"privclasses":this.set_privclasses(a);break;case"members":this.set_members(a);break;default:this.server_message("Received unknown property "+b+" received in "+this.info.namespace+".");break}};wsc.Channel.prototype.set_header=function(a,b){this.info[a]["content"]=b.value.text()||"";this.info[a]["by"]=b.by;this.info[a]["ts"]=b.ts};wsc.Channel.prototype.set_privclasses=function(j){if(this.namespace[0]=="@"){this.info.pc={100:"Room Members"};this.info.pc_order=[100]}else{this.info.pc={};this.info.pc_order=[];var a=j.pkt.body.split("\n");var g=[];for(var b in a){if(!a.hasOwnProperty(b)){continue}g=a[b].split(":");if(g.length==1){continue}this.info.pc_order.push(parseInt(g[0]));this.info.pc[parseInt(g[0])]=g[1]}}this.info.pc_order.sort(function(l,k){return k-l});var h=this.info.pc;var f=this.info.pc_order.slice(0)};wsc.Channel.prototype.get_privclass_order=function(a){a=a.toLowerCase();
for(var b in this.info.pc){if(!this.info.pc.hasOwnProperty(b)){continue}if(this.info.pc[b].toLowerCase()==a){return b}}};wsc.Channel.prototype.set_members=function(b){this.info.members={};for(var a in b.pkt.sub){if(!b.pkt.sub.hasOwnProperty(a)){continue}this.register_user(b.pkt.sub[a],true)}this.set_user_list()};wsc.Channel.prototype.set_user_list=function(){if(Object.size(this.info.members)==0){return}var f=this.get_usernames();var g=[];var b=null;for(var a in f){if(!f.hasOwnProperty(a)){continue}g.push(this.info.members[f[a]])}this.client.trigger("ns.user.list",{name:"set.userlist",ns:this.namespace,users:g})};wsc.Channel.prototype.user_info=function(a){var f=this.info.members[a];var b=f.symbol;return{name:a,pc:f.pc||"Room Members",symbol:b,conn:f.conn,hover:{member:f,name:a,avatar:'<img class="avatar" src="" height="50" width="50" />',link:b+'<a target="_blank" href="http://'+a+"."+this.client.settings.domain+'/">'+a+"</a>",info:[]}}};wsc.Channel.prototype.register_user=function(a,f){var b=a.param;
if(this.info.members[b]==undefined){this.info.members[b]=a.arg;this.info.members[b]["username"]=b;this.info.members[b]["conn"]=1;this.info.members[b]=this.user_info(b)}else{for(i in a.arg){this.info.members[b][i]=a.arg[i]}this.info.members[b]["conn"]++}if(!("pc" in this.info.members[b])){this.info.members[b]["pc"]="Room Members"}f=f||false;if(f){return}this.client.trigger("ns.user.registered",{name:"ns.user.registered",ns:this.namespace,user:b})};wsc.Channel.prototype.get_usernames=function(){var b=[];for(var a in this.info.members){b.push(a)}b.sort(caseInsensitiveSort);return b};wsc.Channel.prototype.remove_user=function(a,b){b=b||false;var f=this.info.members[a];if(f==undefined){return}f.conn--;if(f.conn==0||b){delete this.info.members[a]}this.client.trigger("ns.user.remove",{user:f.name,ns:this.namespace})};wsc.Channel.prototype.recv_join=function(b){var a=new wsc.Packet("user "+b.user+"\n"+b.info);this.register_user(a)};wsc.Channel.prototype.recv_part=function(a){this.remove_user(a.user)
};wsc.Channel.prototype.recv_privchg=function(a){var b=this;this.client.cascade("ns.user.privchg",function(f){var g=b.info.members[f.user];if(!g){return}g.pc=f.pc},a)};wsc.Channel.prototype.recv_kicked=function(a){this.remove_user(a.user,true);this.set_user_list()};wsc.MessageString=function(a,b){this._parser=b||new wsc.MessageParser();this.raw=a};with(wsc.MessageString.prototype=new String){constructor=wsc.MessageParser;toString=valueOf=function(){return this.raw}}wsc.MessageString.prototype.html=function(){return this.raw};wsc.MessageString.prototype.text=function(){return this.raw};wsc.MessageString.prototype.ansi=function(){return this.raw};wsc.MessageParser=function(){};wsc.MessageParser.prototype.parse=function(a){return new wsc.MessageString(a,this)};wsc.MessageParser.prototype.render=function(b,a){return a.raw};wsc.Protocol=function(b){this.mparser=b||new wsc.MessageParser;this.chains=[["recv","admin"]];this.maps={chatserver:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_npmsg:[null,[["from","user"]],"message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",[["i","s"],"by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,"packet"],};
var a=this;this.mapper={recv:function(h,g,f){g.ns=h.param;return a.map(h.sub[0],g,f)}};this.messages={chatserver:['<span class="servermsg">** Connected to llama {version} *</span>',false,true],login:['<span class="servermsg">** Login as {username}: "{e}" *</span>',false,true],join:['<span class="servermsg">** Join {ns}: "{e}" *</span>',true],part:['<span class="servermsg">** Part {ns}: "{e}" * <em>{r}</em></span>',true],property:['<span class="servermsg">** Got {p} for {ns} *</span>',true],recv_msg:['<span class="cmsg user u-{user}"><strong>&lt;{user}&gt;</strong></span><span class="cmsg u-{user}">{message}</span>'],recv_npmsg:['<span class="cmsg user u-{user}"><strong>&lt;{user}&gt;</strong></span><span class="cmsg u-{user}">{message}</span>'],recv_action:['<span class="caction user u-{user}"><em>* {user}</em></span><span class="caction u-{user}">{message}</span>'],recv_join:['<span class="cevent bg">** {user} has joined *</span>'],recv_part:['<span class="cevent bg">** {user} has left * <em>{r}</em></span>'],recv_privchg:['<span class="cevent">** {user} has been made a member of {pc} by {by} *</span>'],recv_kicked:['<span class="cevent">** {user} has been kicked by {by} * <em>{r}</em></span>'],recv_admin_create:['<span class="cevent admin">** Privilege class {pc} has been created by {user} * <em>{privs}</em></span>'],recv_admin_update:['<span class="cevent admin">** Privilege class {pc} has been updated by {user} * <em>{privs}</em></span>'],recv_admin_rename:['<span class="cevent admin">** Privilege class {prev} has been renamed to {pc} by {user} *</span>'],recv_admin_move:['<span class="cevent admin">** All members of {prev} have been moved to {pc} by {user} * <em>{affected} affected user(s)</em></span>'],recv_admin_remove:['<span class="cevent admin">** Privilege class {pc} has been removed by {user} * <em>{affected} affected user(s)</em></span>'],recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:['<span class="cevent admin">** Admin command "{command}" failed * <em>{e}</em></span>'],kicked:['<span class="servermsg">** You have been kicked by {user} * <em>{r}</em></span>'],ping:null,disconnect:['<span class="servermsg">** You have been disconnected * <em>{e}</em></span>',false,true],send:['<span class="servermsg">** Send error: <em>{e}</em></span>'],kick:['<span class="servermsg">** Could not kick {user} * <em>{e}</em></span>'],get:['<span class="servermsg">** Could not get {p} info for {ns} * <em>{e}</em></span>'],set:['<span class="servermsg">** Could not set {p} * <em>{e}</em></span>'],kill:['<span class="servermsg">** Kill error * <em>{e}</em></span>'],unknown:['<span class="servermsg">** Received unknown packet in {ns} * <em>{packet}</em></span>',true],}
};wsc.Protocol.prototype.extend_maps=function(a){for(key in a){this.maps[key]=a[key]}};wsc.Protocol.prototype.extend_messages=function(a){for(key in a){this.messages[key]=a[key]}};wsc.Protocol.prototype.parse=function(b){name=this.event(b);if(!(name in this.maps)){console.log("unknown: ",name);console.log(this.maps);mapping=this.maps.unknown;name="unknown"}else{mapping=this.maps[name]}var a={name:name,pkt:b,ns:null};cmd=b.cmd;if(this.mapper[cmd]){this.mapper[cmd](b,a,mapping)}else{this.map(b,a,mapping)}return a};wsc.Protocol.prototype.event=function(b){var g=b.cmd;var a=null;for(var f in this.chains){a=this.chains[f];if(a[0]!=g){continue}var h=b.sub[0];g=g+"_"+h.cmd;if(a.length>1&&h.param!=undefined){if(a[1]==h.cmd){return g+"_"+h.param}}}return g};wsc.Protocol.prototype.map=function(f,b,a){for(var l in a){if(a[l]==null){continue}var m=a[l];var o=m;var j="",h="";switch(parseInt(l)){case 0:b[m]=f.param;break;case 1:if(a[1] instanceof Array){for(var g in a[1]){m=a[1][g];if(m instanceof Array){b[m[1]]=f.arg[m[0]];
o=m[1]}else{var j=m[0]=="*"?m.slice(1):m;b[m]=f.arg[j]||"";o=m}}}if(typeof a[1]=="string"){b[m]=f.arg.slice(0)}break;case 2:if(m instanceof Array){f.sub[0].sub=f.sub.slice(1);this.map(f.sub[0],b,m)}else{b[m]=f.body}break;case 3:b[m]=f.raw;break}if(o[0]!="*"){continue}j=o.slice(1);h=this.mparser.parse(b[o]);b[j]=h}};wsc.Protocol.prototype.render=function(b,f){var a=this.messages[b.name];if(!a){return""}var h=a[0];var g="";for(key in b){if(!b.hasOwnProperty(key)||key=="pkt"){continue}g=b[key];if(key=="ns"||key=="sns"){key="ns";g=b.sns}if(g.hasOwnProperty("_parser")){switch(f){case"text":g=g.text();break;case"html":g=g.html();break;case"ansi":g=g.ansi();break;default:g=g.text();break}}h=replaceAll(h,"{"+key+"}",g)}return h};wsc.Protocol.prototype.log=function(b){var a=this.messages[b.name];if(!a){return null}return new wsc.Protocol.LogMessage(b,a)};wsc.Protocol.LogMessage=function(b,a){this.event=b;this.template=a[0]||"";this.monitor=a[1]||false;this.global=a[2]||false;this._html=false;this._text=false;
this._ansi=false};wsc.Protocol.LogMessage.prototype.text=function(){if(this._text===false){this._text=this.render(0)}return this._text};wsc.Protocol.LogMessage.prototype.html=function(){if(this._html===false){this._html=this.render(1)}return this._html};wsc.Protocol.LogMessage.prototype.ansi=function(){if(this._ansi===false){this._ansi=this.render(2)}return this._ansi};wsc.Protocol.LogMessage.prototype.render=function(f){if(f===undefined){f=0}var b=this.template;var g="";for(var a in this.event){if(!this.event.hasOwnProperty(a)||a=="pkt"){continue}g=this.event[a];if(a=="ns"||a=="sns"){a="ns";g=this.event.sns}if(g.hasOwnProperty("_parser")){switch(f){case 1:g=g.html();break;case 2:g=g.ansi();break;case 0:default:g=g.text();break}}b=replaceAll(b,"{"+a+"}",g)}return b};wsc.Flow=function(a){this.protocol=a||new wsc.Protocol()};wsc.Flow.prototype.open=function(a,f,b){a.trigger("connected",{name:"connected",pkt:new wsc.Packet("connected\n\n")});a.connected=true;a.handshake();a.attempts=0};wsc.Flow.prototype.close=function(a,b){a.trigger("closed",{name:"closed",pkt:new wsc.Packet("connection closed\n\n")});
if(a.connected){a.ui.server_message("Connection closed");a.connected=false;if(a.conn instanceof wsc.SocketIO){a.ui.server_message("At the moment there is a problem with reconnecting under socket.io.");a.ui.server_message("Refresh the page to connect.");return}}else{a.ui.server_message("Connection failed")}if(a.attempts>2){a.ui.server_message("Can't connect. Try again later.");a.attempts=0;return}a.ui.server_message("Connecting in 2 seconds");setTimeout(function(){a.connect()},2000)};wsc.Flow.prototype.message=function(a,g){var b=new wsc.Packet(unescape(replaceAll(g.data,"+"," ")));if(b==null){return}var f=this.protocol.parse(b);if(f.ns==null){f.ns=a.mns}f.sns=a.deform_ns(f.ns);this.handle(a,f);a.trigger("pkt",f);a.trigger("pkt."+f.name,f)};wsc.Flow.prototype.handle=function(a,f){try{this[f.name](f,a)}catch(b){}};wsc.Flow.prototype.ping=function(b,a){a.pong()};wsc.Flow.prototype.chatserver=function(b,a){a.login()};wsc.Flow.prototype.login=function(f,a){if(f.pkt.arg.e=="ok"){var g=f.pkt.sub[0];
a.settings.username=f.pkt.param;a.settings.symbol=g.arg.symbol;a.settings.userinfo=g.arg;if(a.fresh){a.join(a.settings.autojoin);if(a.autojoin.on){for(var b in a.autojoin.channel){if(!a.autojoin.channel.hasOwnProperty(b)){continue}a.join(a.autojoin.channel[b])}}}else{for(key in a.channelo){if(a.channelo[key].namespace[0]!="~"){a.join(key)}}}}else{}if(a.fresh){a.fresh=false}};wsc.Flow.prototype.join=function(f,a){if(f.pkt.arg["e"]=="ok"){var b=a.deform_ns(f.pkt.param);a.create_ns(b,a.hidden.contains(f.pkt.param));a.ui.channel(b).server_message("You have joined "+b)}else{a.ui.chatbook.current.server_message("Failed to join "+a.deform_ns(f.pkt.param),f.pkt.arg["e"])}};wsc.Flow.prototype.part=function(f,a){var b=a.deform_ns(f.ns);var g=a.channel(b);if(f.e=="ok"){info="";if(f.r.length>0){info="["+f.r+"]"}else{a.remove_ns(f.ns)}msg="You have left "+b;g.server_message(msg,info);if(a.channels()==0){switch(f.r){case"bad data":case"bad msg":case"msg too big":break;default:if(f.r.indexOf("killed:")<0){return
}break}this.message(a,{data:"disconnect\ne="+e.r+"\n"})}}else{a.monitor("Couldn't leave "+b,f.e);g.server_message("Couldn't leave "+b,f.e)}};wsc.Flow.prototype.kicked=function(b,a){if(b.r.toLowerCase().indexOf("autokicked")>-1){return}a.join(b.ns)};wsc.Flow.prototype.property=function(b,a){chan=a.channel(b.pkt.param);if(!chan){return}chan.property(b)};wsc.Flow.prototype.recv_joinpart=function(b,a){c=a.channel(b.ns);if(b.name=="recv_join"){c.recv_join(b)}else{c.recv_part(b)}};wsc.Flow.prototype.recv_join=wsc.Flow.prototype.recv_joinpart;wsc.Flow.prototype.recv_part=wsc.Flow.prototype.recv_joinpart;wsc.Flow.prototype.recv_msg=function(b,a){a.channel(b.ns).recv_msg(b)};wsc.Flow.prototype.recv_action=wsc.Flow.prototype.recv_msg;wsc.Flow.prototype.recv_npmsg=wsc.Flow.prototype.recv_msg;wsc.Flow.prototype.recv_privchg=function(b,a){a.channel(b.ns).recv_privchg(b)};wsc.Flow.prototype.recv_kicked=function(b,a){a.channel(b.ns).recv_kicked(b)};wsc.defaults.Extension=function(f){var a={};a.away={on:false,reason:"",last:{},since:0,store:f.storage.folder("away"),format:{setaway:"/me is away: {reason}",setback:"/me is back",away:"{from}: I am away, reason: {reason}"}};
var n=function(){f.bind("cmd.connect",b.connection);f.bind("cmd.set",b.setter);f.bind("cmd.join",b.join);f.bind("cmd.chat",b.pjoin);f.bind("cmd.part",b.part);f.bind("cmd.say",b.say);f.bind("cmd.npmsg",b.npmsg);f.bind("cmd.me",b.action);f.bind("cmd.promote",b.chgpriv);f.bind("cmd.demote",b.chgpriv);f.bind("cmd.ban",b.ban);f.bind("cmd.unban",b.ban);f.bind("cmd.kick",b.killk);f.bind("cmd.whois",b.whois);f.bind("cmd.title",b.title);f.bind("cmd.topic",b.title);f.bind("cmd.admin",b.admin);f.bind("cmd.disconnect",b.connection);f.bind("cmd.kill",b.killk);f.bind("cmd.raw",b.raw);f.bind("cmd.clear",b.clear);f.bind("cmd.clearall",b.clearall);f.bind("cmd.close",b.close);f.bind("pkt.property",m);f.bind("pkt.recv_admin_show",g);f.bind("pkt.recv_admin_showverbose",g);f.bind("pkt.get",l);f.bind("cmd.gettitle",b.gett);f.bind("cmd.gettopic",b.gett);f.bind("cmd.theme",b.theme);f.ui.on("settings.open",j);f.ui.on("settings.open.ran",h);f.ui.on("settings.save.ui",k);f.ui.on("settings.save",function(){f.config_save()
})};var k=function(p,o){f.settings.ui.theme=p.theme;f.settings.ui.clock=p.clock;f.settings.ui.tabclose=p.tabclose};var j=function(q,p){var o=q.settings.page("Main");var r={};r.username=f.settings.username;r.pk=f.settings.pk;r.devel=f.settings.developer;o.item("Form",{ref:"login",title:"Login",text:"Here you can change the username and token used to                    log into the chat server.",fields:[["Textfield",{ref:"username",label:"Username","default":r.username}],["Textfield",{ref:"token",label:"Token","default":r.pk}]],event:{save:function(s){f.settings.username=s.data.username;f.settings.pk=s.data.token}}},true);o.item("Form",{ref:"developer",title:"Developer Mode",text:"Turn developer mode on or off.\n\nDeveloper mode will expose any hidden                channel tabs, amongst other things. Keep this turned off unless you're working                on implementing something.",fields:[["Checkbox",{ref:"enabled",items:[{value:"on",title:"On",selected:r.devel}]}]],event:{change:function(s){f.settings.developer=(s.data.enabled.indexOf("on")!=-1);
f.ui.developer(f.settings.developer)},save:function(s){r.devel=f.settings.developer},close:function(s){f.settings.developer=r.devel;f.ui.developer(f.settings.developer)}}});o.item("Text",{ref:"intro",title:"Main",text:"Use this window to view and change your settings.\n\nCheck                    the different pages to see what settings can be changed.",},true);o.item("Text",{ref:"debug",wclass:"faint",title:"Debug Information",text:"Chat Agent: <code>"+f.settings.agent+"</code>\n\nUser                    Agent: <code>"+navigator.userAgent+"</code>"})};var h=function(q,p){var o=q.settings.page("About",true);o.item("Text",{ref:"about-wsc",title:"Wsc",text:'Currently using <a href="http://github.com/photofroggy/wsc/">wsc</a>                    version '+wsc.VERSION+" "+wsc.STATE+'.\n\nWsc                    works using HTML5, javascript, and CSS3. WebSocket is used for the connection                    where possible. The source code for this client is pretty huge.\n\nWsc was created                    by ~<a href="http://photofroggy.deviantart.com/">photofroggy</a>'})
};var b={};b.theme=function(p,o){o.ui.theme(p.args.split(" ").shift())};b.setter=function(q){var p=q.args.split(" ");var o=p.shift().toLowerCase();var p=p.join(" ");if(p.length==0){f.cchannel.serverMessage("Could not set "+o,"No data supplied");return}if(!(o in f.settings)){f.cchannel.serverMessage('Unknown setting "'+o+'"');return}f.settings[o]=p;f.cchannel.serverMessage("Changed "+o+" setting","value: "+p)};b.connection=function(o){f[o.cmd]()};b.join=function(o){var p=o.args.split(" ");var p=p.toString()==""?[]:p;if(o.ns!=o.target){p.unshift(o.target)}if(p.toString()==""){return}for(index in p){f.join(p[index])}};b.pjoin=function(o){var p=o.args.split(" ");var p=p.toString()==""?[]:p;if(o.ns!=o.target){p.unshift(o.target)}if(p.toString()==""){return}for(index in p){f.join("@"+p[index])}};b.part=function(o){var p=o.args.split(" ");if(o.ns!=o.target){p.unshift(o.target)}if(p.toString()==""){f.part(o.ns);return}for(index in p){f.part(p[index])}};b.title=function(o){f.set(o.target,o.cmd,o.args)
};b.chgpriv=function(p){var o=p.args.split(" ");f[p.cmd.toLowerCase()](p.target,o[0],o[1])};b.ban=function(s,o){var q=s.args.split(" ");var p=q.shift();var r=s.cmd;if(r=="ban"&&q.length>0){o.kick(s.target,p,q.join(" "))}o[r](s.target,p)};b.action=function(o){f.action(o.target,o.args)};b.raw=function(o){f.send(o.args.replace(/\\n/gm,"\n"))};b.killk=function(s,o){var v=s.args.split(" ");var p=v.shift();var q=v.length>0?v.join(" "):null;if(s.cmd=="kick"){o.kick(s.target,p,q)}else{o.kill(p,q)}};b.say=function(o){if(f.channel(o.target).monitor){return}f.say(o.target,o.args)};b.npmsg=function(o){f.npmsg(o.target,o.args)};b.clear=function(q,o){if(q.args.length>0){var r=q.args.split(" ");for(var p in r){if(!r.hasOwnProperty(p)){continue}o.ui.channel(q.target).clear_user(r[p])}}else{o.ui.channel(q.target).clear()}};b.clearall=function(p,o){var r=null;if(p.args.length>0){var q=p.args.split(" ");r=function(u,v){for(var s in q){if(!q.hasOwnProperty(s)){continue}v.clear_user(q[s])}}}else{r=function(s,u){u.clear()
}}o.ui.chatbook.each(r,true)};b.close=function(o){f.part(o.target);f.remove_ns(o.target)};b.whois=function(p,o){o.whois(p.args.split(" ")[0])};b.admin=function(p,o){o.admin(p.target,p.args)};b.disconnect=function(p,o){o.disconnect()};b.gett=function(p,o){var q=p.cmd.indexOf("title")>-1?"title":"topic";o.ui.control.set_text("/"+q+" "+o.channel(p.target).info[q].content)};var m=function(r,o){if(r.p!="info"){return}var p=r.pkt.sub;var s=p.shift().arg;s.username=r.sns.substr(1);s.connections=[];var q={};while(p.length>0){q=p.shift().arg;q.channels=[];while(p.length>0){if(p[0].cmd!="ns"){break}q.channels.unshift(o.deform_ns(p.shift().param))}s.connections.push(q)}o.ui.chatbook.current.log_whois(s)};var l=function(p,o){if(p.ns.indexOf("login:")!=0){return}var q=p.sns.substr(1);o.ui.pager.notice({ref:"whois-"+q,heading:"Whois Failed",content:"Whois failed for "+q+".\nNo such user online."},false,5000)};var g=function(s,p){var x=p.channel(s.ns);var o=s.info.split("\n");var v="";var u=[];var q="";
for(var r in o){if(!o.hasOwnProperty(r)){continue}v=o[r].split(" ");if(s.p=="privclass"){u.push([v.shift(),v.shift().split("=")[1],v.join(" ")])}else{if(s.p=="users"){q=v.shift().split(":",1)[0];u.push([q,x.get_privclass_order(q),v.join(" ")])}}}p.ui.chatbook.current.log_pc(s.p=="privclass",u)};n();wsc.defaults.Extension.Ignore(f);wsc.defaults.Extension.Away(f);wsc.defaults.Extension.Autojoin(f)};wsc.defaults.Extension.Autojoin=function(a){var f=a.autojoin;a.ui.nav.add_button({icon:"chat",label:"",title:"Join your autojoin channels",href:"#autojoin-do",handler:function(){for(var h in a.autojoin.channel){if(!a.autojoin.channel.hasOwnProperty(h)){continue}a.join(a.autojoin.channel[h])}}});var g=function(){a.bind("cmd.autojoin",b);a.ui.on("settings.open",f.page)};f.page=function(l,n){var m=l.settings.page("Autojoin");var k="<ul>";var o={};o.ajon=a.autojoin.on;o.chan=a.autojoin.channel;if(a.autojoin.channel.length==0){k+="<li><i>No autojoin channels set</i></li></ul>"}else{for(var j in a.autojoin.channel){if(!a.autojoin.channel.hasOwnProperty(j)){continue
}k+="<li>"+a.autojoin.channel[j]+"</li>"}k+="</ul>"}m.item("Checkbox",{ref:"eaj",title:"Autojoin",text:"Turn on autojoin to automatically join selected channels                    when you connect to the chat server.",items:[{value:"yes",title:"On",selected:o.ajon}],event:{change:function(p){if(p.target.value=="yes"){a.autojoin.on=p.target.checked}},save:function(p){o.ajon=a.autojoin.on;a.config_save()},close:function(p){a.autojoin.on=o.ajon}}});var h=m.item("Items",{ref:"channelss",title:"Channels",text:"Add any channels you want to join automatically when you                    connect to the chat server.",items:a.autojoin.channel,prompt:{title:"Add Channel",label:"Channel:",},event:{up:function(p){var q=p.args.swap;a.autojoin.channel[q["this"].index]=q.that.item;a.autojoin.channel[q.that.index]=q["this"].item;h.options.items=a.autojoin.channel},down:function(p){var q=p.args.swap;a.autojoin.channel[q["this"].index]=q.that.item;a.autojoin.channel[q.that.index]=q["this"].item;h.options.items=a.autojoin.channel
},add:function(r){var q=a.deform_ns(r.args.item).toLowerCase();var p=a.autojoin.channel.indexOf(q);if(p!=-1){return}a.autojoin.channel.push(q);h.options.items=a.autojoin.channel},remove:function(p){a.autojoin.channel.splice(p.args.index,1);h.options.items=a.autojoin.channel},save:function(p){o.chan=a.autojoin.channel;a.config_save()},close:function(p){a.config_load()}}})};var b=function(o){var j=o.args.split(" ");if(!j){return}var m=j.shift().toLowerCase();var h=function(q){};var l=false;var p=a.channel(o.ns);switch(m){case"add":h=function(q){if(a.autojoin.channel.indexOf(q)==-1){l=true;a.autojoin.channel.push(q);p.server_message("Added "+q+" to your autojoin.")}else{p.server_message("Already have "+q+" on your autojoin.")}};break;case"rem":case"remove":h=function(r){var q=a.autojoin.channel.indexOf(r);if(q!=-1){l=true;a.autojoin.channel.splice(q,1);p.server_message("Removed "+r+" from your autojoin.")}else{p.server_message(r+" is not on your autojoin list.")}};break;case"on":p.server_message("Autojoin on.");
if(!a.autojoin.on){l=true;a.autojoin.on=true}break;case"off":p.server_message("Autojoin off.");if(a.autojoin.on){l=true;a.autojoin.on=false}break}var n="";for(var k in j){if(!j.hasOwnProperty(k)){continue}n=a.deform_ns(j[k]).toLowerCase();h(n)}if(l){a.config_save()}};g()};wsc.defaults.Extension.Away=function(b){var g=b.storage.folder("away");var f={on:false,reason:"",last:{},since:0,interval:60000,format:{setaway:"/me is away: {reason}",setback:"/me is back",away:"{user}: I've been away for {timesince}. Reason: {reason}"}};b.away=f;var m=function(){k();h();b.bind("cmd.setaway",a);b.bind("cmd.setback",l);b.bind("pkt.recv_msg.highlighted",j);b.ui.on("settings.open",f.page)};f.page=function(o,q){var n=function(u){u=replaceAll(u,"<","&lt;");u=replaceAll(u,">","&gt;");u=replaceAll(u,'"',"&quot;");return u};var r=function(u){u=replaceAll(u,"&lt;","<");u=replaceAll(u,"&gt;",">");u=replaceAll(u,"&quot;",'"');return u};var p=o.settings.page("Away");var s={};s.away=f.format.away;s.sa=f.format.setaway;
s.sb=f.format.setback;s.intr=f.interval;p.item("Text",{ref:"intro",title:"Away Messages",text:"Use away messages when you are away from the chats.\n\n                    You can set yourself away using the                     <code>/setaway [reason]</code> command. When you get back,                    use <code>/setback</code>. While you are away, the client                    will automatically respond when people try to talk to you,                    telling them you're away.",});p.item("Form",{ref:"msgs",title:"Messages",text:"Here you can set the messages displayed when you set                    yourself away or back. You can also change the away message                    format.",hint:"<b>{user}</b><br/>This is replaced with the username of the person trying to talk to you\n\n<b>{reason}</b>                    <br/>This is replaced by your reason for being away.\n\n<b>{timesince}</b>                    <br/>Use this to show how long you have been away for.",fields:[["Textfield",{ref:"away",label:"Away","default":n(s.away)}],["Textfield",{ref:"setaway",label:"Setaway","default":n(s.sa)}],["Textfield",{ref:"setback",label:"Setback","default":n(s.sb)}]],event:{save:function(u){f.format.away=r(u.data.away);
f.format.setaway=r(u.data.setaway);f.format.setback=r(u.data.setback);h()}}});p.item("Form",{ref:"interval",title:"Message Interval",text:"Here you can set the amount of time to wait before                     displaying another away message. The interval is in seconds.",fields:[["Textfield",{ref:"interval",label:"Interval","default":(s.intr/1000).toString()}]],event:{save:function(u){f.interval=parseInt(u.data.interval)*1000;h()}}})};var a=function(p,n){f.on=true;f.last={};f.since=new Date();f.reason=p.args;var q=n.say;var o=replaceAll(f.format.setaway,"{reason}",f.reason||"[silent away]");if(o.indexOf("/me ")==0){o=o.substr(4);q=n.action}n.each_channel(function(r){q.call(n,r,o)});n.ui.control.add_state({ref:"away",label:"Away, reason: <i>"+(f.reason||"[silent away]")+"</i>"})};var l=function(p,n){f.on=false;var q=n.say;var o=f.format.setback;if(o.indexOf("/me ")==0){o=o.substr(4);q=n.action}n.each_channel(function(r){q.call(n,r,o)});n.ui.control.rem_state("away")};var j=function(r,n){if(!f.on){return
}if(f.reason.length==0){return}if(r.user==n.settings.username){return}if(n.exclude.contains(r.ns)){return}var p=new Date();var q=r.sns.toLowerCase();if(q in f.last){if((p-f.last[q])<=f.interval){return}}var o=timeLengthString((p-f.since)/1000);var s=replaceAll(f.format.away,"{user}",r.user);s=replaceAll(s,"{timesince}",o);n.say(r.ns,replaceAll(s,"{reason}",f.reason));f.last[q]=p};var k=function(){f.format.setaway=g.get("setaway","/me is away: {reason}");f.format.setback=g.get("setback","/me is back");f.format.away=g.get("away","{user}: I've been away for {timesince}. Reason: {reason}");f.interval=parseInt(g.get("interval",60000))};var h=function(){g.set("interval",f.interval);g.set("setaway",f.format.setaway);g.set("setback",f.format.setback);g.set("away",f.format.away)};m()};wsc.defaults.Extension.Ignore=function(f){var g={};var h=f.storage.folder("ignore");var a=h.folder("ignored");var m=function(){l();k();f.bind("cmd.ignore",b);f.bind("cmd.unignore",j);f.ui.on("settings.open",g.page)
};g.page=function(o,q){var p=o.settings.page("Ignores");var r={};r.im=g.ignore;r.uim=g.unignore;r.usr=f.ui.umuted;p.item("Text",{ref:"intro",title:"Ignores",text:'Use <code>ignore</code> to ignore people.\n\n                    You can "ignore" other users of the chat server using the\n                    <code>/ignore</code> command. Ignoring a user hides their                    messages from you in the channel log.',});p.item("Form",{ref:"msgs",title:"Messages",text:"Here you can set the messages displayed when you ignore or                    unignore a user.\n\nThe text <code>{user}</code> is replaced                    with the name of the user your are ignoring or unignoring.",fields:[["Textfield",{ref:"ignore",label:"Ignore","default":r.im}],["Textfield",{ref:"unignore",label:"Unignore","default":r.uim}]],event:{save:function(s){g.ignore=s.data.ignore;g.unignore=s.data.unignore;k()}}});var n=p.item("Items",{ref:"ignoreds",title:"Users",text:"This is the list of users that you have silenced.\n\nUse the                    commands <code>/ignore</code> and <code>/unignore</code>                    to edit the list.",items:r.usr,prompt:{title:"Add User",label:"User:",},event:{up:function(s){var u=s.args.swap;
f.ui.umuted[u["this"].index]=u.that.item;f.ui.umuted[u.that.index]=u["this"].item;n.options.items=f.ui.umuted},down:function(s){var u=s.args.swap;f.ui.umuted[u["this"].index]=u.that.item;f.ui.umuted[u.that.index]=u["this"].item;n.options.items=f.ui.umuted},add:function(s){f.mute_user(s.args.item);n.options.items=f.ui.umuted},remove:function(s){f.unmute_user(s.args.item);n.options.items=f.ui.umuted},save:function(s){r.usr=f.ui.umuted;k()},close:function(s){l()}}})};var b=function(q){var s=q.args.split(" ");var n="";var r="";var p=false;for(var o in s){if(!s.hasOwnProperty(o)){continue}n=s[o];tmod=f.mute_user(n);if(!tmod){continue}p=tmod;r=replaceAll(g.ignore,"{user}",n);if(r.indexOf("/me ")==0){r=r.substr(4);f.action(q.target,r)}else{f.say(q.target,r)}}if(p){k()}};var j=function(r){var v=r.args.split(" ");var o="";var u="";var n=-1;var q=false;var s=false;for(var p in v){if(!v.hasOwnProperty(p)){continue}o=v[p];s=f.unmute_user(o);if(!s){continue}q=s;u=replaceAll(g.unignore,"{user}",o);if(u.indexOf("/me ")==0){u=u.substr(4);
f.action(r.target,u)}else{f.say(r.target,u)}}if(q){k()}};var l=function(){g.ignore=h.get("ignore","/me is ignoring {user} now");g.unignore=h.get("unignore","/me is not ignoring {user} anymore");g.count=parseInt(h.get("count",0));var o=null;for(var n in f.ui.umuted){if(!f.ui.umuted.hasOwnProperty(n)){continue}f.unmute_user(f.ui.umuted[n])}f.ui.umuted=[];if(g.count>0){o=null;for(var n=0;n<g.count;n++){f.mute_user(a.get(n,null))}}};var k=function(){h.set("ignore",g.ignore);h.set("unignore",g.unignore);for(var n=0;n<g.count;n++){a.remove(n)}if(f.ui.umuted.length==0){h.set("count",0)}else{var o=-1;for(var n in f.ui.umuted){if(!f.ui.umuted.hasOwnProperty(n)){continue}o++;a.set(o.toString(),f.ui.umuted[n])}o++;g.count=o;h.set("count",o)}};m()};wsc.Client=function(b,g,h){this.mozilla=h;this.storage=new wsc.Storage;this.storage.ui=this.storage.folder("ui");this.storage.aj=this.storage.folder("autojoin");this.storage.aj.channel=this.storage.aj.folder("channel");this.fresh=true;this.attempts=0;this.connected=false;
this.protocol=null;this.flow=null;this.ui=null;this.events=new EventEmitter();this.conn=null;this.channelo={};this.cchannel=null;this.cmds=[];this.settings={domain:"website.com",server:"ws://website.com/wsendpoint",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",true],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",protocol:wsc.Protocol,mparser:wsc.MessageParser,flow:wsc.Flow,ui_object:Chatterbox.UI,extend:[wsc.defaults.Extension],client:"chatclient",clientver:"0.3",ui:{theme:wsc.defaults.theme,themes:wsc.defaults.themes,tabclose:true,clock:true,media:"/static/"},developer:false};this.autojoin={on:true,count:0,channel:[]};this.away={};var a=this;this.exclude=new StringSet();this.hidden=new StringSet();this.settings=Object.extend(this.settings,g);this.config_load();this.config_save();this.mw=new wsc.Middleware();this.ui=new this.settings.ui_object(this,b,{themes:this.settings.ui.themes,theme:this.settings.ui.theme,monitor:this.settings.monitor,username:this.settings.username,domain:this.settings.domain,clock:this.settings.ui.clock,tabclose:this.settings.ui.tabclose,developer:this.settings.developer,media:this.settings.ui.media},h);
this.settings.agent=this.ui.LIB+"/"+this.ui.VERSION+" ("+navigator.appVersion.match(/\(([^)]+)\)/)[1]+") wsc/"+wsc.VERSION+"-r"+wsc.REVISION;this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.protocol=new this.settings.protocol(new this.settings.mparser());this.flow=new this.settings.flow(this.protocol);this.build();for(var f in this.settings.extend){this.settings.extend[f](this)}this.monitor(this.settings.welcome)};wsc.Client.prototype.config_load=function(){this.settings.developer=(this.storage.get("developer",this.settings.developer.toString())=="true");this.settings.ui.theme=this.storage.ui.get("theme",this.settings.ui.theme);this.settings.ui.clock=(this.storage.ui.get("clock",this.settings.ui.clock.toString())=="true");this.settings.ui.tabclose=(this.storage.ui.get("tabclose",this.settings.ui.tabclose.toString())=="true");this.autojoin.on=(this.storage.aj.get("on","true")=="true");this.autojoin.count=parseInt(this.storage.aj.get("count","0"));
this.autojoin.channel=[];var a=null;var f=0;for(var b=0;b<this.autojoin.count;b++){a=this.storage.aj.channel.get(b,null);if(a==null){continue}f++;this.autojoin.channel.push(a)}this.autojoin.count=f};wsc.Client.prototype.config_save=function(){this.storage.set("developer",this.settings.developer);this.storage.ui.set("theme",this.settings.ui.theme);this.storage.ui.set("clock",this.settings.ui.clock.toString());this.storage.ui.set("tabclose",this.settings.ui.tabclose.toString());this.storage.aj.set("on",this.autojoin.on.toString());this.storage.aj.set("count",this.autojoin.count);for(var a=0;a<this.autojoin.count;a++){this.storage.aj.channel.remove(a)}if(this.autojoin.channel.length==0){this.storage.aj.set("count",0)}else{var b=-1;for(var a in this.autojoin.channel){if(!this.autojoin.channel.hasOwnProperty(a)){continue}b++;this.storage.aj.channel.set(b.toString(),this.autojoin.channel[a])}b++;this.storage.aj.set("count",b)}};wsc.Client.prototype.build=function(){this.ui.build();this.create_ns(this.ui.monitoro.raw,this.ui.monitoro.hidden,true);
var a=this;this.ui.on("tab.close.clicked",function(b,f){if(b.chan.monitor){return false}a.part(b.ns);a.remove_ns(b.ns);return false});this.ui.on("title.save",function(b,f){a.set(b.ns,"title",b.value)});this.ui.on("topic.save",function(b,f){a.set(b.ns,"topic",b.value)})};wsc.Client.prototype.loop=function(){this.ui.loop()};wsc.Client.prototype.add_extension=function(a){this.settings.extend.push(a);a(this)};wsc.Client.prototype.bind=function(b,a){this.events.addListener(b,a);if(b.indexOf("cmd.")!=0||b.length<=4){return}cmd=b.slice(4).toLowerCase();this.cmds.push(cmd)};wsc.Client.prototype.clear_listeners=function(a){this.events.removeListeners(a)};wsc.Client.prototype.trigger=function(a,b){return this.events.emit(a,b,this)};wsc.Client.prototype.middle=function(a,b){return this.mw.add(a,b)};wsc.Client.prototype.cascade=function(a,f,b){this.mw.run(a,f,b)};wsc.Client.prototype.connect=function(){if(this.connected){return}this.attempts++;try{var a=this;this.conn=wsc.Transport.Create(this.settings.server);
this.conn.open(function(f,g){a.flow.open(a,f,g)});this.conn.disconnect(function(f){a.flow.close(a,f)});this.conn.message(function(f){a.flow.message(a,f)});this.conn.connect();this.ui.server_message("Opening connection");this.trigger("start",new wsc.Packet("client connecting\ne=ok\n\n"))}catch(b){console.log(b);this.monitor("Your browser does not support WebSockets. Sorry.");this.trigger("start",new wsc.Packet("client connecting\ne=no websockets available\n\n"))}};wsc.Client.prototype.close=function(){console.log(this.conn);this.conn.close()};wsc.Client.prototype.channel=function(a,b){a=this.format_ns(a).toLowerCase();if(!this.channelo[a]){if(b){this.channelo[a]=b;return b}return null}return this.channelo[a]};wsc.Client.prototype.channels=function(b){var a=[];for(ns in this.channelo){if(!this.channelo.hasOwnProperty(ns)){continue}if(this.channelo[ns].hidden){continue}a.push(this.channelo[ns].namespace)}return b?a:a.length};wsc.Client.prototype.each_channel=function(g,a){var f=null;for(var b in this.channelo){if(!this.channelo.hasOwnProperty(b)){continue
}f=this.channelo[b];if(!a){if(this.exclude.contains(f.raw)){continue}}if(g(f.raw,f)===false){break}}};wsc.Client.prototype.deform_ns=function(b){var a=b[0];if(a=="#"||a=="@"||a=="~"||a=="+"){return b}if(b.indexOf("chat:")==0){return"#"+b.slice(5)}if(b.indexOf("server:")==0){return"~"+b.slice(7)}if(b.indexOf("feed:")==0){return"#"+b.slice(5)}if(b.indexOf("login:")==0){return"@"+b.slice(6)}if(b.indexOf("pchat:")==0){var f=b.split(":");f.shift();for(i in f){name=f[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}return"#"+b};wsc.Client.prototype.format_ns=function(a){var f=a.slice(1);switch(a[0]){case"@":var b=[f,this.lun];b.sort(caseInsensitiveSort);b.unshift("pchat");a=b.join(":");break;case"~":a="server:"+f;break;case"+":a="feed:"+f;break;case"#":a="chat:"+f;break;default:if(a.indexOf("chat:")==0||a.indexOf("pchat:")==0||a.indexOf("server:")==0||a.indexOf("feed:")==0){break}a="chat:"+a;break}return a};wsc.Client.prototype.create_ns=function(b,f,a){var g=this.channel(b,new wsc.Channel(this,b,f,a));
this.trigger("ns.create",{name:"ns.create",ns:b,chan:g,client:this});g.build()};wsc.Client.prototype.remove_ns=function(a){if(!a){return}this.cascade("ns.remove",function(b){var f=b.client.channel(b.ns);if(!f){return}delete b.client.channelo[f.raw.toLowerCase()]},{ns:a,client:this})};wsc.Client.prototype.select_ns=function(a){this.cchannel=this.channel(a)||this.cchannel};wsc.Client.prototype.log=function(a,b){var f=this.channel(a);if(!f){return}f.log(b)};wsc.Client.prototype.monitor=function(a){this.ui.monitor(a)};wsc.Client.prototype.mute_user=function(a){return this.ui.mute_user(a)};wsc.Client.prototype.unmute_user=function(a){return this.ui.unmute_user(a)};wsc.Client.prototype.send=function(a){return this.conn.send(a)};wsc.Client.prototype.handshake=function(){this.send(wsc_packetstr(this.settings.client,this.settings.clientver,{agent:this.settings.agent}))};wsc.Client.prototype.login=function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n";this.send(pkt)};wsc.Client.prototype.pong=function(){this.send(wsc_packetstr("pong"))
};wsc.Client.prototype.join=function(a){this.send(wsc_packetstr("join",this.format_ns(a)))};wsc.Client.prototype.part=function(a){this.send(wsc_packetstr("part",this.format_ns(a)))};wsc.Client.prototype.say=function(a,b){var f=this;this.cascade("send.msg",function(g){f.send(wsc_packetstr("send",f.format_ns(g.ns),{},wsc_packetstr("msg","main",{},g.input)))},{input:b,ns:a})};wsc.Client.prototype.npmsg=function(a,b){var f=this;this.cascade("send.npmsg",function(g){f.send(wsc_packetstr("send",f.format_ns(g.ns),{},wsc_packetstr("npmsg","main",{},g.input)))},{input:b,ns:a})};wsc.Client.prototype.action=function(a,b){var f=this;this.cascade("send.action",function(g){f.send(wsc_packetstr("send",f.format_ns(g.ns),{},wsc_packetstr("action","main",{},g.input)))},{input:b,ns:a})};wsc.Client.prototype.promote=function(f,a,b){this.send(wsc_packetstr("send",this.format_ns(f),{},wsc_packetstr("promote",a,{},(!b?"":b))))};wsc.Client.prototype.demote=function(f,a,b){this.send(wsc_packetstr("send",this.format_ns(f),{},wsc_packetstr("demote",a,{},(!b?"":b))))
};wsc.Client.prototype.ban=function(b,a){this.send(wsc_packetstr("send",this.format_ns(b),{},wsc_packetstr("ban",a)))};wsc.Client.prototype.unban=function(b,a){this.send(wsc_packetstr("send",this.format_ns(b),{},wsc_packetstr("unban",a)))};wsc.Client.prototype.kick=function(b,a,f){var g=this;this.cascade("send.kick",function(h){g.send(wsc_packetstr("kick",g.format_ns(h.ns),{u:h.user},h.input||null))},{input:f||"",ns:b,user:a})};wsc.Client.prototype.kill=function(a,b){this.send(wsc_packetstr("kill","login:"+a,{},b||null))};wsc.Client.prototype.admin=function(a,b){this.send(wsc_packetstr("send",this.format_ns(a),{},wsc_packetstr("admin","",{},b)))};wsc.Client.prototype.property=function(a,b){this.send(wsc_packetstr("get",this.format_ns(a),{p:b}))};wsc.Client.prototype.set=function(a,f,b){var g=this;this.cascade("send.set",function(h){g.send(wsc_packetstr("set",g.format_ns(h.ns),{p:h.property},h.input))},{input:b,ns:a,property:f})};wsc.Client.prototype.whois=function(a){this.send(wsc_packetstr("get","login:"+a,{p:"info"}))
};wsc.Client.prototype.disconnect=function(){this.send(wsc_packetstr("disconnect"))};var Chatterbox={};Chatterbox.VERSION="0.19.97";Chatterbox.STATE="beta";Chatterbox.UI=function(b,a,f,h,g){this.client=b;this.events=g||new EventEmitter();this.mozilla=h;this.umuted=[];this.viewing=true;this.settings={themes:["wsct_dAmn","wsct_dark"],theme:"wsct_dark",monitor:["~Monitor",true],username:"",domain:"website.com",clock:true,tabclose:true,developer:false,media:"/static/"};var j=this;this.sound={bank:{m:null},add:function(k,l){if(j.sound.hasOwnProperty(k)){return false}j.sound.bank[k]=l;l.load();j.sound[k]=function(){j.sound.play(j.sound.bank[k])};return true},play:function(k){k.pause();k.currentTime=0;k.play()},toggle:function(l){for(var k in j.sound.bank){if(!j.sound.bank.hasOwnProperty(k)){continue}j.sound.bank[k].muted=l}},mute:function(){j.sound.toggle(true)},unmute:function(){j.sound.toggle(false)},};a.extend(this.settings,f);a.append('<div class="wsc '+this.settings.theme+'"></div>');this.mw=new wsc.Middleware();
this.view=a.find(".wsc");this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.monitoro=null;this.swidth=(function(){if($.browser.msie){var m=$('<textarea cols="10" rows="2"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body"),l=$('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body");scrollbarWidth=m.width()-l.width();m.add(l).remove()}else{var k=$("<div />").css({width:100,height:100,overflow:"auto",position:"absolute",top:-1000,left:-1000}).prependTo("body").append("<div />").find("div").css({width:"100%",height:200});scrollbarWidth=100-k.width();k.parent().remove()}return scrollbarWidth})();this.LIB="Chatterbox";this.VERSION=Chatterbox.VERSION;this.STATE=Chatterbox.STATE};wsc.defaults.UI=Chatterbox.UI;Chatterbox.UI.prototype.trigger=function(a,b){this.events.emit(a,b,this)};Chatterbox.UI.prototype.on=function(b,a){this.events.addListener(b,a)
};Chatterbox.UI.prototype.middle=function(a,b){return this.mw.add(a,b)};Chatterbox.UI.prototype.cascade=function(a,f,b){this.mw.run(a,f,b)};Chatterbox.UI.prototype.remove_listeners=function(){this.events.removeListeners()};Chatterbox.UI.prototype.deform_ns=function(b){var a=b[0];if(a=="#"||a=="@"||a=="~"||a=="+"){return b}if(b.indexOf("chat:")==0){return"#"+b.slice(5)}if(b.indexOf("server:")==0){return"~"+b.slice(7)}if(b.indexOf("feed:")==0){return"#"+b.slice(5)}if(b.indexOf("login:")==0){return"@"+b.slice(6)}if(b.indexOf("pchat:")==0){var f=b.split(":");f.shift();for(i in f){name=f[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}return"#"+b};Chatterbox.UI.prototype.format_ns=function(a){var f=a.slice(1);switch(a[0]){case"@":var b=[f,this.lun];b.sort(caseInsensitiveSort);b.unshift("pchat");a=b.join(":");break;case"~":a="server:"+f;break;case"+":a="feed:"+f;break;case"#":a="chat:"+f;break;default:if(a.indexOf("chat:")==0||a.indexOf("pchat:")==0||a.indexOf("server:")==0||a.indexOf("feed:")==0){break
}a="chat:"+a;break}return a};Chatterbox.UI.prototype.set_events=function(a){this.events=a||this.events};Chatterbox.UI.prototype.clock=function(a){if(a===undefined||a==this.settings.clock){return this.settings.clock}this.settings.clock=a;this.chatbook.retime();return this.settings.clock};Chatterbox.UI.prototype.build=function(j,a,b){this.view.append(Chatterbox.render("ui",this.settings));this.control=new (j||Chatterbox.Control)(this);this.nav=new (a||Chatterbox.Navigation)(this);this.chatbook=new (b||Chatterbox.Chatbook)(this);this.pager=new Chatterbox.Pager(this);this.monitoro=this.chatbook.create_channel(this.mns,this.settings.monitor[1],true);this.monitoro.show();this.control.focus();this.sound.bank.m=this.view.find("div.soundbank");this.sound.add("click",this.sound.bank.m.find("audio.click")[0]);var g=false;var f=this.nav.add_button({label:"",icon:"volume",href:"#mute",title:"Mute the client",handler:function(){if(!g){sound.mute();f.removeClass("volume");f.addClass("volume_mute");f.prop("title","Unmute the client");
g=true;return false}sound.unmute();f.removeClass("volume_mute");f.addClass("volume");f.prop("title","Mute the client");g=false;return false}});var h=this;$(window).focus(function(){h.viewing=true});$(window).blur(function(){h.viewing=false});this.client.bind("pkt",function(l,k){h.packet(l,k)});this.client.middle("ns.remove",function(l,k){h.remove_channel(l.ns);k(l)});this.client.bind("ns.create",function(l,k){h.create_channel(l.chan.raw,l.chan.hidden)});this.client.bind("ns.user.list",function(k){h.channel(k.ns).set_user_list(k.users)});this.client.middle("ns.user.privchg",function(l,k){h.channel(l.ns).privchg(l,k)});this.client.bind("ns.user.remove",function(l,k){h.channel(l.ns).remove_one_user(l.user)});this.client.bind("ns.user.registered",function(k){h.channel(k.ns).register_user(k.user)})};Chatterbox.UI.prototype.resize=function(){this.control.resize();this.view.height(this.view.parent().height());this.nav.resize();this.chatbook.resize(((this.view.parent().height()-this.nav.height())-this.control.height())-5)
};Chatterbox.UI.prototype.loop=function(){this.chatbook.loop()};Chatterbox.UI.prototype.packet=function(b,a){var f=this;var g=a.protocol.log(b);if(g){if(this.settings.developer){console.log(">>>",b.sns,"|",g.text())}if(b.hasOwnProperty("s")&&b.s=="0"){this.chatbook.handle(b,a);return}b.html=g.html();this.cascade("log_message",function(j,h){f.chatbook.log_message(j.message,j.event)},{message:g,event:b})}this.chatbook.handle(b,a)};Chatterbox.UI.prototype.create_channel=function(b,a){this.chatbook.create_channel(b,a)};Chatterbox.UI.prototype.remove_channel=function(a){this.chatbook.remove_channel(a)};Chatterbox.UI.prototype.toggle_channel=function(a){return this.chatbook.toggle_channel(a)};Chatterbox.UI.prototype.channel=function(a,b){return this.chatbook.channel(a,b)};Chatterbox.UI.prototype.channels=function(){return this.chatbook.channels()};Chatterbox.UI.prototype.channel_left=function(){this.chatbook.channel_left()};Chatterbox.UI.prototype.channel_right=function(){this.chatbook.channel_right()
};Chatterbox.UI.prototype.monitor=function(b,a){this.monitoro.server_message(b,a)};Chatterbox.UI.prototype.server_message=function(b,a){this.chatbook.server_message(b,a)};Chatterbox.UI.prototype.log_item=function(a){this.chatbook.log_item(a)};Chatterbox.UI.prototype.log=function(a){this.chatbook.log(a)};Chatterbox.UI.prototype.mute_user=function(a){if(!a){return false}a=a.toLowerCase();if(this.umuted.indexOf(a)!=-1){return false}this.umuted.push(a);this.chatbook.each(function(b,f){f.mute_user(a)});return true};Chatterbox.UI.prototype.unmute_user=function(a){if(!a){return false}a=a.toLowerCase();var b=this.umuted.indexOf(a);if(b==-1){return false}this.umuted.splice(b,1);this.chatbook.each(function(f,g){g.unmute_user(a)});return true};Chatterbox.UI.prototype.clear_user=function(a){this.chatbook.each(function(b,f){f.clear_user(a)})};Chatterbox.UI.prototype.theme=function(a){if(this.settings.theme==a){return this.settings.theme}if(this.settings.themes.indexOf(a)==-1){a="wsct_"+a;if(this.settings.themes.indexOf(a)==-1){return this.settings.theme
}}this.view.removeClass(this.settings.theme).addClass(a);this.settings.theme=a;this.trigger("theme.set",{name:"theme.set",theme:a});return this.settings.theme};Chatterbox.UI.prototype.add_theme=function(a){if(this.settings.themes.indexOf(a)>-1){return}this.settings.themes.push(a)};Chatterbox.UI.prototype.developer=function(a){this.settings.developer=a;this.chatbook.developer()};Chatterbox.BaseTab=function(g,b,f,a){this.manager=g;this.hidden=f;this.monitor=(a==undefined?false:a);this.built=false;this.raw=b;this.selector="t-"+(b||"chan").toLowerCase();this.namespace=b;this.visible=false;this.st=0;this.el={t:{o:null,l:null,c:null,},m:null,l:{p:null,w:null,},u:null,h:{title:null,topic:null}};this.mulw=0;this.d={u:[0,0],h:{title:[0,0],topic:[0,0]}};if(!g){return}this.raw=g.format_ns(b);this.selector=(this.raw.substr(0,2)=="pc"?"pc":"c")+"-"+g.deform_ns(b).slice(1).toLowerCase();this.namespace=g.deform_ns(b)};Chatterbox.BaseTab.prototype.build=function(b){if(!this.manager){return}if(this.built){return
}var a=this.selector;var g=this.namespace;var f=this.raw;this.el.t.o=this.manager.nav.add_tab(a,g);this.el.t.l=this.el.t.o.find(".tab");this.el.t.c=this.el.t.o.find(".close");this.manager.chatbook.view.append(b||Chatterbox.render("basetab",{selector:a,ns:g}));this.el.m=this.window=this.manager.chatbook.view.find("#"+a+"-window");var h=this;this.el.t.l.click(function(){h.manager.toggle_channel(f);return false});this.el.t.c.click(function(j){h.manager.trigger("tab.close.clicked",{ns:h.raw,chan:h,e:j});return false});if(this.hidden&&!this.manager.settings.developer){this.el.t.o.toggleClass("hidden")}this.built=true};Chatterbox.BaseTab.prototype.hide=function(){this.el.m.css({display:"none"});this.el.t.o.removeClass("active");this.visible=false};Chatterbox.BaseTab.prototype.show=function(){this.visible=true;this.el.m.css({display:"block"});this.el.t.o.addClass("active");this.el.t.o.removeClass("noise chatting tabbed fill");var a=this;setTimeout(function(){a.el.l.w.scrollTop(a.el.l.w.prop("scrollHeight")-a.el.l.w.innerHeight());
a.resize();a.el.l.w.scrollTop(a.el.l.w.prop("scrollHeight")-a.el.l.w.innerHeight())},100)};Chatterbox.BaseTab.prototype.developer=function(){if(this.manager.settings.developer){this.el.t.o.removeClass("hidden");return}if(this.hidden){this.el.t.o.addClass("hidden")}};Chatterbox.BaseTab.prototype.remove=function(){this.el.t.o.remove();this.el.m.remove()};Chatterbox.BaseTab.prototype.resize=function(b,a){this.el.m.css({height:a||this.manager.chatbook.height(),width:(b||this.manager.chatbook.width())-10})};Chatterbox.BaseTab.prototype.loop=function(){};Chatterbox.Channel=function(g,b,f,a){Chatterbox.BaseTab.call(this,g,b,f,a)};Chatterbox.Channel.prototype=new Chatterbox.BaseTab;Chatterbox.Channel.prototype.constructor=Chatterbox.Channel;Chatterbox.Channel.prototype.build=function(){if(!this.manager){return}if(this.built){return}var a=this.selector;var f=this.namespace;var b=this.raw;Chatterbox.BaseTab.prototype.build.call(this,Chatterbox.render("channel",{selector:a,ns:f}));this.el.l.p=this.el.m.find("#"+a+"-log");
this.el.l.w=this.el.l.p.find("ul.logwrap");this.el.u=this.el.m.find("#"+a+"-users");this.mulw=parseInt(this.el.u.css("max-width").slice(0,-2));var g=this;var h=false;this.el.l.w.click(function(){if(!h){return}g.manager.control.focus()});this.el.l.w.mousedown(function(){h=true});this.el.l.w.mousemove(function(){h=false});this.el.t.l.click(function(){g.manager.toggle_channel(b);return false});this.setup_header("title");this.setup_header("topic");if(this.namespace[0]=="@"){this.build_user_list({100:"Room Members"},[100])}this.built=true};Chatterbox.Channel.prototype.setup_header=function(a){var f=this;var b={};b.m=this.el.m.find("header."+a+" div");b.e=this.el.m.find("header."+a+" a[href=#edit]");b.t=this.el.m.find("header."+a+" textarea");b.s=this.el.m.find("header."+a+" a[href=#save]");b.c=this.el.m.find("header."+a+" a[href=#cancel]");this.el.h[a]=b.m;b.m.parent().mouseover(function(h){if(!b.editing){b.e.css("display","block");return}b.s.css("display","block");b.c.css("display","block")
});b.m.parent().mouseout(function(h){if(!b.editing){b.e.css("display","none");return}b.s.css("display","none");b.c.css("display","none")});b.e.click(function(h){b.t.text(f.manager.client.channel(f.namespace).info[a].content);b.t.css({display:"block",width:f.el.h[a].innerWidth()-10,});f.el.h[a].css("display","none");b.e.css("display","none");b.editing=true;f.resize();return false});var g=function(){var h=b.t.val();b.t.text("");b.t.css("display","none");f.el.h[a].css("display","block");b.s.css("display","none");b.c.css("display","none");b.editing=false;f.resize();return h};b.s.click(function(h){var j=g();f.manager.trigger(a+".save",{ns:f.raw,value:j});b.t.text("");return false});b.c.click(function(h){g();return false})};Chatterbox.Channel.prototype.scroll=function(){this.pad();var a=this.el.l.w.prop("scrollWidth")-this.el.l.w.innerWidth();var b=this.el.l.w.prop("scrollHeight")-this.el.l.w.innerHeight();if(a>0){b+=a}if(b<0||(b-this.el.l.w.scrollTop())>100){return}this.el.l.w.scrollTop(b)};
Chatterbox.Channel.prototype.pad=function(){this.el.l.w.css({"padding-top":0,height:"auto"});var b=this.el.l.w.innerHeight();var a=this.el.l.p.innerHeight()-this.el.h.topic.parent().outerHeight();var f=a-b;if(f>0){this.el.l.w.css({"padding-top":f})}else{this.el.l.w.css({"padding-top":0,height:a})}this.el.l.w.scrollTop(this.st)};Chatterbox.Channel.prototype.resize=function(j,a){Chatterbox.BaseTab.prototype.resize.call(this,j,a);var k={title:{m:this.el.m.find("header div.title"),e:this.el.m.find("header.title a[href=#edit]")},topic:{m:this.el.m.find("header div.topic"),e:this.el.m.find("header.topic a[href=#edit]")}};this.el.l.w.css({"padding-top":0});a=a||this.manager.chatbook.height();j=j||this.manager.chatbook.width();var f=a;var b=this.el.m.width();this.el.u.width(1);this.d.u[0]=this.el.u[0].scrollWidth+this.manager.swidth+5;if(this.d.u[0]>this.mulw){this.d.u[0]=this.mulw}this.el.u.width(this.d.u[0]);b=b-this.d.u[0];f=f-k.title.m.parent().outerHeight();this.el.l.p.css({height:f-3,width:b-10});
this.scroll();this.d.u[1]=this.el.l.p.innerHeight();this.el.u.css({height:this.d.u[1]});for(var h in k){if(!k.hasOwnProperty(h)){continue}if(k[h].m.html().length==0){continue}var g=(k[h].m.outerHeight(true)-5)*(-1);k[h].e.css("top",g)}};Chatterbox.Channel.prototype.loop=function(){var a=this.el.l.p.find(".logmsg");if(a.length<200){return}a.slice(0,a.length-200).remove();this.resize()};Chatterbox.Channel.prototype.log=function(b){var a=this;this.manager.cascade("log",function(f){a.log_item({html:Chatterbox.render("logmsg",{message:f.message})})},{ns:this.raw,sns:this.namespace,message:b})};Chatterbox.Channel.prototype.log_item=function(f){var a=new Date();var b="";if(this.manager.settings.clock){b=formatTime("{HH}:{mm}:{ss}",a)}else{b=formatTime("{hh}:{mm}:{ss} {mr}",a)}var g=this;this.manager.cascade("log_item",function(h){if(g.visible){g.st=g.el.l.w.scrollTop()}g.el.l.w.append(Chatterbox.render("logitem",h));g.manager.trigger("log_item.after",{item:g.el.l.w.find("li").last(),chan:g});if(g.visible){g.st+=g.el.l.w.find("li.logmsg").last().height();
g.el.l.w.scrollTop(g.st)}g.scroll();g.noise()},{ns:this.namespace,ts:b,ms:a.getTime(),message:f.html,user:(f.user||"system").toLowerCase()})};Chatterbox.Channel.prototype.retime=function(){var a="";var b=this.el.l.w;if(this.manager.settings.clock){a="{HH}:{mm}:{ss}"}else{a="{hh}:{mm}:{ss} {mr}"}b.find("span.ts").each(function(f,g){el=b.find(g);time=new Date(parseInt(el.prop("id")));el.text(formatTime(a,time))})};Chatterbox.Channel.prototype.server_message=function(f,b){var a=this;this.manager.cascade("server_message",function(g){a.log_item({html:Chatterbox.render("servermsg",{message:g.message,info:g.info})})},{ns:this.namespace,message:f,info:b})};Chatterbox.Channel.prototype.clear=function(){this.el.l.p.find("li.logmsg").remove();this.el.l.p.find("li.loginfo").remove();this.el.l.w.height(0);this.resize()};Chatterbox.Channel.prototype.log_info=function(h,g){var k={ns:this.namespace,ref:h,content:g};this.manager.trigger("log_info.before",k);delete k.ns;var a=this.el.l.w.append(Chatterbox.render("loginfobox",k));
this.scroll();var j=this;var f=this.el.l.w.find("li."+k.ref);f.find("a.close").click(function(b){j.el.l.w.find(this).parent().remove();j.resize();return false});this.scroll();return f};Chatterbox.Channel.prototype.log_whois=function(m){var h={avatar:'<a href="#"><img height="50" width="50" alt="avatar"/></a>',username:"<b>"+m.symbol+m.username+"</b>",info:[],conns:[],raw:m,};for(var n in m.connections){var l=m.connections[n];var p=[];if(l.online){var a=(new Date-(l.online*1000));p.push(["online",DateStamp(a/1000)+formatTime(" [{HH}:{mm}:{ss}]",new Date(a))])}if(l.idle){p.push(["idle",timeLengthString(l.idle)])}if(l.agent){p.push(["agent",l.agent])}if(l.debug){p.push(["debug",l.debug])}p.push(["chatrooms",l.channels.join(" ")]);h.conns.push(p)}this.manager.trigger("log_whois.before",h);var b="";for(var n in h.conns){var k=h.conns[n];var r='<section class="conn"><p><em>connection '+((parseInt(n)+1).toString())+":</em></p>";r+="<ul>";for(var q in k){r+="<li><strong>"+k[q][0]+":</strong> "+k[q][1]+"</li>"
}r+="</ul>";b+=r+"</section>"}var j="";for(var n in h.info){j+="<li>"+h.info[n]+"</li>"}var o=this.log_info("whois-"+m.username,Chatterbox.render("whoiswrap",{avatar:h.avatar,info:Chatterbox.render("whoisinfo",{username:h.username,info:j,connections:b})}));var g=o.find("div.avatar");var f=o.find("div.info");f.width(o.find(".whoiswrap").width()-100);g.height(o.height()-10);this.scroll()};Chatterbox.Channel.prototype.log_pc=function(g,h){contents="";for(var f in h){if(!h.hasOwnProperty(f)){continue}var b=h[f];var a="";if(b[2].length==0){a="<em>"+(g?"default privileges":"no members")+"</em>"}else{a=b[2]}contents+=String.format("<li><em>{0}</em> <strong>{1}</strong>:<ul><li>{2}</li></ul></li>",[b[1],b[0],a])}var j={title:"Privilege class "+(g?"permissions":"members"),info:"<ul>"+contents+"</ul>"};this.log_info("pc-"+(g?"permissions":"members"),Chatterbox.render("pcinfo",j))};Chatterbox.Channel.prototype.set_header=function(a,g,j,f){a=a.toLowerCase();var b=this.el.m.find("header."+a+" a[href=#edit]");
if(this.el.h[a].html()!=""){if(g.html().length!=0){this.server_message(a+" set by "+j)}}this.el.h[a].html(g.html());var h=this;setTimeout(function(){if(g.text().length>0){h.el.h[a].css({display:"block"});var k=(h.el.h[a].outerHeight(true)-5)*(-1);b.css("top",k)}else{h.el.h[a].css({display:"none"})}h.resize()},100)};Chatterbox.Channel.prototype.get_header=function(a){return this.el.h[a.toLowerCase()]};Chatterbox.Channel.prototype.build_user_list=function(g,a){var j=this.el.m.find("div.chatusers");var f="";var h=null;j.html("");for(var b in a){var f=g[a[b]];j.append('<div class="pc" id="'+replaceAll(f," ","-")+'"><h3>'+f+"</h3><ul></ul>");h=j.find(".pc#"+f);h.css("display","none")}};Chatterbox.Channel.prototype.reveal_user_list=function(){var h=this.el.m.find("div.chatusers");var f=0;var b=0;var a=null;h.find("div.pc").each(function(j,k){a=h.find(this);b=a.find("ul li").length;f+=b;a.css("display",(b==0?"none":"block"))});h.css("display",(f==0?"none":"block"));var g=this;setTimeout(function(){g.resize()
},100)};Chatterbox.Channel.prototype.set_user_list=function(g){if(Object.size(g)==0){return}var f=this.el.m.find("div.chatusers");var a=null;for(var b in g){a=g[b];this.set_user(a,true)}this.reveal_user_list()};Chatterbox.Channel.prototype.set_user=function(h,f){var k=this.el.m.find("div.chatusers div.pc#"+replaceAll(h.pc," ","-"));var a=k.find("ul");var b=h.conn==1?"":"["+h.conn+"]";var j='<li><a target="_blank" id="'+h.name+'" href="http://'+h.name+"."+this.manager.settings.domain+'"><em>'+h.symbol+"</em>"+h.name+"</a>"+b+"</li>";if(a.find("a#"+h.name).length==1){return}if(a.find("li").length==0){a.append(j)}else{var l=h.name.toLowerCase();var n=null;var g=false;a.find("li a").each(function(){if(g){return}n=a.find(this);if(l<n.prop("id").toLowerCase()){n.parent().before(j);g=true}});if(!g){a.append(j)}}var m=this;this.manager.cascade("user.hover",function(o){m.userinfo(o)},h.hover);f=f||false;if(!(f)){this.reveal_user_list()}};Chatterbox.Channel.prototype.remove_user=function(a,b){this.el.m.find("div.chatusers div.pc ul li a#"+a).parent().remove();
b=b||false;if(!(b)){this.reveal_user_list()}};Chatterbox.Channel.prototype.remove_one_user=function(a){this.remove_user(a,true);var b=this.manager.client.channel(this.namespace).info.members[a];if(!b){this.reveal_user_list();return}this.set_user(b)};Chatterbox.Channel.prototype.privchg=function(b,a){this.remove_user(b.user,true);var f=this.manager.client.channel(this.namespace).info.members[b.user];if(!f){this.reveal_user_list();a(b);return}f=Object.extend(f,{});f.pc=b.pc;this.set_user(f);a(b)};Chatterbox.Channel.prototype.register_user=function(a){this.remove_user(a,true);var b=this.manager.client.channel(this.namespace).info.members[a];if(!b){this.reveal_user_list();return}this.set_user(b)};Chatterbox.Channel.prototype.highlight=function(a){var b=this;this.manager.cascade("highlight",function(k,f){var g=b.el.t.o;var j=k.message;if(j!==false){(j||b.el.l.w.find(".logmsg").last()).addClass("highlight")}if(g.hasClass("active")){if(!b.manager.viewing){b.manager.sound.click()}return}if(!b.hidden){b.manager.sound.click()
}if(g.hasClass("tabbed")){return}if(g.hasClass("chatting")){g.removeClass("chatting")}var l=0;g.addClass("tabbed");function h(){l++;g.toggleClass("fill");if(l==6){return}setTimeout(h,1000)}h()},{c:b,message:a})};Chatterbox.Channel.prototype.noise=function(){var b="";var a=0;var g=this.el.m.find(".logmsg").last();for(var f in this.manager.umuted){if(!this.manager.umuted.hasOwnProperty(f)){continue}if(g.hasClass("u-"+this.manager.umuted[f])){g.css({display:"none"});this.scroll();return}}if(!this.el.t.o.hasClass("active")){this.el.t.o.addClass("noise");if(!this.el.t.o.hasClass("tabbed")){if(g.find(".cevent").length==0){this.el.t.o.addClass("chatting")}}}};Chatterbox.Channel.prototype.userinfo=function(b){var h=this.el.m.find("a#"+b.name);if(h.length==0){return}var j=this;var g=null;var a=function(l){var k="";for(index in b.info){k+="<li>"+b.info[index]+"</li>"}j.window.append(Chatterbox.render("userinfo",{username:b.name,avatar:b.avatar,link:b.link,info:k}));g=j.window.find(".userinfo#"+b.name);
j.window.find("div.userinfo:not('#"+b.name+"')").remove();var m=h.offset();g.css({top:(m.top-h.height())+10,left:(m.left-(g.width()))-6});g.find(".info").height(g.height());g.hover(function(){g.data("hover",1)},function(n){g.data("hover",0);j.unhover_user(g,n)});g.data("hover",0)};var f=function(k){h.data("hover",0);j.unhover_user(g,k)};h.off("mouseenter",a);h.off("mouseleave",f);h.on("mouseenter",a);h.on("mouseleave",f)};Chatterbox.Channel.prototype.unhover_user=function(g,f){var h=g.offset();var b=g.outerHeight(true)+h.top;var k=g.outerWidth(true)+h.left;var a=f.pageX;var j=f.pageY;if(a>h.left&&a<k&&j>h.top&&j<b){return}if(a<(k+15)&&a>h.left&&j>h.top&&j<(h.top+15)){return}g.remove()};Chatterbox.Channel.prototype.mute_user=function(a){if(!a){return}this.el.l.w.find("li.logmsg.u-"+a.toLowerCase()).css({display:"none"});this.scroll()};Chatterbox.Channel.prototype.unmute_user=function(a){if(!a){return}this.el.l.w.find("li.logmsg.u-"+a.toLowerCase()).css({display:"list-item"});this.scroll()
};Chatterbox.Channel.prototype.clear_user=function(a){if(!a){return}this.el.l.w.find("li.logmsg.u-"+a.toLowerCase()).remove();this.scroll()};Chatterbox.Channel.prototype.pkt_join=function(b,a){if(b.e!="ok"){return}this.set_header("title",(new wsc.MessageString("")),"","");this.set_header("topic",(new wsc.MessageString("")),"","")};Chatterbox.Channel.prototype.pkt_recv_msg=function(b,a){var f=this;this.manager.cascade("chan.recv_msg",function(j,g){var h=f.manager.client.settings.username.toLowerCase();if(h==j.user.toLowerCase()){return}var l=j.message.toLowerCase();var k=l.indexOf(h)!=-1;if(!k&&j.sns[0]!="@"){return}if(k){f.highlight()}else{f.highlight(false)}f.trigger("pkt.recv_msg.highlighted",j)},b)};Chatterbox.Channel.prototype.pkt_property=function(b,a){var g=b.pkt.arg.p;var f=a.channel(this.namespace);switch(g){case"title":case"topic":this.set_header(g,b.value||(new wsc.MessageString("")),b.by,b.ts);break;case"privclasses":this.build_user_list(f.info.pc,f.info.pc_order.slice(0));break;
case"members":break;default:break}};Chatterbox.Chatbook=function(a){this.manager=a;this.view=this.manager.view.find("div.chatbook");this.chan={};this.trail=[];this.current=null;this.manager.on("tab.close.clicked",function(b,f){f.chatbook.remove_channel(b.ns)})};Chatterbox.Chatbook.prototype.height=function(){return this.view.height()};Chatterbox.Chatbook.prototype.width=function(){return this.view.width()};Chatterbox.Chatbook.prototype.resize=function(b){b=b||600;var f=this.view.innerWidth();for(var a in this.chan){if(!this.chan.hasOwnProperty(a)){continue}var g=this.chan[a];g.resize(f,b)}};Chatterbox.Chatbook.prototype.loop=function(){for(select in this.chan){this.chan[select].loop()}};Chatterbox.Chatbook.prototype.channel=function(a,b){a=this.manager.format_ns(a).toLowerCase();if(!this.chan[a]&&b){this.chan[a]=b}return this.chan[a]};Chatterbox.Chatbook.prototype.channels=function(){chans=-1;for(ns in this.chan){if(this.chan[ns].hidden){continue}chans++}return chans};Chatterbox.Chatbook.prototype.create_channel=function(b,f,a){var g=this.channel(b,this.channel_object(b,f,a));
g.build();if(this.trail.indexOf(g.namespace)==-1){this.trail.push(g.namespace)}if(!g.visible){this.toggle_channel(b)}this.manager.resize();return g};Chatterbox.Chatbook.prototype.create_feed=function(f,b,a,h){var g=this.channel(f,this.feed_object(f,b,a,h));g.build();if(this.trail.indexOf(g.namespace)==-1){this.trail.push(g.namespace)}if(!g.visible){this.toggle_channel(f)}this.manager.resize();return g};Chatterbox.Chatbook.prototype.channel_object=function(a){return new Chatterbox.Channel(this.manager,a)};Chatterbox.Chatbook.prototype.feed_object=function(f,b,a,g){return new Chatterbox.Feed(this.manager,f,b,a,g)};Chatterbox.Chatbook.prototype.toggle_channel=function(a){var f=this.channel(a);var b=f;if(!f){return}if(f.hidden){if(this.current&&this.current==f){return}if(!this.manager.settings.developer){f.hide();return}}if(this.current){if(this.current==f){return}this.current.hide();b=this.current}else{if(this.manager.monitoro!==null){this.manager.monitoro.hide()}}f.show();this.manager.control.focus();
this.current=f;this.manager.resize();this.manager.control.cache_input(b,f);this.manager.trigger("channel.selected",{ns:f.raw,chan:f,prev:b});this.manager.client.select_ns(f.raw)};Chatterbox.Chatbook.prototype.remove_channel=function(a){var b=this.channel(a);if(this.channels()==0&&!b.hidden){return}b.remove();delete this.chan[b.raw.toLowerCase()];if(this.current==b){this.channel_left()}var f=this.trail.indexOf(b.namespace);this.trail.splice(f,1)};Chatterbox.Chatbook.prototype.channel_left=function(){var b=this.current.namespace;var a=this.trail.indexOf(b);if(a<0){return}var g=null;while(true){try{g=this.channel(this.trail[--a])}catch(f){a=this.trail.length-1;g=this.channel(this.trail[a])}if(!g.hidden){break}if(this.manager.settings.developer){break}}this.toggle_channel(g.namespace)};Chatterbox.Chatbook.prototype.channel_right=function(){var b=this.current.namespace;var a=this.trail.indexOf(b);if(a==-1){return}var g=null;while(true){try{g=this.channel(this.trail[++a])}catch(f){a=0;g=this.channel(this.trail[0])
}if(!g.hidden){break}if(this.manager.settings.developer){break}}this.toggle_channel(g.namespace)};Chatterbox.Chatbook.prototype.each=function(f){var b=null;for(var a in this.chan){if(!this.chan.hasOwnProperty(a)){continue}b=this.chan[a];if(f(b.namespace,b)===false){break}}};Chatterbox.Chatbook.prototype.server_message=function(b,a){for(ns in this.chan){this.chan[ns].server_message(b,a)}};Chatterbox.Chatbook.prototype.log_item=function(a){for(ns in this.chan){this.chan[ns].log_item(a)}};Chatterbox.Chatbook.prototype.log=function(a){for(ns in this.chan){this.chan[ns].log(a)}};Chatterbox.Chatbook.prototype.log_message=function(f,b){try{if(!f.global){if(!f.monitor){this.channel(b.ns).log_item(b)}else{this.manager.monitoro.log_item(b)}}else{this.log_item(b)}}catch(a){try{this.ui.monitoro.server_message("Failed to log for",b.sns,b.html)}catch(a){console.log(">> Failed to log message for",b.sns,"::");console.log(">>",b.html)}}};Chatterbox.Chatbook.prototype.retime=function(){for(ns in this.chan){this.chan[ns].retime()
}};Chatterbox.Chatbook.prototype.developer=function(){this.each(function(a,b){b.developer()})};Chatterbox.Chatbook.prototype.handle=function(g,b){var h=this.manager;var j=this.channel(g.ns);if(!j){return}var a="pkt_"+g.name;try{j[a](g,b)}catch(f){}};Chatterbox.Control=function(b){this.manager=b;this.manager.view.append(Chatterbox.template.control);this.view=this.manager.view.find("div.chatcontrol");this.ml=false;this.history={};this.tab={hit:false,cache:"",matched:[],index:-1,type:0,prefix:["","/",""],};this.el={form:this.view.find("form.msg"),i:{s:this.view.find("form.msg input.msg"),m:this.view.find("form.msg textarea.msg"),c:null,t:this.view.find("ul.buttons a[href~=#multiline].button")},brow:{m:this.view.find("div.brow"),b:this.view.find("div.brow ul.buttons"),s:this.view.find("div.brow ul.states")}};this.el.i.c=this.el.i.s;var a=this;this.el.i.t.click(function(f){a.multiline(!a.multiline());return false});this.el.i.s.keydown(function(f){return a.keypress(f)});this.el.i.m.keydown(function(f){return a.keypress(f)
});this.el.form.submit(function(f){return a.submit(f)});this.add_button({label:"<b>b</b>",icon:false,href:"#bold",title:"Bold text",handler:function(){a.surroundtext(a.el.i.c[0],"<b>","</b>")}});this.add_button({label:"<i>i</i>",icon:false,href:"#italic",title:"Italic text",handler:function(){a.surroundtext(a.el.i.c[0],"<i>","</i>")}});this.add_button({label:"<u>u</u>",icon:false,href:"#underline",title:"Underline text",handler:function(){a.surroundtext(a.el.i.c[0],"<u>","</u>")}});this.add_button({label:"<sup>sup</sup>",icon:false,href:"#sup",title:"Superscript",handler:function(){a.surroundtext(a.el.i.c[0],"<sup>","</sup>")}});this.add_button({label:"<sub>sub</sub>",icon:false,href:"#sub",title:"Subscript",handler:function(){a.surroundtext(a.el.i.c[0],"<sub>","</sub>")}})};Chatterbox.Control.prototype.surroundtext=function(k,j,b){var h=k.scrollTop;var a=k.value,f=k.selectionStart,g=k.selectionEnd;var l=k.value.substring(f,g);k.value=a.substring(0,f)+j+l+b+a.substring(g);k.selectionStart=f+j.length;
k.selectionEnd=f+j.length+l.length;k.scrollTop=h;k.focus()};Chatterbox.Control.prototype.focus=function(){this.el.i.c.focus()};Chatterbox.Control.prototype.resize=function(){w=this.manager.view.width();this.view.css({width:"100%"});this.el.form.css({width:this.manager.view.width()-20});this.el.i.s.css({width:this.manager.view.width()-100});this.el.i.m.css({width:this.manager.view.width()-90})};Chatterbox.Control.prototype.height=function(){var a=this.view.outerHeight();return a};Chatterbox.Control.prototype.multiline=function(a){if(a==undefined||this.ml==a){return this.ml}this.ml=a;var b=(this.ml?"s":"m");a=(this.ml?"m":"s");this.el.i[b].css("display","none");this.el.i[a].css("display","inline-block");this.el.i.c=this.el.i[a];this.manager.resize();return this.ml};Chatterbox.Control.prototype.add_button=function(a){a=Object.extend({label:"New",icon:false,href:"#button",title:"Button.",handler:function(){}},(a||{}));if(a.icon!==false){a.icon=" iconic "+a.icon}else{a.icon=" text"}this.el.brow.b.append(Chatterbox.render("brow_button",a));
var b=this.el.brow.b.find("a[href="+a.href+"].button");b.click(function(f){a.handler();return false});return b};Chatterbox.Control.prototype.add_state=function(a){a=Object.extend({ref:"state",label:"some state"},(a||{}));var b=this.el.brow.s.find("li#"+a.ref);if(b.length==0){this.el.brow.s.append(Chatterbox.render("brow_state",a));return this.el.brow.s.find("li#"+a.ref)}b.html(a.label);return b};Chatterbox.Control.prototype.rem_state=function(a){return this.el.brow.s.find("li#"+a).remove()};Chatterbox.Control.prototype.chomp=function(){var f=this.el.i.c.val();var b=f.lastIndexOf(" ");if(b==-1){this.el.i.c.val("");return f}var a=f.slice(b+1);this.el.i.c.val(f.slice(0,b));if(a.length==0){return this.chomp()}return a};Chatterbox.Control.prototype.unchomp=function(a){var b=this.el.i.c.val();if(!b){this.el.i.c.val(a)}else{this.el.i.c.val(b+" "+a)}};Chatterbox.Control.prototype.get_text=function(a){if(a==undefined){return this.el.i.c.val()}this.el.i.c.val(a||"");return this.el.i.c.val()};Chatterbox.Control.prototype.set_text=function(a){this.el.i.c.val(a||"")
};Chatterbox.Control.prototype.cache_input=function(b,f){var a=this.get_history(b.namespace);if(a.index>-1){return}a.tmp=this.get_text();this.set_text(this.get_history(f.namespace).tmp)};Chatterbox.Control.prototype.get_history=function(a){if(!a){if(!this.manager.chatbook.current){a="~monitor"}}a=a||this.manager.chatbook.current.namespace;if(!this.history[a]){this.history[a]={index:-1,list:[],tmp:""}}return this.history[a]};Chatterbox.Control.prototype.append_history=function(b){if(!b){return}var a=this.get_history();a.list.unshift(b);a.index=-1;if(a.list.length>100){a.list.pop()}};Chatterbox.Control.prototype.scroll_history=function(a){var f=this.get_history();var b=this.get_text();if(f.index==-1){if(b){f.tmp=b}else{f.list[f.index]=b}}if(a){if(f.list.length>0&&f.index<(f.list.length-1)){f.index++}}else{if(f.index>-1){f.index--}}this.set_text(f.list[f.index]||f.tmp)};Chatterbox.Control.prototype.tab_item=function(b){if(!this.tab.hit){this.start_tab(b)}this.chomp();this.tab.index++;if(this.tab.index>=this.tab.matched.length){this.tab.index=-1
}if(this.tab.index==-1){this.unchomp(this.tab.prefix[this.tab.type]+this.tab.cache);return}var a=this.get_text()==""?(this.tab.type==0?": ":" "):"";this.unchomp(this.tab.prefix[this.tab.type]+this.tab.matched[this.tab.index]+a)};Chatterbox.Control.prototype.start_tab=function(f){this.tab.hit=true;this.tab.index=-1;this.tab.matched=[];this.tab.type=0;var j=this.chomp();this.unchomp(j);if(j[0]=="/"||j[0]=="#"||j[0]=="@"){this.tab.type=j[0]=="/"?1:2;if(j[0]=="/"){j=j.slice(1)}}else{this.tab.type=0}this.tab.cache=j;j=j.toLowerCase();this.tab.matched=[];if(this.tab.type==0){var k=this.manager.client.channel(this.manager.chatbook.current.namespace);for(var a in k.info.members){if(a.toLowerCase().indexOf(j)==0){this.tab.matched.push(a)}}}else{if(this.tab.type==1){var h="";for(var b in this.manager.client.cmds){h=this.manager.client.cmds[b];if(h.indexOf(j)==0){this.tab.matched.push(h)}}}else{if(this.tab.type==2){var g=this;this.manager.client.each_channel(function(l,m){if(m.namespace.toLowerCase().indexOf(j)==0){g.tab.matched.push(m.namespace)
}})}}}};Chatterbox.Control.prototype.end_tab=function(a){this.tab.hit=false;this.tab.matched=[];this.tab.cache="";this.tab.index=-1};Chatterbox.Control.prototype.submit=function(a){var b=this.get_text();this.append_history(b);this.set_text("");this.handle(a,b);return false};Chatterbox.Control.prototype.keypress=function(f){var b=f.which||f.keyCode;var g=this.tab.hit;var a=false;switch(b){case 13:if(!this.multiline()){this.submit(f)}else{if(f.shiftKey){this.submit(f)}else{a=true}}break;case 38:if(!this.multiline()){this.scroll_history(true);break}a=true;break;case 40:if(!this.multiline()){this.scroll_history(false);break}a=true;break;case 9:if(f.shiftKey){this.manager.channel_right()}else{this.tab_item(f);g=false}break;case 219:if(f.ctrlKey){this.manager.channel_left()}else{a=true}break;case 221:if(f.ctrlKey){this.manager.channel_right()}else{a=true}break;default:a=true;break}if(g){this.end_tab(f)}return a};Chatterbox.Control.prototype.handle=function(b,h){if(h==""){return}if(!this.manager.chatbook.current){return
}var l=false;if(h[0]!="/"){l=true}h=(b.shiftKey?"/npmsg ":(h[0]=="/"?"":"/say "))+h;h=h.slice(1);var m=h.split(" ");var f=m.shift().toLowerCase();var k=this.manager.chatbook.current.namespace;var j=k;if(!l&&m[0]){var g=m[0][0];if((g=="#"||g=="@")&&m[0].length>1){j=this.manager.format_ns(m.shift())}}var n=m.join(" ");var a=this.manager.client.trigger("cmd."+f,{name:"cmd",cmd:f,args:n,target:j,ns:k});if(a==0){this.manager.pager.notice({ref:"cmd-fail",heading:"Command failed",content:'"'+f+'" is not a command.'},false,5000)}};Chatterbox.Feed=function(g,b,a,f){Chatterbox.BaseTab.call(this,g,b);this.name=this.namespace.substr(1);this.type=a;this.description=f||""};Chatterbox.Feed.prototype=new Chatterbox.BaseTab;Chatterbox.Feed.prototype.constructor=Chatterbox.Feed;Chatterbox.Feed.prototype.build=function(){if(!this.manager){return}if(this.built){return}var a=this.selector;var f=this.namespace;var b=this.raw;Chatterbox.BaseTab.prototype.build.call(this,Chatterbox.render("feed",{selector:a,type:"quiet",name:this.name,info:this.description,}));
this.el.l.p=this.el.m.find("#"+a+"-log");this.el.l.w=this.el.l.p.find("ul.logwrap");this.el.u=this.el.m.find("#"+a+"-users");this.mulw=parseInt(this.el.u.css("max-width").slice(0,-2));this.built=true};Chatterbox.Feed.prototype.resize=function(b,a){Chatterbox.BaseTab.prototype.resize.call(this,b,a)};Chatterbox.Feed.prototype.add_item=function(b){b=Object.extend({ref:"item0001",icon:"",title:"Feed Item 0001",content:"<p>This is a feed item</p>"},b);var f=Chatterbox.render("feedmsg",b);this.el.l.w.prepend(f);var a=this.el.l.w.find("li#"+b.ref);return a};Chatterbox.Navigation=function(a){this.manager=a;this.showclose=this.manager.settings.tabclose;this.settings={};this.settings.open=false;this.el={n:this.manager.view.find("nav.tabs"),tw:this.manager.view.find("nav.tabs div.tabwrap"),t:this.manager.view.find("nav.tabs #chattabs"),b:this.manager.view.find("nav.tabs #tabnav"),l:this.manager.view.find("nav.tabs #tabnav .arrow_left"),r:this.manager.view.find("nav.tabs #tabnav .arrow_right"),s:this.manager.view.find("nav.tabs #tabnav #settings-button"),};
if(!this.showclose){if(!this.el.t.hasClass("hc")){this.el.t.addClass("hc")}}var b=this;this.el.s.click(function(h){if(b.settings.open){return false}var f={e:h,settings:new Chatterbox.Settings.Config(b.manager)};b.configure_page(f);b.manager.trigger("settings.open",f);b.manager.trigger("settings.open.ran",f);var g=f.settings.page("About");g.item("text",{ref:"about-chatterbox",wclass:"centered faint",text:'Using <a href="http://github.com/photofroggy/wsc/">Chatterbox</a> version '+Chatterbox.VERSION+" "+Chatterbox.STATE+' by ~<a href="http://photofroggy.deviantart.com/">photofroggy</a>.'});b.settings.window=new Chatterbox.Settings(b.manager,f.settings);b.settings.window.build();b.settings.open=true;return false});this.el.l.click(function(){b.manager.channel_left();return false});this.el.r.click(function(){b.manager.channel_right();return false})};Chatterbox.Navigation.prototype.configure_page=function(b){var g=this.manager;var f=b.settings.page("Main");var h={};h.theme=replaceAll(g.settings.theme,"wsct_","");
h.clock=g.clock();h.tc=g.nav.closer();var a=[];for(i in g.settings.themes){name=replaceAll(g.settings.themes[i],"wsct_","");a.push({value:name,title:name,selected:h.theme==name})}f.item("Form",{ref:"ui",title:"UI",hint:"<b>Timestamp</b><br/>Choose between a 24 hour clock and                a 12 hour clock.\n\n<b>Theme</b><br/>Change the look of the                client.\n\n<b>Close Buttons</b><br/>Turn tab close buttons on/off.",fields:[["Dropdown",{ref:"theme",label:"Theme",items:a}],["Dropdown",{ref:"clock",label:"Timestamp Format",items:[{value:"24",title:"24 hour",selected:h.clock},{value:"12",title:"12 hour",selected:!h.clock}]}],["Checkbox",{ref:"tabclose",label:"Close Buttons",items:[{value:"yes",title:"On",selected:h.tc}]}],],event:{change:function(j){g.clock(j.data.clock=="24");g.theme(j.data.theme);g.nav.closer(j.data.tabclose.indexOf("yes")>-1)},save:function(j){h.clock=g.clock();h.theme=replaceAll(g.theme(),"wsct_","");h.tc=g.nav.closer();g.trigger("settings.save.ui",{clock:h.clock,tabclose:h.tc,theme:"wsct_"+h.theme})
},close:function(j){g.clock(h.clock);g.theme(h.theme);g.nav.closer(h.tc)}}})};Chatterbox.Navigation.prototype.height=function(){var a=this.el.n.outerHeight();return a};Chatterbox.Navigation.prototype.add_button=function(a){a=Object.extend({label:"New",icon:false,href:"#button",title:"Button.",handler:function(){}},(a||{}));if(a.icon!==false){a.icon=" iconic "+a.icon}else{a.icon=" text"}this.el.b.prepend(Chatterbox.render("nav_button",a));var b=this.el.b.find("a[href="+a.href+"].button");b.click(function(f){a.handler();return false});this.resize();return b};Chatterbox.Navigation.prototype.add_tab=function(a,b){this.el.t.append(Chatterbox.render("tab",{selector:a,ns:b}));return this.el.t.find("#"+a+"-tab")};Chatterbox.Navigation.prototype.resize=function(){this.el.tw.width(this.el.n.width()-this.el.b.outerWidth()-20);if(this.settings.open){this.settings.window.resize()}};Chatterbox.Navigation.prototype.closer=function(a){if(a==undefined||a==this.showclose){return this.showclose}this.showclose=a;
if(this.showclose){if(!this.el.t.hasClass("hc")){return}this.el.t.removeClass("hc");return}if(this.el.t.hasClass("hc")){return}this.el.t.addClass("hc")};Chatterbox.Pager=function(a){this.manager=a;this.lifespan=20000;this.halflife=5000;this.el={m:null,click:null};this.sound={click:function(){},};this.notices=[];this.build()};Chatterbox.Pager.prototype.build=function(){this.el.m=this.manager.view.find("div.pager")};Chatterbox.Pager.prototype.notice=function(g,m,l,f){var j={frame:null,close:null,foot:null,b:{},options:Object.extend({ref:"notice",icon:"",heading:"Some notice",content:"Notice content goes here."},(g||{})),onclose:function(){},ondestroy:function(){}};j.options.ref+="-"+(new Date()).valueOf();j.options.content=j.options.content.split("\n").join("</p><p>");this.notices.push(j);this.el.m.append(Chatterbox.render("pager.notice",j.options));j.frame=this.el.m.find("#"+j.options.ref).last();j.close=j.frame.find("a.close_notice");j.foot=j.frame.find("footer.buttons");var h={};for(var a in j.options.buttons){if(!j.options.buttons.hasOwnProperty(a)){continue
}h=j.options.buttons[a];j.foot.append(Chatterbox.render("pager.button",h));j.b[a]=j.foot.find("a#"+h.ref);j.b[a].click(h.click)}var k=this;j.close.click(function(){j.onclose();k.remove_notice(j);return false});if(!m){if(!l){l=k.lifespan}setTimeout(function(){k.remove_notice(j,true)},l)}if(f!==true){this.manager.sound.click()}return j};Chatterbox.Pager.prototype.remove_notice=function(a,f){var b=this;if(this.notices.indexOf(a)==-1){return false}a.frame.fadeTo((f?this.halflife:300),0).slideUp(function(){a.frame.remove();b.notices.splice(b.notices.indexOf(a),1);a.ondestroy()});if(f){a.frame.mouseenter(function(){if(b.notices.indexOf(a)==-1){return}a.frame.stop(true);a.frame.slideDown(function(){a.frame.fadeTo(300,1);a.frame.mouseleave(function(){setTimeout(function(){b.remove_notice(a,true)},b.lifespan)})})})}};Chatterbox.Pager.prototype.find_notice=function(a){for(var b in this.notices){if(this.notices[b].options.ref==a){return this.notices[b]}}return null};Chatterbox.Popup=function(b,a){this.manager=b;
this.pview=(this.manager||{view:{find:function(){}}}).view;this.window=null;this.closeb=null;this.options=Object.extend({ref:"popup",title:"Popup",close:true,content:""},(a||{}))};Chatterbox.Popup.prototype.build=function(){var b=this.options;if(this.options.close){b.title+='<a href="#close" class="close iconic x"></a>'}this.pview.append(Chatterbox.render("popup",b));this.window=this.pview.find(".floater."+b.ref);if(this.options.close){this.closeb=this.window.find("a.close");var a=this;this.closeb.click(function(f){a.close();return false})}};Chatterbox.Popup.prototype.close=function(){this.window.remove()};Chatterbox.Popup.Prompt=function(b,a){a=a||{};a=Object.extend({position:[0,0],ref:"prompt",title:"Input",close:false,label:"","default":"","submit-button":"Submit",event:{submit:function(){},cancel:function(){}}},a);Chatterbox.Popup.call(this,b,a);this.data=this.options["default"]};Chatterbox.Popup.Prompt.prototype=new Chatterbox.Popup();Chatterbox.Popup.Prompt.prototype.constructor=Chatterbox.Popup.Prompt;
Chatterbox.Popup.Prompt.prototype.build=function(){this.options.content=Chatterbox.template.prompt.main;Chatterbox.Popup.prototype.build.call(this);this.window.css({left:this.options.position[0],top:this.options.position[1]});var a=this;this.window.find(".button.close").click(function(){a.options.event.cancel(a);a.close();return false});this.window.find(".button.submit").click(function(){a.data=a.window.find("input").val();a.options.event.submit(a);a.close();return false});this.window.find("form").submit(function(){a.data=a.window.find("input").val();a.options.event.submit(a);a.close();return false})};Chatterbox.Popup.ItemPicker=function(b,a){a=a||{};a=Object.extend({position:[100,60],ref:"item-picker",title:"Items",event:{select:function(f){}}},a);Chatterbox.Popup.call(this,b,a);this.pview=this.pview.find(".chatbook");this.data=this.options["default"];this.pages=[];this.cpage=null};Chatterbox.Popup.ItemPicker.prototype=new Chatterbox.Popup();Chatterbox.Popup.ItemPicker.prototype.constructor=Chatterbox.Popup.ItemPicker;
Chatterbox.Popup.ItemPicker.prototype.build=function(){this.options.content=Chatterbox.render("ip.main",{});Chatterbox.Popup.prototype.build.call(this);this.window.css({right:this.options.position[0],bottom:this.options.position[1]});this.closeb.removeClass("medium");this.pbook=this.window.find("section.pages");this.tabs=this.window.find("section.tabs ul");this.buttons=this.window.find("section.buttons");var f=this;var b=null;for(var a in this.pages){if(!this.pages.hasOwnProperty(a)){continue}b=this.pages[a];b.build();if(a==0){this.select_page(b)}}};Chatterbox.Popup.ItemPicker.prototype.refresh=function(){if(this.cpage==null){return}else{this.cpage.refresh()}};Chatterbox.Popup.ItemPicker.prototype.page=function(b,a){b=b.toLowerCase();for(var f in this.pages){if(!this.pages.hasOwnProperty(f)){continue}if(this.pages[f].name.toLowerCase()==b){return this.pages[f]}}return(a||null)};Chatterbox.Popup.ItemPicker.prototype.add_page=function(a,b){this.pages.push(new (b||Chatterbox.Popup.ItemPicker.Page)(this,a))
};Chatterbox.Popup.ItemPicker.prototype.add_button=function(a){a=Object.extend({href:"#button",title:"Button",label:"Button"},(a||{}));this.buttons.append(Chatterbox.render("ip.button",a));return this.buttons.find("a[href="+a.href+"]")};Chatterbox.Popup.ItemPicker.prototype.select=function(a){this.options.event.select(a)};Chatterbox.Popup.ItemPicker.prototype.select_page=function(a){if(!a){return}if(this.cpage!=null){this.cpage.hide()}this.cpage=a||null;if(this.cpage!=null){this.cpage.show()}};Chatterbox.Popup.ItemPicker.Page=function(b,a){this.picker=b;this.options=Object.extend({ref:"page",href:"#page",label:"Page",title:"page",items:[],content:"<em>No items on this page.</em>",},(a||{}));this.name=this.options.label;this.nrefresh=true};Chatterbox.Popup.ItemPicker.Page.prototype.build=function(){this.picker.pbook.append(Chatterbox.render("ip.page",this.options));this.picker.tabs.append(Chatterbox.render("ip.tab",this.options));this.view=this.picker.pbook.find("div.page#"+this.options.ref);
this.items=this.view.find("ul");this.tab=this.picker.tabs.find("#"+this.options.ref);this.refresh();var a=this;this.tab.find("a").click(function(){a.picker.select_page(a);return false})};Chatterbox.Popup.ItemPicker.Page.prototype.refresh=function(){var a=this.build_list();if(a.length==0){this.options.content="<em>No items on this page.</em>"}else{this.options.content="<ul>"+a+"</ul>"}this.view.html(this.options.content);this.items=this.view.find("ul");this.hook_events();this.nrefresh=false};Chatterbox.Popup.ItemPicker.Page.prototype.hook_events=function(){var a=this;this.items.find("li").each(function(b,g){var h=a.view.find(g);var f=h.find(".value").html();h.click(function(){a.picker.select(f)})})};Chatterbox.Popup.ItemPicker.Page.prototype.build_list=function(){var f=[];var g=null;var j,h,b;for(var a in this.options.items){if(!this.options.items.hasOwnProperty(a)){continue}g=this.options.items[a];h=g.value||g;j=g.title||h;b=g.html||false;f.push('<li class="item" title="'+j+'">            <span class="hicon"><i class="iconic check"></i></span>            '+(b?h:'<span class="value">'+h+"</span>")+"            </li>")
}return f.join("")};Chatterbox.Popup.ItemPicker.Page.prototype.show=function(){this.tab.addClass("selected");this.view.css("display","block");this.refresh()};Chatterbox.Popup.ItemPicker.Page.prototype.hide=function(){this.tab.removeClass("selected");this.view.css("display","none")};Chatterbox.Settings=function(b,a){Chatterbox.Popup.call(this,b,{ref:"settings",title:"Settings",close:false,content:""});this.config=a;this.saveb=null;this.scb=null;this.tabs=null;this.book=null;this.changed=false;this.manager=b};Chatterbox.Settings.prototype=new Chatterbox.Popup();Chatterbox.Settings.prototype.constructor=Chatterbox.Settings;Chatterbox.Settings.prototype.build=function(){this.options.content=Chatterbox.template.settings.main;Chatterbox.Popup.prototype.build.call(this);this.saveb=this.window.find("a.button.save");this.closeb=this.window.find("a.close");this.scb=this.window.find("a.button.saveclose");this.tabs=this.window.find("nav.tabs ul.tabs");this.book=this.window.find("div.book");this.config.build(this.manager,this);
this.window.find("ul.tabs li").first().addClass("active");this.window.find("div.book div.page").first().addClass("active");var a=this;this.window.find("form").bind("change",function(){a.changed=true});this.config.each_page(function(b,f){f.each_item(function(g,h){h._onchange=function(j){a.changed=true}})});this.saveb.click(function(b){a.save();return false});this.closeb.click(function(b){if(a.changed){if(!confirm("Are you sure? You will lose any unsaved changes.")){return false}}a.close();return false});this.scb.click(function(b){a.save();a.close();return false});this.resize()};Chatterbox.Settings.prototype.resize=function(){var a=this.window.find(".inner");var f=a.find("h2");var g=a.find(".bookwrap");var b=a.find("footer");g.height(a.height()-b.outerHeight()-f.outerHeight()-15);this.book.height(g.innerHeight()-this.tabs.outerHeight()-25);this.book.width(g.innerWidth()-20);this.config.resize()};Chatterbox.Settings.prototype.switch_page=function(b){var f=this.tabs.find("li.active").first();
var a=f.prop("id").split("-",1)[0];f=this.config.page(a.split("_").join(" "));f.hide();b.show()};Chatterbox.Settings.prototype.save=function(){this.config.save(this);this.changed=false;this.manager.trigger("settings.save",{config:this.config})};Chatterbox.Settings.prototype.close=function(){this.window.remove();this.manager.nav.settings.open=false;this.manager.nav.settings.window=null;this.config.close(this);this.manager.trigger("settings.close",{config:this.config})};Chatterbox.Settings.Config=function(a){this.manager=a||null;this.pages=[]};Chatterbox.Settings.Config.prototype.find_page=function(b){var g=b.toLowerCase();var f;for(var a in this.pages){f=this.pages[a];if(f.lname==g){return f}}return null};Chatterbox.Settings.Config.prototype.build=function(f,b){f=f||this.manager;for(var a in this.pages){this.pages[a].build(f,b)}};Chatterbox.Settings.Config.prototype.resize=function(){for(var a in this.pages){this.pages[a].resize()}};Chatterbox.Settings.Config.prototype.page=function(b,a){var f=this.find_page(b);
a=a||true;if(f==null){f=new Chatterbox.Settings.Page(b,this.manager);if(a){this.pages.push(f)}else{this.pages.unshift(f)}}return f};Chatterbox.Settings.Config.prototype.each_page=function(g){var f=null;var a=null;for(var b in this.pages){if(!this.pages.hasOwnProperty(b)){continue}f=this.pages[b];a=g(b,f);if(a===false){break}}};Chatterbox.Settings.Config.prototype.save=function(b){for(var a in this.pages){this.pages[a].save(b)}};Chatterbox.Settings.Config.prototype.close=function(b){for(var a in this.pages){this.pages[a].close(b)}};Chatterbox.Settings.Page=function(a,b){this.name=a;this.lname=a.toLowerCase();this.ref=replaceAll(this.lname," ","_");this.items=[];this.itemo={};this.manager=b};Chatterbox.Settings.Page.prototype.build=function(g,b){var a=replaceAll(Chatterbox.template.settings.tab,"{ref}",this.ref);a=replaceAll(a,"{name}",this.name);var f=replaceAll(Chatterbox.template.settings.page,"{ref}",this.ref);f=replaceAll(f,"{page-name}",this.name);b.tabs.append(a);b.book.append(f);this.view=b.book.find("div#"+this.ref+"-page");
this.tab=b.tabs.find("li#"+this.ref+"-tab");var f=this;this.tab.find("a").click(function(h){if(f.tab.hasClass("active")){return false}b.switch_page(f);return false});this.content()};Chatterbox.Settings.Page.prototype.content=function(){for(var a in this.items){this.items[a].build(this.view)}};Chatterbox.Settings.Page.prototype.resize=function(){for(var a in this.items){this.items[a].resize()}};Chatterbox.Settings.Page.prototype.show=function(){if(!this.tab.hasClass("active")){this.tab.addClass("active")}if(!this.view.hasClass("active")){this.view.addClass("active")}this.resize()};Chatterbox.Settings.Page.prototype.hide=function(){if(this.tab.hasClass("active")){this.tab.removeClass("active")}if(this.view.hasClass("active")){this.view.removeClass("active")}};Chatterbox.Settings.Page.prototype.item=function(f,b,a){a=a||false;var g=Chatterbox.Settings.Item.get(f,b,this.manager);if(a){this.items.unshift(g)}else{this.items.push(g)}if(b.hasOwnProperty("ref")){this.itemo[b.ref]=g}return g};Chatterbox.Settings.Page.prototype.get=function(a){if(this.itemo.hasOwnProperty(a)){return this.itemo[a]
}return null};Chatterbox.Settings.Page.prototype.each_item=function(g){var f=null;var a=null;for(var b in this.items){if(!this.items.hasOwnProperty(b)){continue}f=this.items[b];a=g(b,f);if(a===false){break}}};Chatterbox.Settings.Page.prototype.save=function(b){for(var a in this.items){this.items[a].save(b,this)}};Chatterbox.Settings.Page.prototype.close=function(b){for(var a in this.items){this.items[a].close(b,this)}};Chatterbox.Settings.Item=function(b,a,f){this.manager=f||null;this.options=a||{};this.type=b||"base";this.selector=this.type.toLowerCase();this.items=[];this.itemo={};this.view=null;this.val=null;this._onchange=this._event_stub};Chatterbox.Settings.Item.prototype.build=function(k){if(!this.options.hasOwnProperty("ref")){return}var j=this.content();if(j.length==0){return}var a="";if(this.options.hasOwnProperty("wclass")){a=" "+this.options.wclass}var h=Chatterbox.render("settings.item.wrap",{type:this.type.toLowerCase().split(".").join("-"),ref:this.options.ref,"class":a});
h=replaceAll(h,"{content}",j);k.append(h);this.view=k.find(".item."+this.options.ref);this.hooks(this.view);if(!this.options.hasOwnProperty("subitems")){return}var l;var g;var f;var b;for(i in this.options.subitems){l=this.options.subitems[i];g=l[0];f=l[1];sitem=Chatterbox.Settings.Item.get(g,f);b=["stacked"];if(sitem.options.wclass){b.push(sitem.options.wclass)}sitem.options.wclass=b.join(" ");sitem.build(this.view);this.items.push(sitem);if(f.hasOwnProperty("ref")){this.itemo[f.ref]=sitem}}};Chatterbox.Settings.Item.prototype.content=function(){return Chatterbox.render("settings.item."+this.selector,this.options)};Chatterbox.Settings.Item.prototype.resize=function(){for(var a in this.items){this.items[a].resize()}};Chatterbox.Settings.Item.prototype.hooks=function(f){if(!this.options.hasOwnProperty("event")){return}var b=this.options.event;var h=Chatterbox.template.settings.item.get(this.selector);if(h==false){return}if(!h.hasOwnProperty("events")){return}var g=[];for(var a in h.events){g=h.events[a];
if(!b.hasOwnProperty(g[0])){continue}f.find(g[1]).bind(g[0],b[g[0]])}};Chatterbox.Settings.Item.prototype._event_stub=function(){};Chatterbox.Settings.Item.prototype._get_cb=function(a){if(!this.options.hasOwnProperty("event")){return this._event_stub}return this.options.event[a]||this._event_stub};Chatterbox.Settings.Item.prototype._get_ep=function(b){var g=Chatterbox.template.settings.item.get(this.selector);if(g==null){return false}if(!g.hasOwnProperty("events")){return false}var f=[];for(var a in g.events){f=g.events[a];if(f[0]==b){return f}}};Chatterbox.Settings.Item.prototype.save=function(g,h){var j=this._get_ep("inspect");var b=j?this.view.find(j[1]):null;var a=this._get_cb("save");if(typeof a=="function"){a({input:b,item:this,page:h,window:g})}else{for(var f in a){var k=b.hasOwnProperty("slice")?b.slice(f,1):b;a[f]({input:k,item:this,page:h,window:g})}}for(var f in this.items){this.items[f].save(g,h)}};Chatterbox.Settings.Item.prototype.close=function(g,h){var j=this._get_ep("inspect");
var b=j?this.view.find(j[1]):null;var a=this._get_cb("close");if(typeof a=="function"){a({input:b,item:this,page:h,window:g});return}for(var f in a){var k=b.hasOwnProperty("slice")?b.slice(f,1):b;a[f]({input:k,item:this,page:h,window:g})}for(var f in this.items){this.items[f].close(g,h)}};Chatterbox.Settings.Item.get=function(h,m,j,b,a){var g=h.split(".");var k=b||Chatterbox.Settings.Item;var l;for(var f in g){l=g[f];if(!k.hasOwnProperty(l)){k=a||Chatterbox.Settings.Item;break}k=k[l]}return new k(h,m,j)};Chatterbox.Settings.Item.Form=function(b,a){Chatterbox.Settings.Item.call(this,b,a);this.form=null;this.fields=[];this.lsection=null;this.fsection=null;this.fieldo={}};Chatterbox.Settings.Item.Form.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Form.prototype.constructor=Chatterbox.Settings.Item.Form;Chatterbox.Settings.Item.Form.field=function(b,a){return Chatterbox.Settings.Item.get(b,a,this.manager,Chatterbox.Settings.Item.Form,Chatterbox.Settings.Item.Form.Field)};
Chatterbox.Settings.Item.Form.prototype.build=function(h){Chatterbox.Settings.Item.prototype.build.call(this,h);if(this.view==null){return}this.lsection=this.view.find("section.labels");this.fsection=this.view.find("section.fields");if(!this.options.hasOwnProperty("fields")){return}var g;var j;for(var a in this.options.fields){g=this.options.fields[a];j=Chatterbox.Settings.Item.Form.field(g[0],g[1]);this.fields.push(j);j.build(this);if(g[1].hasOwnProperty("ref")){this.fieldo[g[1].ref]=j}}this.form=this.view.find("form");var b=this;this.form.bind("change",function(f){b.change()})};Chatterbox.Settings.Item.Form.prototype.resize=function(){for(var a in this.fields){this.fields[a].resize()}};Chatterbox.Settings.Item.Form.prototype.change=function(){var f={};var g;for(var b in this.fields){g=this.fields[b];f[g.ref]=g.get()}var a=this._get_cb("change");if(typeof a=="function"){a({data:f,form:this})}else{for(var b in a){a[b]({data:f,form:this})}}};Chatterbox.Settings.Item.Form.prototype.save=function(g,j){var h={};
var b;for(var f in this.fields){field=this.fields[f];h[field.ref]=field.get()}var a=this._get_cb("save");if(typeof a=="function"){a({data:h,form:this,page:j,window:g})}else{for(var f in a){a[f]({data:h,form:this,page:j,window:g})}}};Chatterbox.Settings.Item.Form.prototype.close=function(f,h){var g={};var j;for(var b in this.fields){j=this.fields[b];g[j.ref]=j.get()}var a=this._get_cb("close");if(typeof a=="function"){a({data:g,form:this,page:h,window:f})}else{for(var b in a){a[b]({data:g,form:this,page:h,window:f})}}};Chatterbox.Settings.Item.Form.Field=function(b,a){Chatterbox.Settings.Item.call(this,b,a);this.ref=this.options.ref||"ref";this.label=null;this.field=null;this.value=""};Chatterbox.Settings.Item.Form.Field.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Form.Field.prototype.constructor=Chatterbox.Settings.Item.Form.Field;Chatterbox.Settings.Item.Form.Field.prototype.build=function(a){a.lsection.append(Chatterbox.render("settings.item.form.label",{ref:this.ref,label:this.options.label||"","class":(this.options["class"]?" "+this.options["class"]:"")}));
this.label=a.lsection.find("label."+this.ref);this.lwrap=a.lsection.find("."+this.ref+".label");a.fsection.append(Chatterbox.render("settings.item.form.field.wrap",{ref:this.ref,field:Chatterbox.render("settings.item.form.field."+this.selector,this.options)}));this.fwrap=a.fsection.find("div."+this.ref+".field");this.field=this.fwrap.find("."+this.ref);this.view=this.fwrap;var b=this;this.value=this.field.val();this.field.bind("change",function(f){b.value=b.view.find(this).val()})};Chatterbox.Settings.Item.Form.Field.prototype.resize=function(){this.lwrap.height(this.field.height())};Chatterbox.Settings.Item.Form.Field.prototype.get=function(){return this.value};Chatterbox.Settings.Item.Form.Radio=function(b,a){a=a||{};a["class"]=(a["class"]?(a["class"]+" "):"")+"box";Chatterbox.Settings.Item.Form.Field.call(this,b,a);this.items={};this.value=""};Chatterbox.Settings.Item.Form.Radio.prototype=new Chatterbox.Settings.Item.Form.Field();Chatterbox.Settings.Item.Form.Radio.prototype.constructor=Chatterbox.Settings.Item.Form.Radio;
Chatterbox.Settings.Item.Form.Radio.prototype.build=function(f){f.lsection.append(Chatterbox.render("settings.item.form.label",{ref:this.ref,label:this.options.label||""}));this.label=f.lsection.find("label."+this.ref);this.lwrap=f.lsection.find("."+this.ref+".label");if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.ref;this.items[b.ref]=""}}f.fsection.append(Chatterbox.render("settings.item.form.field.wrap",{ref:this.ref,field:Chatterbox.render("settings.item.form.field.radio",this.options)}));this.fwrap=f.fsection.find("div."+this.ref+".field");this.field=this.fwrap.find("input:radio");this.value=this.fwrap.find("input[checked]:radio").val();var a=this;this.field.bind("change",function(g){a.value=a.fwrap.find(this).val()})};Chatterbox.Settings.Item.Form.Radio.prototype.resize=function(){this.lwrap.height(this.fwrap.find(".radiobox").height())};Chatterbox.Settings.Item.Form.Radio.prototype.get=function(){return this.value};Chatterbox.Settings.Item.Form.Checkbox=function(b,a){Chatterbox.Settings.Item.Form.Radio.call(this,b,a);
this.value=[]};Chatterbox.Settings.Item.Form.Checkbox.prototype=new Chatterbox.Settings.Item.Form.Radio();Chatterbox.Settings.Item.Form.Checkbox.prototype.constructor=Chatterbox.Settings.Item.Form.Checkbox;Chatterbox.Settings.Item.Form.Checkbox.prototype.build=function(f){f.lsection.append(Chatterbox.render("settings.item.form.label",{ref:this.ref,label:this.options.label||""}));this.label=f.lsection.find("label."+this.ref);this.lwrap=f.lsection.find("."+this.ref+".label");if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.ref;this.items[b.ref]=""}}f.fsection.append(Chatterbox.render("settings.item.form.field.wrap",{ref:this.ref,field:Chatterbox.render("settings.item.form.field.checkbox",this.options)}));this.fwrap=f.fsection.find("div."+this.ref+".field");this.field=this.fwrap.find("input:checkbox");var a=this;this.value=[];this.fwrap.find("input[checked]:checkbox").each(function(){a.value.push(a.fwrap.find(this).val())});this.field.bind("change",function(g){a.value=[];
a.fwrap.find("input[checked]:checkbox").each(function(){a.value.push(a.fwrap.find(this).val())})})};Chatterbox.Settings.Item.Form.Checkbox.prototype.resize=function(){this.lwrap.height(this.fwrap.find(".checkbox").height())};Chatterbox.Settings.Item.Form.Colour=function(b,a){Chatterbox.Settings.Item.Form.Field.call(this,b,a)};Chatterbox.Settings.Item.Form.Colour.prototype=new Chatterbox.Settings.Item.Form.Field();Chatterbox.Settings.Item.Form.Colour.prototype.constructor=Chatterbox.Settings.Item.Form.Colour;Chatterbox.Settings.Item.Form.Colour.prototype.build=function(a){Chatterbox.Settings.Item.Form.Field.prototype.build.call(this,a);this.resize()};Chatterbox.Settings.Item.Form.Colour.prototype.resize=function(){this.lwrap.height(this.fwrap.height())};Chatterbox.Settings.Item.Radio=function(b,a){Chatterbox.Settings.Item.call(this,b,a);this.value=""};Chatterbox.Settings.Item.Radio.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Radio.prototype.constructor=Chatterbox.Settings.Item.Radio;
Chatterbox.Settings.Item.Radio.prototype.build=function(f){if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.options.ref||"ref"}}Chatterbox.Settings.Item.prototype.build.call(this,f);this.field=this.view.find("input:radio");this.value=this.view.find("input[checked]:radio").val();var a=this;this.field.bind("change",function(g){a.value=a.view.find(this).val()})};Chatterbox.Settings.Item.Checkbox=function(b,a){Chatterbox.Settings.Item.Radio.call(this,b,a);this.value=[]};Chatterbox.Settings.Item.Checkbox.prototype=new Chatterbox.Settings.Item.Radio();Chatterbox.Settings.Item.Checkbox.prototype.constructor=Chatterbox.Settings.Item.Checkbox;Chatterbox.Settings.Item.Checkbox.prototype.build=function(f){if(this.options.hasOwnProperty("items")){for(i in this.options.items){var b=this.options.items[i];b.name=this.options.ref||"ref"}}Chatterbox.Settings.Item.prototype.build.call(this,f);this.field=this.view.find("input:checkbox");var a=this;
this.value=[];this.view.find("input[checked]:checkbox").each(function(){a.value.push(a.view.find(this).val())});this.field.bind("change",function(g){a.value=[];a.view.find("input[checked]:checkbox").each(function(){a.value.push(a.view.find(this).val())})})};Chatterbox.Settings.Item.Items=function(b,a,f){a=Object.extend({prompt:{title:"Add Item",label:"Item:","submit-button":"Add"}},(a||{}));Chatterbox.Settings.Item.call(this,b,a,f);this.selected=false};Chatterbox.Settings.Item.Items.prototype=new Chatterbox.Settings.Item();Chatterbox.Settings.Item.Items.prototype.constructor=Chatterbox.Settings.Item.Items;Chatterbox.Settings.Item.Items.prototype.build=function(b){Chatterbox.Settings.Item.prototype.build.call(this,b);var a=this;this.list=this.view.find("ul");this.buttons=this.view.find("section.buttons p");var f=this.list.find("li");f.click(function(h){var g=a.list.find(this);a.list.find("li.selected").removeClass("selected");a.selected=g.find(".item").html();g.addClass("selected")});f.each(function(g,j){var h=a.list.find(j);
h.find("a.close").click(function(k){a.list.find("li.selected").removeClass("selected");a.selected=h.find(".item").html();h.addClass("selected");a.remove_item();return false})});this.buttons.find("a.button.up").click(function(g){a.shift_item(true);return false});this.buttons.find("a.button.down").click(function(g){a.shift_item();return false});this.buttons.find("a.button.add").click(function(g){var h=new Chatterbox.Popup.Prompt(a.manager,{position:[g.clientX-100,g.clientY-50],title:a.options.prompt.title,label:a.options.prompt.label,"submit-button":a.options.prompt["submit-button"],event:{submit:function(j){var l=j.data;if(!l){j.options.event.cancel(j);return}l=l.toLowerCase();var k=a.options.items.indexOf(l);if(k!=-1){j.options.event.cancel(j);return}a._fevent("add",{item:l});a.refresh();a._onchange({})},cancel:function(j){a._fevent("cancel",{});a.refresh();a._onchange({})}}});h.build();return false});this.buttons.find("a.button.close").click(function(g){a.remove_item();return false})};
Chatterbox.Settings.Item.Items.prototype.shift_item=function(b){if(this.selected===false){return}var f=this.options.items.indexOf(this.selected);var a=f+1;if(b){a=f-1}if(f==-1||f>=this.options.items.length){return}if(a<0||a>=this.options.items.length){return}this._fevent((b?"up":"down"),{swap:{"this":{index:f,item:this.options.items[f]},that:{index:a,item:this.options.items[a]}}});this.refresh();this._onchange({});return};Chatterbox.Settings.Item.Items.prototype.remove_item=function(){if(this.selected===false){return false}var a=this.options.items.indexOf(this.selected);if(a==-1||a>=this.options.items.length){return}this._fevent("remove",{index:a,item:this.selected});this.selected=false;this.refresh();this._onchange({})};Chatterbox.Settings.Item.Items.prototype.refresh=function(){this.view.find("section.mitems").html(Chatterbox.template.settings.krender.manageditems(this.options.items));this.list=this.view.find("ul");this.list.find("li[title="+(this.selected||"").toLowerCase()+"]").addClass("selected");
var a=this;var b=this.list.find("li");b.click(function(g){var f=a.list.find(this);a.list.find("li.selected").removeClass("selected");a.selected=f.find(".item").html();f.addClass("selected")});b.each(function(f,h){var g=a.list.find(h);g.find("a.close").click(function(j){a.list.find("li.selected").removeClass("selected");a.selected=g.find(".item").html();g.addClass("selected");a.remove_item();return false})})};Chatterbox.Settings.Item.Items.prototype._fevent=function(b,g){var j=this._get_ep("inspect");var f=j?this.view.find(j[1]):null;var a=this._get_cb(b);if(typeof a=="function"){a({input:f,item:this,args:g})}else{for(var h in a){var k=f.hasOwnProperty("slice")?f.slice(h,1):f;a[h]({input:k,item:this,args:g})}}};Chatterbox.Settings.Item.Items.prototype.save=function(){this._fevent("save",{items:this.options.items||[]})};Chatterbox.template={};Chatterbox.render=function(l,n,a,b){var h=b||Chatterbox.template;var j={};var k=null;var f=null;if(a!==undefined&&a===true){h=l}else{var m=l.split(".");
for(var g in m){f=m[g];if(!h.hasOwnProperty(f)){return""}h=h[f]}}if(h.hasOwnProperty("frame")){k=h;j=h.render||{};h=h.frame;if(k.hasOwnProperty("pre")){if(typeof k.pre=="function"){h=k.pre(h,n)}else{for(i in k.pre){h=k.pre[i](h,n)}}}}for(key in n){h=replaceAll(h,"{"+key+"}",(j[key]||Chatterbox.template.render_stub)(n[key]||""))}if(k!=null){if(k.hasOwnProperty("post")){if(typeof k.post=="function"){h=k.post(h,n)}else{for(i in k.post){h=k.post[i](h,n)}}}}return h};Chatterbox.template.render_stub=function(a){return a};Chatterbox.template.clean=function(a){return function(b,f){for(i in a){b=replaceAll(b,"{"+a[i]+"}","")}return b}};Chatterbox.template.ui='<div class="soundbank">            <audio class="click">                <source src="{media}click.ogg" type="audio/ogg">                <source src="{media}click.mp3" type="audio/mpeg">            </audio>        </div>        <div class="pager">        </div>        <nav class="tabs"><div class="tabwrap"><ul id="chattabs" class="tabs"></ul></div>        <ul id="tabnav">            <li><a href="#left" class="button iconic arrow_left"></a></li>            <li><a href="#right" class="button iconic arrow_right"></a></li>            <li><a href="#settings" title="Change client settings" class="button iconic cog" id="settings-button"></a></li>        </ul>        </nav>        <div class="chatbook"></div>';
Chatterbox.template.control='<div class="chatcontrol">            <div class="brow">                <ul class="buttons">                    <li><a href="#multiline" title="Toggle multiline input" class="button iconic list"></a></li>                </ul>                <ul class="states">                </ul>            </div>            <form class="msg">                <input type="text" class="msg" />                <textarea class="msg"></textarea>                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';Chatterbox.template.brow_button='<li><a href="{href}" title="{title}" class="button{icon}">{label}</a></li>';Chatterbox.template.brow_state='<li id="{ref}">{label}</li>';Chatterbox.template.nav_button='<li><a href="{href}" title="{title}" class="button{icon}">{label}</a></li>';Chatterbox.template.tab='<li id="{selector}-tab"><a href="#{selector}" class="tab">{ns}<a href="#{selector}" class="close iconic x"></a></a></li>';Chatterbox.template.basetab='<div class="chatwindow" id="{selector}-window"></div>';
Chatterbox.template.feed='<div class="chatwindow feed" id="{selector}-window">                    <header class="info">                        <h2>{name}<span class="type">{type} feed</span></h2>                        <p>{info}</p>                        <ul class="control">                            <li><a href="#post" class="button iconic pen" title="Post a message on"></a></li>                            <li><a href="#refresh" class="button iconic spin" title="Get updates"></a></li>                            <li><a href="#close" class="button iconic x" title="Close feed reader"></a></li>                        </ul>                    </header>                    <div class="log" id="{selector}-log">                        <ul class="logwrap"></ul>                    </div>                    <div class="users" id="{selector}-users"></div>                </div>';Chatterbox.template.feedmsg='<li id="{ref}">                                <article>                                    <a href="#close" class="iconic x" title="Remove feed message"></a>                                    <section class="label">{icon}</section>                                    <section class="content">                                        <h3>{title}</h3>                                        {content}                                    </section>                                </article>                            </li>';
Chatterbox.template.channel='<div class="chatwindow" id="{selector}-window">                    <header class="title">                        <div class="title"></div>                        <textarea></textarea>                        <a href="#edit" class="button iconic pen" title="Edit the title"></a>                        <a href="#save" class="button iconic check" title="Save changes"></a>                        <a href="#cancel" class="button iconic x" title="Cancel"></a>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header class="topic">                            <div class="topic"></div>                            <textarea></textarea>                            <a href="#edit" class="button iconic pen" title="Edit the topic"></a>                            <a href="#save" class="button iconic check" title="Save changes"></a>                            <a href="#cancel" class="button iconic x" title="Cancel"></a>                        </header>                        <ul class="logwrap"></ul>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';
Chatterbox.template.header='<div class="{head}">{content}</div>';Chatterbox.template.logmsg='<span class="message">{message}</span>';Chatterbox.template.logitem='<li class="logmsg u-{user}"><span class="ts" id="{ms}">{ts}</span> {message}</li>';Chatterbox.template.servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';Chatterbox.template.usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';Chatterbox.template.userinfo='<div class="userinfo" id="{username}">                            <div class="avatar">                                {avatar}                            </div><div class="info">                            <strong>                            {link}                            </strong>                            <ul>{info}</ul></div>                        </div>';Chatterbox.template.loginfobox='<li class="loginfo {ref}"><a href="#{ref}" class="close iconic x"></a>{content}</li>';Chatterbox.template.whois={};Chatterbox.template.whoiswrap='<div class="whoiswrap">                                <div class="avatar">{avatar}</div>                                <div class="info">{info}</div>                                </div>';
Chatterbox.template.whoisinfo="<p>{username}</p><ul>{info}</ul>{connections}";Chatterbox.template.pcinfo='<section class="pcinfo"><strong>{title}</strong>{info}</section>';Chatterbox.template.popup='<div class="floater {ref}"><div class="inner"><h2>{title}</h2><div class="content">{content}</div></div></div>';Chatterbox.template.ip={};Chatterbox.template.ip.main={};Chatterbox.template.ip.main.frame='<section class="tabs"><ul></ul></section>        <section class="pages"></section>        <section class="buttons"></section>';Chatterbox.template.ip.page={frame:'<div class="page" id="{ref}">{content}</div>'};Chatterbox.template.ip.button={frame:'<a href="{href}" title="{title}" class="button text">{label}</a>'};Chatterbox.template.ip.tab={frame:'<li class="tab" id="{ref}"><a href="{href}" title="{title}">{label}</a></li>'};Chatterbox.template.prompt={};Chatterbox.template.prompt.main='<span class="label">{label}</span>    <span class="input"><form><input type="text" value="{default}" /></form></span>    <span class="buttons">    <a href="#submit" class="button submit">{submit-button}</a>    <a href="#remove" class="button close big square iconic x"></a>    </span>';
Chatterbox.template.pager={notice:{frame:'<div class="notice" id="{ref}">            <a href="#close" class="close_notice iconic x"></a>            <div class="icon">{icon}</div>            <div class="content">                <h3>{heading}</h3>                <p>{content}</p>                <footer class="buttons"></footer>            </div>            </div>'},button:{frame:'<a href="#{target}" title="{title}" id="{ref}" class="button text">{label}</a>'}};Chatterbox.template.settings={};Chatterbox.template.settings.main='<div class="bookwrap">                                <nav class="tabs">                                    <ul class="tabs"></ul>                                </nav>                                <div class="book"></div>                            </div>                            <footer>                                <a href="#save" class="button save">Save</a> <a href="#saveclose" class="button saveclose">Save & Close</a> <a href="#close" class="button close big square iconic x"></a>                            </footer>';
Chatterbox.template.settings.page='<div class="page" id="{ref}-page"></div>';Chatterbox.template.settings.tab='<li id="{ref}-tab"><a href="#{ref}" class="tab" id="{ref}-tab">{name}</a></li>';Chatterbox.template.settings.krender={};Chatterbox.template.settings.krender.title=function(a){if(a.length==0){return""}return"<h3>"+a+"</h3>"};Chatterbox.template.settings.krender.text=function(a){return replaceAll(a,"\n\n","\n</p><p>\n")};Chatterbox.template.settings.krender.dditems=function(a){if(a.length==0){return""}render="";for(i in a){item=a[i];render+='<option value="'+item.value+'"';if(item.selected){render+=' selected="yes"'}render+=">"+item.title+"</option>"}return render};Chatterbox.template.settings.krender.radioitems=function(a){if(a.length==0){return""}render="";labels=[];fields=[];for(i in a){item=a[i];labels.push(Chatterbox.render("settings.item.form.label",{ref:item.value,label:item.title}));ritem='<div class="'+item.value+' field radio"><input class="'+item.value+'" type="radio" name="'+item.name+'" value="'+item.value+'"';
if(item.selected){ritem+=' checked="yes"'}fields.push(ritem+" /></div>")}return'<section class="labels">'+labels.join("")+'</section><section class="fields">'+fields.join("")+"</section>"};Chatterbox.template.settings.krender.checkitems=function(a){if(a.length==0){return""}render="";labels=[];fields=[];for(i in a){item=a[i];if("title" in item){labels.push(Chatterbox.render("settings.item.form.label",{ref:item.value,label:item.title}))}ritem='<div class="'+item.value+' field check"><input class="'+item.value+'" type="checkbox" name="'+item.name+'" value="'+item.value+'"';if(item.selected){ritem+=' checked="yes"'}fields.push(ritem+" /></div>")}if(labels.length>0){render+='<section class="labels">'+labels.join("")+"</section>"}return render+'<section class="fields">'+fields.join("")+"</section>"};Chatterbox.template.settings.krender.manageditems=function(b){if(b.length==0){return"<i>No items in this list</i>"}var g="<ul>";var j=[];var a=[];var h;for(var f in b){if(!b.hasOwnProperty(f)){continue
}h=b[f];g+='<li title="'+h.toLowerCase()+'">                  <span class="remove"><a href="#remove" title="Remove item" class="close iconic x"></a></span>                  <span class="item">'+h+"</span>                  </li>"}return g+"</ul>"};Chatterbox.template.settings.item={};Chatterbox.template.settings.item.get=function(a){var f=a.split(".");var b=Chatterbox.template.settings.item;for(i in f){tc=f[i];if(b.hasOwnProperty(tc)){b=b[tc];continue}return null}return b};Chatterbox.template.settings.item.wrap='<section class="item {type} {ref}{class}">                                    {content}                                </section>';Chatterbox.template.settings.item.hint={};Chatterbox.template.settings.item.hint.frame='<aside class="hint">{hint}</aside>{content}';Chatterbox.template.settings.item.hint.prep=function(a,b){if(!b.hasOwnProperty("hint")){return a}return Chatterbox.render("settings.item.hint",{hint:b.hint,content:a})};Chatterbox.template.settings.item.twopane={};Chatterbox.template.settings.item.twopane.frame='{title}<div class="twopane">                                        <div class="text left">                                            <p>{text}</p>                                        </div>                                        <div class="right">                                            {template}                                        </div>                                    </div>';
Chatterbox.template.settings.item.twopane.wrap=function(a,b){if(!b.hasOwnProperty("text")){return a}a=replaceAll(Chatterbox.template.settings.item.twopane.frame,"{template}",replaceAll(a,"{title}",""));return a};Chatterbox.template.settings.item.text={};Chatterbox.template.settings.item.text.pre=Chatterbox.template.settings.item.hint.prep;Chatterbox.template.settings.item.text.post=Chatterbox.template.clean(["title","text"]);Chatterbox.template.settings.item.text.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.text.frame="{title}<p>                                        {text}                                    </p>";Chatterbox.template.settings.item.dropdown={};Chatterbox.template.settings.item.dropdown.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.dropdown.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.dditems};
Chatterbox.template.settings.item.dropdown.post=Chatterbox.template.clean(["title","items"]);Chatterbox.template.settings.item.dropdown.events=[["change","select"],["inspect","select"]];Chatterbox.template.settings.item.dropdown.frame="{title}<form>                                                <select>                                                    {items}                                                </select>                                            </form>";Chatterbox.template.settings.item.radio={};Chatterbox.template.settings.item.radio.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.radio.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.radioitems};Chatterbox.template.settings.item.radio.post=Chatterbox.template.clean(["ref","title","items"]);Chatterbox.template.settings.item.radio.events=[["change","input:radio"],["inspect","input:radio"]];
Chatterbox.template.settings.item.radio.frame='{title}<div class="{ref} radiobox"><form>{items}</form></div>';Chatterbox.template.settings.item.checkbox={};Chatterbox.template.settings.item.checkbox.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.checkbox.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.checkitems};Chatterbox.template.settings.item.checkbox.post=Chatterbox.template.clean(["ref","title","items"]);Chatterbox.template.settings.item.checkbox.events=[["change","input:checkbox"],["inspect","input:checkbox"]];Chatterbox.template.settings.item.checkbox.frame='{title}<div class="{ref} checkbox"><form>{items}</form></div>';Chatterbox.template.settings.item.textfield={};Chatterbox.template.settings.item.textfield.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];
Chatterbox.template.settings.item.textfield.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.textfield.post=Chatterbox.template.clean(["ref","title","default"]);Chatterbox.template.settings.item.textfield.events=[["blur","input"],["inspect","input"]];Chatterbox.template.settings.item.textfield.frame='{title}<div class="{ref} textfield"><form><input type="text" value="{default}" /></form></div>';Chatterbox.template.settings.item.textarea={};Chatterbox.template.settings.item.textarea.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.textarea.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.textarea.post=Chatterbox.template.clean(["ref","title","default"]);Chatterbox.template.settings.item.textarea.events=[["blur","textarea"],["inspect","textarea"]];
Chatterbox.template.settings.item.textarea.frame='{title}<div class="{ref} textarea"><form><textarea rows="4" cols="20" value="{default}"></textarea></form></div>';Chatterbox.template.settings.item.items={};Chatterbox.template.settings.item.items.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.items.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.manageditems};Chatterbox.template.settings.item.items.post=Chatterbox.template.clean(["ref","title","items"]);Chatterbox.template.settings.item.items.events=[];Chatterbox.template.settings.item.items.frame='{title}<div class="{ref} items">    <section class="buttons"><p><a href="#up" title="Move item up" class="button up iconic arrow_up"></a>    <a href="#down" title="Move item down" class="button down iconic arrow_down"></a>    <a href="#add" title="Add an item" class="button add iconic plus"></a>    <a href="#remove" title="Remove item from list" class="button close big square iconic x"></a>    </p></section>    <section class="mitems">{items}</section>    </div>';
Chatterbox.template.settings.item.colour={};Chatterbox.template.settings.item.colour.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.colour.render={title:Chatterbox.template.settings.krender.title};Chatterbox.template.settings.item.colour.post=Chatterbox.template.clean(["ref","title","default"]);Chatterbox.template.settings.item.colour.events=[["blur","input"],["inspect","input"]];Chatterbox.template.settings.item.colour.frame='{title}<div class="{ref} textfield"><form><input type="color" value="{default}" /></form></div>';Chatterbox.template.settings.item.form={};Chatterbox.template.settings.item.form.pre=[Chatterbox.template.settings.item.twopane.wrap,Chatterbox.template.settings.item.hint.prep];Chatterbox.template.settings.item.form.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text,items:Chatterbox.template.settings.krender.dditems};Chatterbox.template.settings.item.form.post=Chatterbox.template.clean(["title","text","items"]);
Chatterbox.template.settings.item.form.frame='{title}<form>                                                <section class="labels"></section>                                                <section class="fields"></section>                                            </form>';Chatterbox.template.settings.item.form.label={};Chatterbox.template.settings.item.form.label.post=Chatterbox.template.clean(["ref","label","class"]);Chatterbox.template.settings.item.form.label.frame='<div class="{ref} label{class}"><label for="{ref}">{label}</label></div>';Chatterbox.template.settings.item.form.field={};Chatterbox.template.settings.item.form.field.wrap={};Chatterbox.template.settings.item.form.field.wrap.post=Chatterbox.template.clean(["ref","field"]);Chatterbox.template.settings.item.form.field.wrap.frame='<div class="{ref} field">{field}</div>';Chatterbox.template.settings.item.form.field.dropdown={};Chatterbox.template.settings.item.form.field.dropdown.render={items:Chatterbox.template.settings.krender.dditems};
Chatterbox.template.settings.item.form.field.dropdown.post=Chatterbox.template.clean(["ref","items"]);Chatterbox.template.settings.item.form.field.dropdown.frame='<select class="{ref}">{items}</select>';Chatterbox.template.settings.item.form.field.textfield={};Chatterbox.template.settings.item.form.field.textfield.post=Chatterbox.template.clean(["ref","default"]);Chatterbox.template.settings.item.form.field.textfield.frame='<input class="{ref}" type="text" value="{default}" />';Chatterbox.template.settings.item.form.field.textarea={};Chatterbox.template.settings.item.form.field.textarea.post=Chatterbox.template.clean(["ref","default"]);Chatterbox.template.settings.item.form.field.textarea.frame='<textarea class="{ref}" rows="4" cols="20" value="{default}"></textarea>';Chatterbox.template.settings.item.form.field.radio={};Chatterbox.template.settings.item.form.field.radio.render={items:Chatterbox.template.settings.krender.radioitems};Chatterbox.template.settings.item.form.field.radio.post=Chatterbox.template.clean(["ref","items"]);
Chatterbox.template.settings.item.form.field.radio.frame='<div class="{ref} radiobox">{items}</div>';Chatterbox.template.settings.item.form.field.checkbox={};Chatterbox.template.settings.item.form.field.checkbox.render={items:Chatterbox.template.settings.krender.checkitems};Chatterbox.template.settings.item.form.field.checkbox.post=Chatterbox.template.clean(["ref","items"]);Chatterbox.template.settings.item.form.field.checkbox.frame='<div class="{ref} checkbox">{items}</div>';Chatterbox.template.settings.item.form.field.text={};Chatterbox.template.settings.item.form.field.text.pre=Chatterbox.template.settings.item.hint.prep;Chatterbox.template.settings.item.form.field.text.post=Chatterbox.template.clean(["title","text"]);Chatterbox.template.settings.item.form.field.text.render={title:Chatterbox.template.settings.krender.title,text:Chatterbox.template.settings.krender.text};Chatterbox.template.settings.item.form.field.text.frame="{title}<p>                                        {text}                                    </p>";
Chatterbox.template.settings.item.form.field.colour={};Chatterbox.template.settings.item.form.field.colour.post=Chatterbox.template.clean(["ref","default"]);Chatterbox.template.settings.item.form.field.colour.frame='<input class="{ref}" type="color" value="{default}" />';wsc.dAmn={};wsc.dAmn.VERSION="0.9.26";wsc.dAmn.STATE="alpha";wsc.dAmn.BDS=function(f,k,g){var h={};var a={};g.bds={version:"0.4",mns:"chat:datashare",gate:"chat:dsgateway",channel:(new StringSet()),provides:["BOTCHECK","CLINK"]};f.bds=g.bds;g.bds.channel.add(g.bds.mns);g.bds.channel.add(g.bds.gate);var l=function(){f.hidden.add(g.bds.mns);f.exclude.add(g.bds.mns);f.hidden.add(g.bds.gate);f.exclude.add(g.bds.gate);f.bind("pkt.login",m);f.bind("pkt.recv_msg",b);f.bind("pkt.join",j.join);f.bind("BDS.BOTCHECK.DIRECT",j.botcheck);f.bind("BDS.BOTCHECK.ALL",j.botcheck);f.bind("BDS.BOTCHECK.OK",j.checkresp);f.bind("BDS.BOTCHECK.DENIED",j.checkresp);f.bind("CDS.LINK.REQUEST",j.clreq);f.bind("CDS.LINK.REJECT",j.clrj);f.bind("CDS.LINK.ACK",j.clra);
f.bind("pkt.recv_join",j.pcrj);f.bind("pkt.recv_part",j.pcrp);f.bind("pkt.property",j.pcp);f.bind("closed",j.closed);f.ui.middle("log_item",function(o,n){j.filter(o,n)});f.middle("chan.recv_msg",function(o,n){j.hfilter(o,n)})};var m=function(n){if(n.pkt.arg.e!="ok"){return}f.join(g.bds.gate)};var b=function(q){if(q.user.toLowerCase()==f.settings.username.toLowerCase()){return}if(!g.bds.channel.contains(q.ns)){return}var p={ns:q.ns,sns:q.sns,message:q.message,user:q.user,name:"",payload:"",head:[null,null,null],params:[]};var s=q.message.split(":");var o=[null,null,null];var r=null;for(var n in o){o[n]=s.shift()||null;if(o[n]==null){return}}r=s.join(":");p.name=o.join(".");p.payload=r;p.head=o;p.param=r.split(",");f.trigger(o[0],p);f.trigger(o[0]+"."+o[1],p);f.trigger(p.name,p)};var j={filter:function(o,n){if(f.settings.developer){n(o);return}if(o.ns[0]!="@"){n(o);return}var p=o.message.match(/<span class="cmsg u-([^"]+)">(.*)<\/span>/);if(!p){n(o);return}if(p[2].match(/^([A-Z0-9-_]+):([A-Z0-9-_]+):([A-Z0-9-_]+)(:.*|)$/)){return
}n(o)},hfilter:function(o,n){if(f.settings.developer){n(o);return}if(o.sns[0]!="@"){n(o);return}if(o.message.match(/^([A-Z0-9-_]+):([A-Z0-9-_]+):([A-Z0-9-_]+)(:.*|)$/)){return}n(o)},closed:function(n){f.remove_ns(g.bds.mns);f.remove_ns(g.bds.gate)},join:function(n){if(n.ns.toLowerCase()!=g.bds.mns){return}if(n.pkt.arg.e!="ok"){return}f.npmsg(n.ns,"BDS:PROVIDER:CAPS:"+g.bds.provides.join(","))},botcheck:function(o){if(o.head[2]!="ALL"&&o.payload!=f.settings.username){return}var n=wsc.VERSION+"/"+f.ui.VERSION+"/"+wsc.dAmn.VERSION+"/"+g.bds.version;var p=CryptoJS.MD5(("wsc.dAmn"+n+f.settings.username+o.user).toLowerCase());f.npmsg(o.ns,"BDS:BOTCHECK:CLIENT:"+o.user+",wsc.dAmn,"+n+","+p)},checkresp:function(n){if(n.ns.toLowerCase()!=g.bds.gate){return}if(n.param[0].toLowerCase()!=f.settings.username.toLowerCase()){return}if(f.channel(n.ns).info.members[f.settings.username].pc=="Visitors"){f.part(n.ns)}if(n.head[2]=="OK"){f.join(g.bds.mns);return}f.ui.pager.notice({ref:"botcheckdenied",heading:"BDS Error",content:"Denied entry to backend channel.\nReason provided: <code>"+n.param.slice(1).join(",")+"</code>"})
},clreq:function(r){if(r.payload.toLowerCase()!=f.settings.username.toLowerCase()){return}if(f.ui.umuted.indexOf(r.user.toLowerCase())!=-1){f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user+",You have been blocked");return}if(f.away.on){var p=new Date();var q=r.sns.toLowerCase();var n=timeLengthString((p-f.away.since)/1000);var s=replaceAll(f.away.format.away,"{user}",r.user);s=replaceAll(s,"{timesince}",n);f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user+",Away; "+f.away.reason);return}f.npmsg(r.ns,"CDS:LINK:ACK:"+r.user);var o=f.ui.pager.notice({ref:"clink-"+r.user,icon:'<img src="'+wsc.dAmn.avatar.src(r.user,f.channel(r.ns).info.members[r.user].usericon)+'" />',heading:"Chat "+r.user,content:r.user+" wants to talk in private.\nType <code>/chat "+r.user+"</code> to talk to them, or use the buttons below.",buttons:{accept:{ref:"accept",target:"accept",label:"Accept",title:"Join the private chat",click:function(){f.ui.pager.remove_notice(o);f.join("@"+r.user);return false}},reject:{ref:"reject",target:"reject",label:"Reject",title:"Reject the private chat",click:function(){f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user);
f.ui.pager.remove_notice(o);return false}}}},true);a[r.user]=o;o.onclose=function(){f.npmsg(r.ns,"CDS:LINK:REJECT:"+r.user)}},clrj:function(q){var n=q.user.toLowerCase();var r=q.payload.split(",");var o=r.shift();r=r.join(",");if(o.toLowerCase()!=f.settings.username.toLowerCase()){return}if(!(n in h)){return}clearTimeout(h[n]);f.channel("@"+n).server_message("Chat request rejected",r)},clra:function(q){var n=q.user.toLowerCase();var r=q.payload.split(",");var o=r.shift();if(o.toLowerCase()!=f.settings.username.toLowerCase()){return}clearTimeout(h[n])},pcp:function(p){if(p.ns.indexOf("pchat")!=0){return}if(f.bds.channel.contains(p.ns)){return}if(p.pkt.arg.p!="members"){return}if(f.channel(p.ns).get_usernames().length==2){f.bds.channel.add(p.ns);return}var n=p.sns.substr(1);var o=p.ns;f.ui.channel(o).server_message(n+" has not yet joined","Sending them a notice...");f.npmsg("chat:datashare","CDS:LINK:REQUEST:"+n);h[n.toLowerCase()]=setTimeout(function(){try{f.ui.channel(o).server_message("Notification failed",n+" does not seem to be using a client that supports pchat notices.")
}catch(q){}},10000)},pcrj:function(o){if(o.sns[0]!="@"){return}try{clearTimeout(h[o.user.toLowerCase()])}catch(n){}f.bds.channel.add(o.ns);if(!(o.user in a)){return}f.ui.pager.remove_notice(a[o.user])},pcrp:function(n){if(n.sns[0]!="@"){return}f.bds.channel.remove(n.ns)}};l()};wsc.dAmn.Colours=function(a,f,b){b.colours.page=null;b.colours.configure_page=function(g,j){var h=g.settings.page("Colours");b.colours.page=h;var k={};k.on=b.colours.on;k.send=b.colours.send;k.msg=b.colours.msg;k.user=b.colours.user;h.item("Form",{ref:"switch",title:"Enable Chromacity Colours",text:"Here you can turn chromacity colours on and off.\n\nYou                    can choose to parse other people's colours, and send your                    own colours.",fields:[["Checkbox",{ref:"enabled",items:[{value:"parse",title:"Parse colours",selected:k.on},{value:"send",title:"Send colours",selected:k.send}]}]],event:{change:function(l){b.colours.on=(l.data.enabled.indexOf("parse")!=-1);b.colours.send=(l.data.enabled.indexOf("send")!=-1)
},save:function(l){k.on=b.colours.on;k.send=b.colours.send},close:function(l){b.colours.on=k.on;b.colours.send=k.send}}});h.item("Form",{ref:"colours",title:"Custom Colours",text:"Here you can set your own username colour and message colour.",fields:[["Colour",{ref:"usr",label:"Username Colour","default":"#"+k.user}],["Colour",{ref:"msg",label:"Message Colour","default":"#"+k.msg}]],event:{change:function(l){b.colours.user=l.data.usr.substr(1).toUpperCase();b.colours.msg=l.data.msg.substr(1).toUpperCase()},save:function(l){k.user=b.colours.user;k.msg=b.colours.msg},close:function(l){b.colours.user=k.user;b.colours.msg=k.msg},}})};b.colours.send_colour=function(h,g){if(!b.colours.send){g(h);return}h.input+='<abbr title="colors:'+b.colours.user+":"+b.colours.msg+'"></abbr>';g(h)};b.colours.parse_colour=function(j){if(!b.colours.on){return}var h=j.item.find("abbr");if(h.length==0){return}h=h.last();var g=h.prop("title").match(/colors:([A-F0-9]{6}):([A-F0-9]{6})/);if(g==null){return}h.remove();
j.item.find(".cmsg, .caction").css("color","#"+g[2]);j.item.find(".cmsg.user, .caction.user").css("color","#"+g[1])};a.ui.on("settings.open.ran",b.colours.configure_page);a.ui.on("log_item.after",b.colours.parse_colour);a.middle("send.msg",b.colours.send_colour);a.middle("send.action",b.colours.send_colour)};wsc.dAmn.Emotes=function(a,f,b){b.emotes.emote={};b.emotes.page=null;b.emotes.fint=null;b.emotes.notice=null;b.emotes.fetching=false;b.emotes.loaded=false;b.emotes.picker=new wsc.dAmn.Emotes.Picker(a.ui,{event:{select:function(g){b.emotes.select(g)},reload:function(){b.emotes.fetch()}}},b);b.emotes.picker.build();b.emotes.picker.hide();a.ui.control.add_button({label:"",icon:"user",href:"#emotes",title:"Emote picker.",handler:function(){if(b.emotes.picker.window.css("display")=="none"){b.emotes.picker.show()}else{b.emotes.picker.close()}}});b.emotes.configure_page=function(h,k){var j=h.settings.page("Emotes");b.emotes.page=j;var l={};l.on=b.emotes.on;var g="";if(l.on){if(!b.emotes.loaded||b.emotes.fetching){g="<em>Fetching emotes...</em>"
}else{g="<em>Emotes loaded.</em>"}}j.item("Form",{ref:"switch",title:"Enable Emotes",text:"Here you can turn custom emotes on and off.",fields:[["Checkbox",{ref:"enabled",items:[{value:"yes",title:"On",selected:l.on}]}]],event:{change:function(m){b.emotes.on=(m.data.enabled.indexOf("yes")!=-1);b.emotes.picker.state(b.emotes.on);if(b.emotes.on){b.emotes.fetch();return}if(b.emotes.fint===null){return}clearTimeout(b.emotes.fint);b.emotes.fint=null},save:function(m){l.on=b.emotes.on;if(!b.emotes.on){b.emotes.picker.loading("Disabled")}else{if(!b.emotes.fetching){b.emotes.picker.loaded()}}},close:function(m){b.emotes.on=l.on;b.load();b.emotes.page=null;if(b.emotes.fint===null){return}clearTimeout(b.emotes.fint);b.emotes.fint=null}}})};a.ui.on("settings.open.ran",b.emotes.configure_page);b.emotes.fetch=function(){if(b.emotes.loaded){b.emotes.picker.loading("Reloading...")}else{b.emotes.picker.loading()}b.emotes.fetching=true;jQuery.getJSON("http://www.thezikes.org/publicemotes.php?format=jsonp&jsoncallback=?&"+(new Date()).getDay(),function(g){b.emotes.fetching=false;
b.emotes.emote=g;if(!b.emotes.loaded){if(b.emotes.on){a.ui.pager.notice({ref:"emotes-loaded",heading:"Emote CLOUD",content:"Emoticons from zike's Emote CLOUD have been loaded."},false,5000,true)}}b.emotes.sort();b.emotes.loaded=true;b.emotes.picker.loaded();b.emotes.fint=setTimeout(b.emotes.fetch,3600000)},function(){b.emotes.picker.loaded();return false})};b.emotes.swap=function(m,g){if(!b.emotes.on){g(m);return}var h=m.input.match(/:([\S]+):/g);var l="";var k=-1;var j=function(n){return n!=h[k]};for(k in h){l=h[k];h=h.filter(j);if(!b.emotes.emote.hasOwnProperty(l)){continue}m.input=replaceAll(m.input,l,":thumb"+b.emotes.emote[l]["devid"]+":")}m.input=replaceAll(m.input,":B",":bucktooth:");g(m)};b.emotes.prepare=function(g){g=replaceAll(g,"&","&amp;");g=replaceAll(g,"<","&lt;");g=replaceAll(g,">","&gt;");return replaceAll(g,'"',"&quot;")};b.emotes.repair=function(g){g=replaceAll(g,"&quot;",'"');g=replaceAll(g,"&lt;","<");g=replaceAll(g,"&gt;",">");return replaceAll(g,"&amp;","&")};b.emotes.sort=function(){var h=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],];
var n="ABCDEFGHIJKLMNOPQRSTUVWXYZ#";var k=null;var p=null;var l=false;var u=-1;var j=true;for(var o in b.emotes.emote){if(!b.emotes.emote.hasOwnProperty(o)){continue}k=b.emotes.emote[o];var r=replaceAll(k.img.split("/").pop().split(".").shift(),"__"," ");r=replaceAll(r,"_"," ");var g=wsc.dAmn.Emotes.Thumb(k.devid,{user:k.by,title:r,otitle:"created by "+k.by,aclose:"",anchor:"",thumb:k.img});p={value:'<span class="thumb">'+g+'</span><span class="value">'+b.emotes.prepare(k.code)+"</span>",title:"created by "+k.by,html:true};u=n.indexOf(k.code.substr(1,1).toUpperCase());if(u==-1){u=n.indexOf("#")}h[u].push(p)}var s=function(x,v){return caseInsensitiveSort(x.value,v.value)};var m=b.emotes.picker.page("#");var q=null;for(var o=0;o<n.length;o++){h[o].sort(s);q=b.emotes.picker.page(n[o],m);q.options.items=h[o]}b.emotes.picker.refresh()};b.emotes.select=function(g){a.ui.control.set_text(a.ui.control.get_text()+b.emotes.repair(g))};a.middle("send.msg",b.emotes.swap);a.middle("send.action",b.emotes.swap);
a.middle("send.kick",b.emotes.swap);a.middle("send.set",b.emotes.swap);if(!b.emotes.on){return}b.emotes.fetch()};wsc.dAmn.Emotes.Tablumps=function(j){var n={id:j[0],user:j[2],thumb:j[5],server:parseInt(j[4]),flags:j[6].split(":"),dimensions:"",title:"",anchor:"",otitle:j[1]};n.flags[0]=parseInt(n.flags[0]);n.flags[1]=parseInt(n.flags[1]);n.flags[2]=parseInt(n.flags[2]);var f=n.thumb.match(/\.gif$/i);var k=j[3].split("x");var o=parseInt(k[0]);var l=parseInt(k[1]);var m,a;var g=n.user.substring(1).replace(/^[^a-zA-Z0-9\-_]/,"");var b=(n.otitle.replace(/[^A-Za-z0-9]+/g,"-").replace(/^-+/,"").replace(/-+$/,"")||"-")+"-"+n.id;n.title=n.otitle+" by "+n.user+", "+o+"x"+l;n.anchor='<a target="_blank" href="http://'+g+".deviantart.com/art/"+b+'" title="'+n.title+'">';if(o/l>1){a=parseInt((l*100)/o);m=100}else{m=parseInt((o*100)/l);a=100}if(m>o||a>l){m=o;a=l}n.dimensions='width="'+m+'" height="'+a+'"';n.flags.push(f&&(o>200||l>200));return wsc.dAmn.Emotes.Thumb(n.id,n)};wsc.dAmn.Emotes.Thumb=function(l,g){g=Object.extend({title:"deviation by user",anchor:'<a href="http://url.com/devation__by_user.gif" target="_blank" title="deviation by user">',aclose:"</a>",thumb:"fs26/f/2008/160/b/2/deviation_by_username.gif",otitle:"deviation",flags:false,dimensions:"",server:"1",},(g||{}));
var k=false;var a=g.thumb.match(/\.gif$/i);if(g.flags){if(g.flags[1]>0){return g.anchor+"[mature deviation: "+g.otitle+"]"+g.aclose}if(g.flags[2]>0){return g.anchor+"[deviation: "+g.otitle+"]"+g.aclose}if(g.flags[3]){return g.anchor+"[deviation: "+d.otitle+"]"+g.aclose}k=(g.flags[0]==0)}var j="";if(a){var h=g.thumb.replace(/:/,"/");j="http://fc0"+g.server+".deviantart.net/"+h;var b=h.split("/");if(b.length>1){b=b["."];if(b&&b.length>2){j="http://"+g.thumb}}return g.anchor+'<img class="thumb" title="'+g.title+'"'+g.dimensions+' alt=":thumb'+l+':" src="'+j+'" />'+g.aclose}j="http://backend.deviantart.com/oembed?url=http://www.deviantart.com/deviation/"+l+"&format=thumb150";if(g.thumb.match(/.png$/i)){k=false}return g.anchor+'<img class="thumb'+(k?" shadow":"")+'"'+g.dimensions+' " alt=":thumb'+l+':" src="'+j+'" />'+g.aclose};wsc.dAmn.Emotes.Picker=function(j,a,f){a=a||{};a=Object.extend({title:"Emotes",event:{select:function(l){},reload:function(){}}},a);Chatterbox.Popup.ItemPicker.call(this,j,a);
this.settings=f;this.rbutton=null;var k="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var h="";var g="";for(var b=0;b<k.length;b++){h=k[b];g=h.toLowerCase();this.add_page({ref:g,href:"#"+g,label:h,title:"Emotes beginning with "+h,items:[]},wsc.dAmn.Emotes.Page)}this.add_page({ref:"misc",href:"#misc",label:"#",title:"Emotes not beginning with letters",items:[]},wsc.dAmn.Emotes.Page)};wsc.dAmn.Emotes.Picker.prototype=new Chatterbox.Popup.ItemPicker();wsc.dAmn.Emotes.Picker.prototype.constructor=wsc.dAmn.Emotes.Picker;wsc.dAmn.Emotes.Picker.Disabled='<section class="pages">            <section class="disabled">                <p>The emote cloud is currently disabled.</p><p>To use emoticons from                the cloud, click the button below to enable them.</p><p>                <a href="#enable" class="button text">Enable</a>                </p>            </section>            </section>            <section class="buttons"></section>';wsc.dAmn.Emotes.Picker.prototype.state=function(a){this.settings.emotes.on=(a||false);
this.rebuild();this.refresh()};wsc.dAmn.Emotes.Picker.prototype.hide=function(){this.window.css({display:"none"})};wsc.dAmn.Emotes.Picker.prototype.show=function(){this.window.css({display:"block"});this.refresh()};wsc.dAmn.Emotes.Picker.prototype.close=function(){this.hide()};wsc.dAmn.Emotes.Picker.prototype.build=function(a){Chatterbox.Popup.ItemPicker.prototype.build.call(this,a);this.rebuild()};wsc.dAmn.Emotes.Picker.prototype.rebuild=function(b){var a=this;this.window.find(".inner .content").html("");if(this.settings.emotes.on){this.options.content=Chatterbox.render("ip.main")}else{this.options.content=wsc.dAmn.Emotes.Picker.Disabled}this.window.find(".inner .content").html(this.options.content);this.pbook=this.window.find("section.pages");this.buttons=this.window.find("section.buttons");this.rbutton=this.add_button({href:"#reload",title:"Reload emoticons",label:"Reload"});if(this.settings.emotes.fetching){this.loading("Loading...")}if(!this.settings.emotes.on){this.loading("Disabled")
}this.rbutton.click(function(){if(!a.settings.emotes.on){return false}if(a.settings.emotes.fetching){return false}if(a.rbutton.hasClass("evented")){return false}a.reload();return false});if(this.settings.emotes.on){this.tabs=this.window.find("section.tabs ul");var h=this;var g=null;for(var f in this.pages){if(!this.pages.hasOwnProperty(f)){continue}g=this.pages[f];g.build();if(f==0){this.select_page(g)}}}else{this.dis=this.pbook.find(".disabled");this.dis.css({"max-width":330});this.dis.find("p").css({margin:"5px 10px 5px 10px",});this.dis.find("p").last().css({"text-align":"center","margin-top":25,"margin-bottom":25});this.dis.find("p").first().css({"margin-top":25});this.window.find("a[href=#enable].button").click(function(){a.state(true);a.settings.emotes.fetch();a.settings.save();return false})}};wsc.dAmn.Emotes.Picker.prototype.loaded=function(){this.rbutton.html("Reload");this.rbutton.removeClass("evented")};wsc.dAmn.Emotes.Picker.prototype.loading=function(a){a=a||"Reloading...";
this.rbutton.addClass("evented");this.rbutton.html(a)};wsc.dAmn.Emotes.Picker.prototype.reload=function(){this.loading();this.options.event.reload()};wsc.dAmn.Emotes.Page=function(){Chatterbox.Popup.ItemPicker.Page.apply(this,arguments)};wsc.dAmn.Emotes.Page.prototype=new Chatterbox.Popup.ItemPicker.Page();wsc.dAmn.Emotes.Page.prototype.constructor=wsc.dAmn.Emotes.Page;wsc.dAmn.Emotes.Page.prototype.refresh=function(){if(!this.picker.settings.emotes.on){return}Chatterbox.Popup.ItemPicker.Page.prototype.refresh.call(this);var a=this;a.view.find("span.thumb img").error(function(){var f=a.view.find(this);var b=f.parent().parent();var g=a.picker.settings.emotes.repair(b.find(".value").html());delete a.picker.settings.emotes.emote[g];b.remove();return false});a.view.find("span.thumb img").load(function(){var j=a.view.find(this);var b=j.width();var g=j.height();var k,f;if(b/g>1){k=parseInt((g*100)/b);f=100}else{f=parseInt((b*100)/g);k=100}if(f>b||k>g){f=b;k=g}j.css({height:k,width:f});j.parent().css({"float":"right",display:"block"})
})};wsc.dAmn.Extension=function(a){a.settings.client="dAmnClient";a.settings.clientver="0.3";a.settings.domain="deviantart.com";a.settings.agent+=" wsc/dAmn/"+wsc.dAmn.VERSION;var f=a.storage.folder("dAmn");f.bds=f.folder("bds");f.emotes=f.folder("emotes");f.colours=f.folder("colours");var b={emotes:{on:false,emote:[]},colours:{on:false,send:false,msg:"000000",user:"000000"}};b.save=function(){f.emotes.set("on",b.emotes.on);f.colours.set("on",b.colours.on);f.colours.set("send",b.colours.send);f.colours.set("msg",b.colours.msg);f.colours.set("user",b.colours.user)};b.load=function(){b.emotes.on=(f.emotes.get("on","false")=="true");b.colours.on=(f.colours.get("on","false")=="true");b.colours.send=(f.colours.get("send","false")=="true");b.colours.msg=f.colours.get("msg","");b.colours.user=f.colours.get("user","")};b.load();b.save();a.protocol.extend_maps({dAmnServer:["version"]});a.protocol.extend_messages({dAmnServer:['<span class="servermsg">** Connected to dAmnServer {version} *</span>',false,true]});
a.protocol.mparser=new wsc.dAmn.TablumpParser;a.flow.dAmnServer=a.flow.chatserver;a.exclude.add("chat:devart");a.exclude.add("chat:damnidlers");a.ui.middle("user.hover",function(h,g){h.avatar=wsc.dAmn.avatar.link(h.name,h.member.usericon);if(h.member.realname&&h.info.indexOf(h.member.realname)==-1){h.info.push(h.member.realname)}if(h.member.typename&&h.info.indexOf(h.member.typename)==-1){h.info.push(h.member.typename)}g(h)});a.ui.on("settings.save",b.save);a.ui.on("settings.close",b.load);a.ui.on("log_whois.before",function(g,h){g.avatar=wsc.dAmn.avatar.link(g.raw.username,g.raw.usericon);g.username=g.raw.symbol+'<b><a href="http://'+g.raw.username+'.deviantart.com/">'+g.raw.username+"</a></b>";if(g.raw.realname){g.info.push(g.raw.realname)}if(g.raw.typename){g.info.push(g.raw.typename)}});wsc.dAmn.BDS(a,f.bds,b);wsc.dAmn.BDS.Link(a,f.bds,b);wsc.dAmn.Colours(a,f.colours,b);wsc.dAmn.Emotes(a,f.emotes,b);wsc.dAmn.Stash(a,f.emotes,b)};wsc.dAmn.avatar={};wsc.dAmn.avatar.ext=["gif","gif","jpg","png"];
wsc.dAmn.avatar.link=function(a,b){var f=wsc.dAmn.avatar.src(a,b);return'<a target="_blank" title=":icon'+a+':" href="http://'+a+'.deviantart.com/"><img class="avatar"            alt=":icon'+a+':" src="'+f+'" height="50" /></a>'};wsc.dAmn.avatar.src=function(b,g){g=parseInt(g);var j=(g>>2)&15;g=g&3;var f=wsc.dAmn.avatar.ext[g]||"gif";var h="default";if(j){j="?"+j}else{j=""}if(g!=0){var a=new RegExp("\\$un(\\[([0-9]+)\\])","g");var h="$un[0]/$un[1]/{un}".replace(a,function(k,n,l){return b[l]=="-"?"_":b[l].toLowerCase()});h=replaceAll(h,"{un}",b.toLowerCase())}return"http://a.deviantart.net/avatars/"+h+"."+f+j};wsc.dAmn.BDS.Link=function(a,h,f){var g=function(){a.bind("BDS",b.cmd);a.bind("BDS.LINK.REQUEST",b.request);a.bind("BDS.LINK.REJECT",b.reject);a.bind("BDS.LINK.ACCEPT",b.accept);a.bind("BDS.LINK.CLOSE",b.close);a.bind("pkt.join",b.join);a.bind("pkt.part",b.part);a.bind("pkt.recv_join",b.recv_join);a.bind("pkt.recv_part",b.recv_part)};f.bds.link={white:(new StringSet()),connections:{},state:{closed:0,opening:1,open:2},conn:function(k,j,l,n){k=k.toLowerCase();
if(k in f.bds.link.connections){return f.bds.link.connections[k]}var o=a.format_ns("@"+k);var m={state:f.bds.link.state.closed,ns:o,un:k,close:function(){f.bds.link.close(m.un)},send:function(p){if(m.state!=f.bds.link.state.open){return false}a.npmsg(m.ns,p);return true},oncmd:(j||function(q,p){}),onopen:(l||function(q,p){}),onclose:(n||function(q,p){})};return m},request:function(k,o,j,l,n){var m=f.bds.link.open(k,j);if(m==null){return null}if(o===true){return m}a.npmsg(f.bds.mns,"BDS:LINK:REQUEST:"+k);return m},open:function(k,j,l,n){k=k.toLowerCase();if(k in f.bds.link.connections){return null}var m=f.bds.link.conn(k,j);m.state=f.bds.link.state.opening;f.bds.link.connections[k]=m;f.bds.channel.add(m.ns);a.hidden.add(m.ns);a.exclude.add(m.ns);a.join(m.ns);return m},close:function(j,l){j=j.toLowerCase();if(!(j in f.bds.link.connections)){return false}var k=f.bds.link.conn(j);if(l!==true){k.send("BDS:LINK:CLOSE")}a.part(k.ns);k.state=f.bds.link.state.closed;return true}};var b={cmd:function(j){if(!f.bds.channel.contains(j.ns)){return
}if(j.sns[0]!="@"){return}f.bds.link.conn(j.sns.substr(1)).oncmd(j,a)},request:function(k){if(k.payload.toLowerCase()!=a.settings.username.toLowerCase()){return}var j=a.channel(k.ns).info.members[k.user];if(parseInt(a.channel(k.ns).get_privclass_order(j.pc))<39){if(!f.bds.link.white.contains(k.user)){a.npmsg(k.ns,"BDS:LINK:REJECT:"+k.user);return}}f.bds.link.open(k.user);a.npmsg(k.ns,"BDS:LINK:ACCEPT:"+k.user)},reject:function(k){var j=k.user.toLowerCase();if(!(j in f.bds.link.connections)){return}f.bds.link.connections[j].close()},accept:function(j){if(j.payload.toLowerCase()!=a.settings.username.toLowerCase()){return}f.bds.link.open(j.user)},close:function(j){f.bds.link.close(j.user,true)},join:function(k){if(k.pkt.arg.e!="ok"){return}if(!f.bds.channel.contains(k.ns)){return}var j=f.bds.link.conn(k.sns.substr(1));if(a.channel(k.ns).get_usernames().length==1){return}j.state=f.bds.link.state.open;var l={name:"BDS.LINK.OPEN",link:j,ns:j.ns};j.onopen(l,a);a.trigger("BDS.LINK.OPEN",l)},part:function(k){if(!f.bds.channel.contains(k.ns)){return
}var j=f.bds.link.conn(k.sns.substr(1));j.state=f.bds.link.state.closed;var l={name:"BDS.LINK.CLOSED",link:j,ns:j.ns};j.onclose(l,a);a.trigger("BDS.LINK.CLOSED",l);delete f.bds.link.connections[j.un]},recv_join:function(k){if(!f.bds.channel.contains(k.ns)){return}var j=f.bds.link.conn(k.sns.substr(1));if(j.state!=f.bds.link.state.opening){return}j.state=f.bds.link.state.open;var l={name:"BDS.LINK.OPEN",link:j,ns:j.ns};j.onopen(l,a);a.trigger("BDS.LINK.OPEN",l)},recv_part:function(k){if(!f.bds.channel.contains(k.ns)){return}var j=f.bds.link.conn(k.sns.substr(1));j.close(true)},};g()};wsc.dAmn.Stash=function(a,h,b){var g=function(){a.ui.on("log_item.after",f.log_item)};var f={log_item:function(k){var j=k.item.find('a[href^="http://sta.sh"]');j.each(function(m,l){var n=k.item.find(l);wsc.dAmn.Stash.fetch(k,n)})}};g()};wsc.dAmn.Stash.fetch=function(b,a){$.getJSON("http://backend.deviantart.com/oembed?url="+a.prop("href")+"&format=jsonp&callback=?",function(f){wsc.dAmn.Stash.render(b,a,f)})};
wsc.dAmn.Stash.render=function(r,j,x){if("error" in x){return}if(x.type!="photo"){return}var f=j.prop("href");var l=x.thumbnail_width;var s=x.thumbnail_height;var v,b;var y=x.title+" by "+x.author_name;var k='<a target="_blank" href="'+f+'" title="'+y+'">';if(l/s>1){b=parseInt((s*100)/l);v=100}else{v=parseInt((l*100)/s);b=100}if(v>l||b>s){v=l;b=s}var q='width="'+v+'" height="'+b+'"';var g=!x.thumbnail_url.match(/.png$/i)?" shadow":"";var o=f.split("/").pop();var u='<span class="stashthumb" id="'+o+'">'+k+'<img class="smaller thumb'+g+'"'+q+' " alt="'+f+'" src="'+x.thumbnail_url_150+'" />        </a><a href="#toggle" class="button iconic plus" title="Larger"></a></span>';j.replaceWith(u);var a=r.item.find("span#"+o);j=a.find('a[href="'+f+'"]');var m=j.find("img.smaller");var z=null;var n=false;var p=a.find('a[href="#toggle"]');p.click(function(){if(!n){m.css("display","none");if(z==null){a.prepend('<img class="larger thumb'+g+'" width="'+l+'"                height="'+s+'" alt="'+f+'" src="'+x.thumbnail_url+'" />');
z=a.find("img.larger")}z.css("display","inline");n=true;p.removeClass("plus");p.addClass("minus");p.prop("title","Smaller");r.chan.st+=r.item.height();r.chan.el.l.w.scrollTop(r.chan.st);r.chan.scroll();return false}z.css("display","none");m.css("display","inline");p.removeClass("minus");p.addClass("plus");p.prop("title","Larger");r.chan.st+=r.item.height();r.chan.el.l.w.scrollTop(r.chan.st);r.chan.scroll();n=false;return false});r.chan.st+=r.item.height();r.chan.el.l.w.scrollTop(r.chan.st);r.chan.scroll()};wsc.dAmn.TablumpString=function(a,b){this._parser=b||new wsc.dAmn.Tablumps();this.tokens=this._parser.tokenise(a);this.raw=a;this._text=null;this._html=null;this._ansi=null};wsc.dAmn.TablumpString.prototype=new wsc.MessageString;wsc.dAmn.TablumpString.prototype.constructor=wsc.dAmn.TablumpString;with(wsc.dAmn.TablumpString.prototype=new String){constructor=wsc.dAmn.TablumpString;toString=valueOf=function(){return this.raw}}wsc.dAmn.TablumpString.prototype.html=function(){if(this._html==null){this._html=this._parser.render(1,this)
}return this._html};wsc.dAmn.TablumpString.prototype.text=function(){if(this._text==null){this._text=this._parser.render(0,this)}return this._text};wsc.dAmn.TablumpString.prototype.ansi=function(){if(this._ansi==null){this._ansi=this._parser.render(2,this)}return this._ansi};wsc.dAmn.PARSE={RAW:0,TAG:1,ARG:2};wsc.dAmn.TablumpParser=function(){this.lumps=this.defaultMap()};wsc.dAmn.TablumpParser.prototype=new wsc.MessageParser;wsc.dAmn.TablumpParser.prototype.constructor=wsc.dAmn.TablumpParser;wsc.dAmn.TablumpParser.prototype.registerMap=function(a){this.lumps=a};wsc.dAmn.TablumpParser.prototype.extend=function(a){for(index in a){this.lumps[index]=a[index]}};wsc.dAmn.TablumpParser.prototype.defaultMap=function(){return{"&b\t":[0,"<b>","<b>","\x1b[1m"],"&/b\t":[0,"</b>","</b>","\x1b[22m"],"&i\t":[0,"<i>","<i>","\x1b[3m"],"&/i\t":[0,"</i>","</i>","\x1b[23m"],"&u\t":[0,"<u>","<u>","\x1b[4m"],"&/u\t":[0,"</u>","</u>","\x1b[24m"],"&s\t":[0,"<s>","<s>","\x1b[9m"],"&/s\t":[0,"</s>","</s>","\x1b[29m"],"&sup\t":[0,"<sup>"],"&/sup\t":[0,"</sup>"],"&sub\t":[0,"<sub>"],"&/sub\t":[0,"</sub>"],"&code\t":[0,"<code>"],"&/code\t":[0,"</code>"],"&p\t":[0,"<p>"],"&/p\t":[0,"</p>"],"&ul\t":[0,"<ul>"],"&/ul\t":[0,"</ul>"],"&ol\t":[0,"<ol>"],"&li\t":[0,"<li>"],"&/li\t":[0,"</li>"],"&/ol\t":[0,"</ol>"],"&link\t":[3,function(a){return a[0]+(a[1]?(" ("+a[1]+")"):"")
},function(a){t=a[1];return'<a target="_blank" href="'+a[0]+'" title="'+(t||a[0])+'">'+(t||"[link]")+"</a>"}],"&acro\t":[1,'<acronym title="{0}">'],"&/acro\t":[0,"</acronym>"],"&abbr\t":[1,'<abbr title="{0}">'],"&/abbr\t":[0,"</abbr>"],"&img\t":[3,'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe\t":[3,'<iframe src="{0}" width="{1}" height="{2}" />'],"&/iframe\t":[0,"</iframe>"],"&a\t":[2,'<a href="{0}" title="{1}">'],"&/a\t":[0,"</a>"],"&br\t":[0,"<br/>"],"&bcode\t":[0,"<bcode>","<span><pre><code>"],"&/bcode\t":[0,"</bcode>","</code></pre></span>"],"&avatar\t":[2,":icon{0}:",function(a){return wsc.dAmn.avatar.link(a[0],a[1])}],"&emote\t":[5,"{0}",'<img alt="{0}" width="{1}" height="{2}" title="{3}" src="http://e.deviantart.com/emoticons/{4}" />'],"&dev\t":[2,":dev{1}:",'{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.deviantart.com/">{1}</a>',"{0}\x1b[36m{1}\x1b[39m"],"&thumb\t":[7,":thumb{0}:",wsc.dAmn.Emotes.Tablumps],EOF:[0,"",null,"\x1b[m"]}};wsc.dAmn.TablumpParser.prototype.parse=function(b,a){b=replaceAll(b,"<","&lt;");
b=replaceAll(b,">","&gt;");return new wsc.dAmn.TablumpString(b,this)};wsc.dAmn.TablumpParser.prototype.tokenise=function(j){if(!j){return[]}var a=wsc.dAmn.PARSE.RAW;var m=[];var b="";var g=0;var l=[];var f="";var n="";var k="";for(var h=0;h<j.length;h++){k=j[h];switch(a){case wsc.dAmn.PARSE.RAW:if(k!="&"){f+=k;break}b=k;a=wsc.dAmn.PARSE.TAG;break;case wsc.dAmn.PARSE.TAG:b+=k;if(k==" "||k=="\t"||k=="&"){if(k==" "||k=="&"||!this.lumps.hasOwnProperty(b)){f+=b;b="";if(k=="&"){h--;f=f.substr(0,f.length-1)}a=wsc.dAmn.PARSE.RAW}else{if(f.length>0){m.push(["raw",f]);f=""}l=[b,[]];g=this.lumps[b][0];m.push(l);b="";if(g>0){a=wsc.dAmn.PARSE.ARG}else{a=wsc.dAmn.PARSE.RAW}}}break;case wsc.dAmn.PARSE.ARG:if(k=="\t"){g--;if(b=="&"){a=wsc.dAmn.PARSE.RAW;b="";break}l[1].push(b);b="";if(g==0){a=wsc.dAmn.PARSE.RAW}break}b+=k;break}}if(f.length>0||b.length>0){m.push(["raw",f+b])}return m};wsc.dAmn.TablumpParser.prototype.render=function(a,g){if(!g){return""}if(!g.hasOwnProperty("tokens")){return""}a=a+1;var h="";
var f=[];for(var b in g.tokens){if(!g.tokens.hasOwnProperty(b)){continue}f=g.tokens[b];if(f[0]=="raw"){h+=f[1];continue}h+=this.renderOne(a,f[0],f[1])}return h+this.renderOne(a,"EOF","")};wsc.dAmn.TablumpParser.prototype.renderOne=function(b,a,h){var f=this.lumps[a];if(f===undefined){return"&"+a+"\t"+h.join("\t")}var g=f[b]||f[1];if(typeof(g)=="string"){return String.format(g,h)}else{return g.call(this,h)}};(function(a){a("*").hover(function(b){a(this).data("hover",true)},function(b){a(this).data("hover",false)});a.fn.wsc=function(g,f){var b=a(window).data("wscclient");if(g=="init"||b===undefined){if(b==undefined){b=new wsc.Client(a(this),f,(a.browser.mozilla||false));a(window).resize(function(){b.ui.resize()});a(window).focus(function(){b.ui.control.focus()});setInterval(function(){b.loop()},120000)}a(window).data("wscclient",b)}if(g!="init"&&g!=undefined){g="jq_"+g;if(g in b){b[g](a(this),f)}}return b};a.fn.wscui=function(f,b){ui=a(window).data("wscui");if(f=="init"||ui===undefined){if(ui==undefined){ui=new Chatterbox.UI(a(this),b,(a.browser.mozilla||false));
a(window).resize(ui.resize)}a(window).data("wscui",ui)}if(f!="init"&&f!=undefined){f="jq_"+f;if(f in ui){ui[f](a(this),b)}}return ui}})(jQuery);