function EventEmitter(){var j={},a=this;function g(q,v){var m=j[q]||false;if(m===false){j[q]=[v];return a}j[q].push(v);return a}function e(m){j[m]=[];return a}function b(){var m=Array.prototype.slice.call(arguments);var x=m.shift();var v=j[x]||false;if(v===false){return a}for(var q in v){if(v.hasOwnProperty(q)){v[q].apply({},m)}}return a}function l(m){return j[m]||[]}this.addListener=g;this.removeListeners=e;this.emit=b;this.listeners=l}wsc_html_ui='<nav class="tabs"><ul id="chattabs"></ul>        <ul id="tabnav">            <li><a href="#left" class="button">&laquo;</a></li>            <li><a href="#right" class="button">&raquo;</a></li>        </ul>        </nav>        <div class="chatbook"></div>';wsc_html_control='<div class="chatcontrol">            <form class="msg">                <input type="text" class="msg" />                <input type="submit" value="Send" class="sendmsg" />            </form>        </div>';var wsc_html_chattab='<li id="{selector}-tab"><a href="#{selector}">{ns}</a></li>';var wsc_html_channel='<div class="chatwindow" id="{selector}-window">                    <header>                        <div class="title"></div>                    </header>                    <div class="chatlog" id="{selector}-log">                        <header>                            <div class="topic"></div>                        </header>                        <div class="logwrap"></div>                    </div>                    <div class="chatusers" id="{selector}-users">                </div>            </div>';var wsc_html_cheader='<div class="{head}">{content}</div>';var wsc_html_logmsg='<span class="message">{message}</span>';var wsc_html_logitem='<div class="logmsg"><span class="ts">{ts}</span> {message}</div>';var wsc_html_servermsg='<span class="servermsg">** {message} * <em>{info}</em></span>';var wsc_html_usermsg='<strong class="user">&lt;{user}&gt;</strong> {message}';Function.prototype.bind=function(b){var a=this;return function(){return a.apply(b,arguments)}};function scope_methods(b,a){for(cbn in a){b[cbn]=a[cbn].bind(b)}}Function.prototype.scope_methods=function(b,a){for(cbn in a){b[cbn]=a[cbn].bind(b)}};function bind(b,a){return a.bind(b)}function $_GET(e,b){b=b||window.location.search;var a=new RegExp("&"+e+"(?:=([^&]*))?(?=&|$)","i");b=b.replace(/^\?/,"&").match(a);if(b){return typeof b[1]!="undefined"?decodeURIComponent(b[1]):""}}function UnixTimestamp(a){ret=new Date(a*1000);return ret}var Months=["January","February","March","April","May","June","July","August","September","October","November","December"];function PosEnd(a){return a=="1"?"st":(a=="2"?"nd":(a=="3"?"rd":"th"))}function DateStamp(a){a=UnixTimestamp(a);date=String(a.getDate());month=a.getMonth();df=date[date.length-1];return date+PosEnd(df)+" of "+Months[month]+", "+a.getFullYear()}function caseInsensitiveSort(g,e){g=g.toLowerCase();e=e.toLowerCase();return((g>e)?1:(g<e?-1:0))}function CanCreateWebsocket(){if(window.WebSocket){return true}return false}function CreateWebSocket(a,g,j,b){if(!CanCreateWebsocket()){throw"This browser does not support websockets."}var e=null;if(typeof io==="undefined"){e=new WebSocket(a);e.onclose=g;e.onmessage=j;e.onopen=b}else{e=io.connect();b({},e);e.on("message",j);e.on("disconnect",g)}return e}function EscapeRegExp(a){return a.replace((new RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g")),"\\$1")}String.prototype.replacePArg=function(b,a){return replaceAll(this,b,a)};String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,e){return typeof a[e]!="undefined"?a[e]:b})};String.prototype.replaceAll=function(b,a){return replaceAllRaw(this,b,a)};replaceAllRaw=function(e,b,a){while(e.indexOf(b)>-1){e=e.replace(b,a)}return e};replaceAll=function(e,b,a){b=new RegExp(EscapeRegExp(b),"g");return e.replace(b,a||"")};Object.size=function(e){var b=0,a;for(a in e){if(e.hasOwnProperty(a)){b++}}return b};Object.steal=function(g,e){for(index in e){g[index]=e[index]}};Object.extend=function(g,e){obj={};Object.steal(obj,g);Object.steal(obj,e);return obj};var chains=[["recv","admin"]];function WscPacket(b,j){if(!(b)){return null}var a={cmd:null,param:null,arg:[],body:null,sub:[],raw:b};j=j||"=";try{idx=b.indexOf("\n\n");if(idx>-1){a.body=b.substr(idx+2);b=b.substr(0,idx)}args=b.split("\n");if(args[0].indexOf(j)==-1){cline=args.shift().split(" ");a.cmd=cline.shift()||null;if(cline.length>0){a.param=cline.join(" ")}}for(n in args){arg=args[n];si=arg.search(j);if(si==-1){continue}a.arg[arg.substr(0,si)]=arg.substr(si+j.length)||""}if(a.body!=null){subs=a.body.split("\n\n");for(i in subs){sub=WscPacket(subs[i],j);if(sub==null){break}a.sub.push(sub)}}}catch(g){return null}a.toString=function(){return packetToString(a)};a.name=packetEvtName(a);return a}function wsc_packetstr(j,l,e,a){var b="";if(j){b=j;if(l){b=b+" "+l}}if(e){for(var g in e){b=b+"\n"+g+"="+e[g]}}b=b+"\n";if(a){b=b+"\n"+a}return b}function packetToString(a){return wsc_packetstr(a.cmd,a.param,a.arg,a.body)}function packetEvtName(b){var g=b.cmd;var a=null;for(var e in chains){a=chains[e];if(a[0]!=g){continue}var j=b.sub[0];g=g+"_"+j.cmd;if(a.length>1&&j.param!=undefined){if(a[1]==j.cmd){return g+"_"+j.param}}}return g}function WscChannel(b,e,g){var a=b.deform_ns(e).slice(1).toLowerCase();this.client=b;this.hidden=g;this.info={raw:null,selector:null,namespace:null,members:{},pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""},};this.info.raw=b.format_ns(e);this.info.selector=a;this.info.namespace=this.info.ns=b.deform_ns(e);scope_methods(this,WscChannel.prototype)}WscChannel.prototype.property=function(a){var b=a.pkt.arg["p"];switch(b){case"title":case"topic":this.setHeader(b,a);break;case"privclasses":this.setPrivclasses(a);break;case"members":this.setMembers(a);break;default:this.client.monitor("Received unknown property "+b+" received in "+this.info.namespace+".");break}};WscChannel.prototype.setHeader=function(a,b){this.info[a]["content"]=b.value||"";this.info[a]["by"]=b.by;this.info[a]["ts"]=b.ts;if(!this.info[a]["content"]){}};WscChannel.prototype.setPrivclasses=function(g){this.info.pc={};this.info.pc_order=[];var a=g.pkt.body.split("\n");for(var b in a){if(!a[b]){continue}bits=a[b].split(":");this.info.pc_order.push(parseInt(bits[0]));this.info.pc[parseInt(bits[0])]=bits[1]}this.info.pc_order.sort(function(j,e){return e-j})};WscChannel.prototype.setMembers=function(a){pack=new WscPacket(a.pkt.body);this.info.members={};while(pack.cmd=="member"){this.registerUser(pack);pack=new WscPacket(pack.body);if(pack==null){break}}this.setUserList()};WscChannel.prototype.registerUser=function(a){un=a.param;if(this.info.members[un]==undefined){this.info.members[un]=a.arg;this.info.members[un]["username"]=un;this.info.members[un]["conn"]=1}else{this.info.members[un]["conn"]++}};WscChannel.prototype.removeUser=function(a){member=this.info.members[a];if(member==undefined){return}member.conn--;if(member.conn==0){delete this.info.members[a]}};WscChannel.prototype.recv_join=function(a){info=new WscPacket("user "+a.user+"\n"+a["*info"]);this.registerUser(info);this.setUserList()};WscChannel.prototype.recv_part=function(a){this.removeUser(a.user);this.setUserList()};WscChannel.prototype.recv_privchg=function(a){member=this.info.members[a.user];if(!member){return}member.pc=event.pc;this.setUserList()};WscChannel.prototype.recv_kicked=function(a){if(!this.info.members[a.user]){return}delete this.info.members[a.user];this.setUserList()};function wsc_channel(a,b,g){var e={client:null,info:{raw:"",selector:"",namespace:"",members:{},users:[],pc:{},pc_order:[],title:{content:"",by:"",ts:""},topic:{content:"",by:"",ts:""}},window:null,logpanel:null,wrap:null,userpanel:null,tab:null,built:false,hidden:false,monitor:false,thresh:null,init:function(l,m,q){var j=l.deform_ns(m).slice(1).toLowerCase();this.client=l;this.hidden=q;this.info.raw=l.format_ns(m);this.info.selector=j;this.info.namespace=l.deform_ns(m);this.monitor=Object.size(this.client.channelo)==0;this.thresh=10},build:function(){this.info.members={};if(this.built){return}var j=this.info.selector;b=this.info.namespace;this.client.tabul.append(wsc_html_chattab.replacePArg("{selector}",j).replacePArg("{ns}",b));this.client.chatbook.append(wsc_html_channel.replacePArg("{selector}",j).replacePArg("{ns}",b));this.tab=this.client.tabul.find("#"+j+"-tab");this.window=this.client.chatbook.find("#"+j+"-window");this.logpanel=this.client.view.find("#"+j+"-log");this.wrap=this.logpanel.find("div.logwrap");this.userpanel=this.client.view.find("#"+j+"-users");this.client.view.find('a[href="#'+j+'"]').click(function(){e.client.toggleChannel(j);return false});var l=true;this.window.click(function(m){if(l){e.client.control.focus()}else{l=true}});this.logpanel.select(function(){l=false});if(this.hidden){this.tab.toggleClass("hidden")}this.built=true},invisible:function(){e.hidden=true;e.tab.addClass("hidden")},remove:function(){selector=this.info.selector;this.tab.remove();this.window.remove()},hideChannel:function(){this.window.css({display:"none"});this.tab.removeClass("active")},showChannel:function(){this.window.css({display:"block"});this.tab.addClass("active");this.tab.removeClass("noise tabbed fill");this.resize()},toggleTabClass:function(j){this.tab.toggleClass(j)},scroll:function(){this.pad();this.wrap.scrollTop(this.wrap.prop("scrollHeight")-this.wrap.innerHeight())},pad:function(){this.wrap.css({"padding-top":0});wh=this.wrap.innerHeight();lh=this.logpanel.innerHeight()-this.logpanel.find("header").height()-3;pad=lh-wh;if(pad>0){this.wrap.css({"padding-top":pad})}else{this.wrap.css({"padding-top":0,height:lh})}},resize:function(){this.wrap.css({"padding-top":0});wh=this.client.chatbook.height();this.window.height(wh);cw=this.window.width();cu=this.window.find("div.chatusers");title=this.window.find("header div.title");topic=this.window.find("header div.topic");if(cu.css("display")!="none"){cw=cw-cu.outerWidth()}if(title.css("display")=="block"){wh=wh-title.outerHeight(true)}this.logpanel.css({height:wh+1,width:cw});this.scroll();cu.css({height:this.logpanel.innerHeight()-3})},log:function(j){this.logItem(wsc_html_logmsg.replacePArg("{message}",j))},logItem:function(l){if(this.hidden){if(this.thresh<=0){return}this.thresh--}var j=new Date().toTimeString().slice(0,8);this.wrap.append(wsc_html_logitem.replacePArg("{ts}",j).replacePArg("{message}",l));this.scroll()},serverMessage:function(l,j){this.logItem(wsc_html_servermsg.replacePArg("{message}",l).replacePArg("{info}",j))},property:function(j){var l=j.pkt.arg["p"];switch(l){case"title":case"topic":this.setHeader(l,j);break;case"privclasses":this.setPrivclasses(j);break;case"members":this.setMembers(j);break;default:a.monitor("Received unknown property "+l+" received in "+this.info.namespace+".");break}},setHeader:function(j,l){this.info[j]["content"]=l.value||"";this.info[j]["by"]=l.by;this.info[j]["ts"]=l.ts;if(!this.info[j]["content"]){}headd=this.window.find("header div."+j);headd.replaceWith(wsc_html_cheader.replacePArg("{head}",j).replacePArg("{content}",this.info[j]["content"]));headd=this.window.find("header div."+j);if(this.info[j]["content"]){headd.css({display:"block"})}else{this.window.find("header div."+j).css({display:"none"})}this.resize()},setUserList:function(){if(Object.size(this.info.members)==0){return}ulist='<div class="chatusers" id="'+this.info.selector+'-users">';pcs={};for(i in this.info.users){un=this.info.users[i];member=this.info.members[un];if(!(member.pc in pcs)){pcs[member.pc]=""}conn=member.conn==1?"":"["+member.conn+"]";s=member.symbol;pcs[member.pc]+='<li><a target="_blank" href="http://'+un+"."+this.client.settings.domain+'"><em>'+s+"</em>"+un+"</a>"+conn+"</li>"}for(var j in this.info.pc_order){pc=this.info.pc[this.info.pc_order[j]];if(!(pc in pcs)){continue}ulist=ulist+'<div class="pc"><h3>'+pc+"</h3><ul>"+pcs[pc]+"</ul></div>"}ulist=ulist+"</div>";this.window.find("div.chatusers").replaceWith(ulist);this.userpanel=this.window.find("div.chatusers");this.userpanel.css({display:"block"});pcs=this.userpanel.find("h3");if(typeof(pcs)=="object"){pcs.addClass("first")}else{for(j in pcs){if(j==0){pcs[0].addClass("first");continue}pcs[j].removeClass("first")}}this.resize();this.client.trigger("set.userlist",{name:"set.userlist",ns:this.info.namespace})},setPrivclasses:function(m){this.info.pc={};this.info.pc_order=[];var j=m.pkt.body.split("\n");for(var l in j){if(!j[l]){continue}bits=j[l].split(":");this.info.pc_order.push(parseInt(bits[0]));this.info.pc[parseInt(bits[0])]=bits[1]}this.info.pc_order.sort(function(v,q){return q-v})},setMembers:function(j){pack=new WscPacket(j.pkt.body);while(pack.cmd=="member"){this.registerUser(pack);pack=new WscPacket(pack.body);if(pack==null){break}}this.info.users=[];for(i in this.info.members){this.info.users.push(i)}this.info.users.sort(caseInsensitiveSort);this.setUserList()},registerUser:function(j){un=j.param;if(this.info.members[un]==undefined){this.info.members[un]=j.arg;this.info.members[un]["username"]=un;this.info.members[un]["conn"]=1}else{this.info.members[un]["conn"]++}},removeUser:function(j){member=this.info.members[j];if(member==undefined){return}member.conn--;if(member.conn==0){delete this.info.members[j]}},recv_join:function(j){info=new WscPacket("user "+j.user+"\n"+j["*info"]);e.registerUser(info);e.setUserList()},recv_part:function(j){e.removeUser(j.user);e.setUserList()},recv_msg:function(m){var j=this.tab;if(!this.tab.hasClass("active")){j.addClass("noise")}u=e.client.settings.username.toLowerCase();msg=m.message.toLowerCase();p=e.window.find(".logmsg").last();if(msg.indexOf(u)<0||p.html().toLowerCase().indexOf(u)<0){return}p.addClass("highlight");if(j.hasClass("active")){return}if(j.hasClass("tabbed")){return}var q=0;j.addClass("tabbed");function l(){q++;j.toggleClass("fill");if(q==6){return}setTimeout(l,1000)}l()},recv_privchg:function(j){member=e.info.members[j.user];if(!member){return}member.pc=event.pc;e.setUserList()},recv_kicked:function(j){if(!e.info.members[j.user]){return}delete e.info.members[j.user];e.setUserList()}};e.init(a,b,g);return e}function TablumpString(a,b){this._parser=b||new WscTablumps();this.raw=a;this._text=null;this._html=null;this._ansi=null}with(TablumpString.prototype=new String){toString=valueOf=function(){return this.raw}}TablumpString.prototype.html=function(){if(this._html==null){this._html=this._parser.render(1,this.raw)}return this._html};TablumpString.prototype.text=function(){if(this._text==null){this._text=this._parser.render(0,this.raw)}return this._text};TablumpString.prototype.ansi=function(){if(this._ansi==null){this._ansi=this._parser.render(2,this.raw)}return this._ansi};function WscTablumps(){this.lumps=this.defaultMap();this._lic=-1;this._licb=[];this._dent=0;this.repl=[/&(\/|)(b|i|u|s|sup|sub|code|p|ul|ol|li|a|iframe|acro|abbr)\t/g,"<$1$2>"]}WscTablumps.prototype.registerMap=function(a){this.lumps=a};WscTablumps.prototype.extend=function(a){this.lumps=Object.extend(this.lumps,a)};WscTablumps.prototype.defaultMap=function(){var g=function(){if(this._lic==-1){this._lic=0;return}this._licb.unshift(this._lic);this._lic=0;return};var e=function(){if(this._licb.length==0){this._lic=-1;return}this._lic=this._licb.shift()};var b=function(j){if((j||false)){g()}this._dent++;return"\n"};var a=function(j){if((j||false)){e()}this._dent--;return"\n"};return{"&b\t":[0,"","<b>","\1xb[1m"],"&/b\t":[0,"","</b>","\x1b[22m"],"&i\t":[0,"","<i>","\x1b[3m"],"&/i\t":[0,"","</i>","\x1b[23m"],"&u\t":[0,"","<u>","\x1b[4m"],"&/u\t":[0,"","</u>","\x1b[24m"],"&s\t":[0,"","<s>","\x1b[9m"],"&/s\t":[0,"","</s>","\x1b[29m"],"&sup\t":[0,"","<sup>"],"&/sup\t":[0,"","</sup>"],"&sup\t":[0,"","<sub>"],"&/sup\t":[0,"","</sub>"],"&code\t":[0,"","<code>"],"&/code\t":[0,"","</code>"],"&p\t":[0,"\n","<p>"],"&/p\t":[0,"\n","</p>"],"&ul\t":[0,function(j){return b(false)},"<ul>"],"&/ul\t":[0,function(j){return a(false)},"</ul>"],"&ol\t":[0,function(j){return b(true)},"<ol>"],"&li\t":[0,function(l){buf="\n    ";for(var j=0;j<this._dent;j++){buf=buf+"  "}if(this._lic==-1){buf=buf+"*."}else{this._lic++;buf=buf+String(this._lic)+"."}return buf+" "},"<li>"],"&/li\t":[0,"\n","</li>"],"&/ol\t":[0,function(j){return a(true)},"</ol>"],"&link\t":[3,function(j){return"[link:"+j[0]+"]"+(j[1]||"")+"[/link]"},function(j){t=j[1]||"[link]";return'<a target="_blank" href="'+j[0]+'" title="'+t+'">'+t+"</a>"}],"&acro\t":[1,"[acro:{0}]",'<acronym title="{0}">'],"&/acro\t":[0,"[/acro]","</acronym>"],"&abbr\t":[1,"[abbr:{0}]",'<abbr title="{0}">'],"&/abbr\t":[0,"[/abbr]","</abbr>"],"&img\t":[3,"`{2}`({0})",'<img src="{0}" alt="{1}" title="{2}" />'],"&iframe\t":[3,"[iframe:{0}]",'<iframe src="{0}" width="{1}" height="{2}" />'],"&/iframe\t":[0,"","</iframe>"],"&a\t":[2,"[link:{0}]",'<a href="{0}" title="{1}">','<a target="_blank" href="{0}" title="{1}">'],"&/a\t":[0,"[/link]","</a>"],"&br\t":[0,"\n","<br/>"],"&bcode\t":[0,"\n","<span><pre><code>"],"&/bcode\t":[0,"\n","</code></pre></span>"]}};WscTablumps.prototype.parse=function(b,a){return new TablumpString(b,this)};WscTablumps.prototype.render=function(a,b){return this._parse(a+1,b)};WscTablumps.prototype._parse=function(a,g,b){if(!g){return""}b=b||"\t";for(var e=0;e<g.length;e++){if(g[e]!="&"){continue}primer=g.substring(0,e);working=g.substring(e);ti=working.indexOf("\t");if(ti==-1){continue}tag=working.substring(0,ti+1);working=working.substring(ti+1);lump=this.lumps[tag];if(lump===undefined){continue}cropping=this.tokens(working,lump[0],b);renderer=lump[a]||lump[1];if(typeof(renderer)=="string"){parsed=renderer.format.apply(lump[1],cropping[0])}else{parsed=renderer(cropping[0])}g=primer+parsed+cropping[1];e=e+(parsed.length-2)}g=g.replace(this.repl[0],this.repl[1]);return g};WscTablumps.prototype.tokens=function(g,b,e,a){e=e||"\t";a=a||"&";tokens=[];for(i=b;i>0;i--){find=g.indexOf(e);if(find==-1){break}tokens.push(g.substring(0,find));g=g.substring(find+1);if(tokens[tokens.length-1]==a){tokens.pop();break}}return[tokens,g]};var dAmn_avext=["gif","gif","jpg","png"];function dAmn_avatar(a,b){b=parseInt(b);cachebuster=(b>>2)&15;b=b&3;ext=dAmn_avext[b]||"gif";if(cachebuster){cachebuster="?"+cachebuster}else{cachebuster=""}if(b==0){ico="default"}else{ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");ico="$un[0]/$un[1]/{un}".replace(ru,function(e,j,g){return a[g].toLowerCase()});ico=ico.replacePArg("{un}",a.toLowerCase())}return'<a target="_blank" title=":icon'+a+':" href="http://'+a+'.deviantart.com/"><img class="avatar"            alt=":icon'+a+':" src="http://a.deviantart.net/avatars/'+ico+"."+ext+cachebuster+'" height="50" width="50" /></a>'}function dAmnLumps(a){return{"&avatar\t":[2,":icon{0}:",function(b){return dAmn_avatar(b[0],b[1])}],"&emote\t":[5,"{0}",'<img alt="{0}" width="{1}" height="{2}" title="{3}" src="http://e.deviantart.com/emoticons/{4}" />'],"&dev\t":[2,":dev{1}:",'{0}<a target="_blank" alt=":dev{1}:" href="http://{1}.deviantart.com/">{1}</a>'],"&thumb\t":[7,":thumb{0}:",function(b){id=b[0];user=b[2];dim=b[3].split("x");w=parseInt(dim[0]);h=parseInt(dim[1]);f=b[5];flags=b[6].split(":");lu=user.substring(1).replace(/^[^a-zA-Z0-9\-_]/,"");t=b[1];ut=(t.replace(/[^A-Za-z0-9]+/g,"-").replace(/^-+/,"").replace(/-+$/,"")||"-")+"-"+id;title=t+" by "+user+", "+w+"x"+h;dal='<a target="_blank" href="http://'+lu+".deviantart.com/art/"+ut+'" title="'+title+'"';if(flags[1]!="0"){return dal+">[mature deviation: "+t+"]</a>"}if(flags[2]!="0"){return dal+">[deviation: "+t+"]</a>"}shadow=flags[0]=="0";isgif=f.match(/\.gif$/i);if(isgif&&(w>100||h>100)){return dal+">[deviation: "+t+"]</a>"}server=parseInt(b[4]);if(w/h>1){th=parseInt((h*100)/w);tw=100}else{tw=parseInt((w*100)/h);th=100}if(tw>w||th>h){tw=w;th=h}if(isgif){f=f.replace(/:/,"/");path="http://fc0"+server+".deviantart.net/"+f;det=f.split("/");if(det.length>1){det=det["."];if(det&&det.length>2){path="http://"+file}}return dal+'><img class="thumb" title="'+title+'" width="'+tw+'" height="'+th+'" alt=":thumb'+id+':" src="'+path+'" /></a>'}path="http://backend.deviantart.com/oembed?url=http://www.deviantart.com/deviation/"+id+"&format=thumb150";if(f.match(/.png$/i)){shadow=false}return dal+'><img class="thumb'+(shadow?" shadow":"")+'" width="'+tw+'" height="'+th+'" alt=":thumb'+id+':" src="'+path+'" /></a>'}],}}function wsc_protocol(a){var b={client:null,evt_chains:[["recv","admin"]],tablumps:null,maps:{chatserver:["version"],dAmnServer:["version"],login:["username",["e"],"data"],join:["ns",["e"]],part:["ns",["e","*r"]],property:["ns",["p","by","ts"],"*value"],recv_msg:[null,[["from","user"]],"*message"],recv_npmsg:[null,[["from","user"]],"message"],recv_action:[null,["s",["from","user"]],"*message"],recv_join:["user",["s"],"*info"],recv_part:["user",["s","r"]],recv_privchg:["user",["s","by","pc"]],recv_kicked:["user",["s","by"],"*r"],recv_admin_create:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_update:[null,["p",["by","user"],["name","pc"],"privs"]],recv_admin_rename:[null,["p",["by","user"],"prev",["name","pc"]]],recv_admin_move:[null,["p",["by","user"],"prev",["name","pc"],["n","affected"]]],recv_admin_remove:[null,["p",["by","user"],["name","pc"],["n","affected"]]],recv_admin_show:[null,["p"],"info"],recv_admin_showverbose:[null,["p"],"info"],recv_admin_privclass:[null,["p","e"],"command"],kicked:["ns",[["by","user"]],"*r"],ping:[],disconnect:[null,["e"]],send:["ns",["e"]],kick:["ns",[["u","user"],"e"]],get:["ns",["p","e"]],set:["ns",["p","e"]],kill:["ns",["e"]],unknown:[null,null,null,null,"packet"],},mapper:{recv:function(g,j,e){g.ns=j.param;sub=new WscPacket(j.body);if(sub.cmd=="admin"){ssub=new WscPacket(sub.body);return b.mapPacket(g,ssub,e)}return b.mapPacket(g,sub,e)}},messages:{chatserver:['<span class="servermsg">** Connected to llama {version} *</span>',false,true],dAmnServer:['<span class="servermsg">** Connected to dAmnServer {version} *</span>',false,true],login:['<span class="servermsg">** Login as {username}: "{e}" *</span>',false,true],join:['<span class="servermsg">** Join {ns}: "{e}" *</span>',true],part:['<span class="servermsg">** Part {ns}: "{e}" * <em>{*r}</em></span>',true],property:['<span class="servermsg">** Got {p} for {ns} *</span>',true],recv_msg:['<span class="cmsg user"><strong>&lt;{user}&gt;</strong></span><span class="cmsg">{message}</span>'],recv_action:['<span class="caction user"><em>* {user}</em></span><span class="caction">{message}</span>'],recv_join:['<span class="cevent bg">** {user} has joined *</span>'],recv_part:['<span class="cevent bg">** {user} has left * <em>{r}</em></span>'],recv_privchg:['<span class="cevent">** {user} has been made a member of {pc} by {by} *</span>'],recv_kicked:['<span class="cevent">** {user} has been kicked by {by} * <em>{*r}</em></span>'],recv_admin_create:['<span class="cevent admin">** Privilege class {pc} has been created by {user} with: {privs} *</span>'],recv_admin_update:['<span class="cevent admin">** Privilege class {pc} has been updated by {user} with: {privs} *</span>'],recv_admin_rename:['<span class="cevent admin">** Privilege class {prev} has been renamed to {name} by {user} *</span>'],recv_admin_move:['<span class="cevent admin">** All members of {prev} have been moved to {pc} by {user} -- {affected} affected user(s) *</span>'],recv_admin_remove:['<span class="cevent admin">** Privilege class {pc} has been removed by {user} -- {affected} affected user(s) *</span>'],recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:['<span class="cevent admin">** Admin command "{command}" failed: {e} *</span>'],kicked:['<span class="servermsg">** You have been kicked by {user} * <em>{r}</em></span>'],ping:['<span class="servermsg">** Ping...</span>',true],disconnect:['<span class="servermsg">** You have been disconnected * <em>{e}</em></span>',false,true],send:['<span class="servermsg">** Send error: <em>{e}</em></span>'],kick:['<span class="servermsg">** Could not kick {user}: <em>{e}</em></span>'],get:['<span class="servermsg">** Could not get {p} info for {ns}: <em>{e}</em></span>'],set:['<span class="servermsg">** Could not set {p}: <em>{e}</em></span>'],kill:['<span class="servermsg">** Kill error: <em>{e}</em></span>'],unknown:['<span class="servermsg">** Received unknown packet in {ns}: <em>{packet}</em></span>',true],},init:function(e){this.client=e;this.tablumps=new WscTablumps();if(this.client.settings.tablumps!==null){lumpmap=this.client.settings.tablumps();this.client.view.extend(lumpmap,this.tablumps.lumps);this.tablumps.registerMap(lumpmap)}e.bind("pkt.chatserver",this.chatserver);e.bind("pkt.dAmnServer",this.chatserver);e.bind("pkt.login",this.login);e.bind("pkt.join",this.join);e.bind("pkt.part",this.part);e.bind("pkt.ping",this.ping);e.bind("pkt.property",this.property);e.bind("pkt.recv_join",this.recv_joinpart);e.bind("pkt.recv_part",this.recv_joinpart);e.bind("pkt.recv_msg",this.recv_msg);e.bind("pkt.recv_action",this.recv_msg);e.bind("pkt.recv_privchg",this.recv_privchg);e.bind("pkt.recv_kicked",this.recv_kicked)},debug_pkt:function(g){console.log(g.pkt.serialize());console.log(g)},connected:function(e,g){console.log(g==undefined);if(g){this.client.conn=g}this.client.trigger("connected",{name:"connected",pkt:new WscPacket("connected\n\n")});console.log("Connection opened");this.client.connected=true;this.client.handshake();this.client.attempts=0},closed:function(e){console.log(e);this.client.trigger("closed",{name:"closed",pkt:new WscPacket("connection closed\n\n")});if(this.client.connected){this.client.monitorAll("Connection closed");this.client.connected=false}else{this.client.monitorAll("Connection failed")}if(this.client.attempts>2){this.client.monitorAll("Can't connect. Try again later.");this.client.attempts=0;return}this.client.monitorAll("Connecting in 2 seconds");c=this.client;setTimeout(function(){c.connect();c.monitorAll("Opening connection")},2000)},process_data:function(e){var g=new WscPacket(e.data);if(g==null){return}var j=this.client.event_name(g);pevt=this.packetEvent(j,g);this.log(pevt);this.client.trigger("pkt",pevt);this.client.trigger("pkt."+j,pevt)},packetEvent:function(g,j){var e={name:g,pkt:j,ns:this.client.mns};if(!this.maps[g]){return e}mapping=this.maps[g];cmd=j.cmd;if(this.mapper[cmd]){this.mapper[cmd](e,j,mapping)}else{this.mapPacket(e,j,mapping)}return e},mapPacket:function(l,e,g){for(var j in g){if(g[j]==null){continue}key=g[j];skey=key;switch(parseInt(j)){case 0:l[key]=e.param;break;case 1:if(g[1] instanceof Array){for(n in g[1]){key=g[1][n];if(key instanceof Array){l[key[1]]=e.arg[key[0]];skey=key[1]}else{k=key[0]=="*"?key.slice(1):key;l[key]=e.arg[k]||"";skey=key}}}if(typeof g[1]=="string"){l[key]=e.arg.slice(0)}break;case 2:if(key instanceof Array){this.mapPacket(l,new WscPacket(e.body),key)}else{l[key]=e.body}break}if(skey[0]!="*"){continue}k=skey.slice(1);val=this.tablumps.parse(l[skey]);l[k]=val.html()}},map_recv:function(j,e,g){},log:function(e){msgm=b.messages[e.name];if(!msgm){return}msg=msgm[0];if(e.s=="0"){return}for(key in e){d=key=="ns"?b.client.deform_ns(e[key]):e[key];msg=msg.replacePArg("{"+key+"}",d)}if(!msgm[2]){if(!msgm[1]){b.client.channel(e.ns).logItem(msg)}else{b.client.channel(b.client.mns).logItem(msg)}}else{b.client.logItemAll(msg)}},ping:function(e){b.client.pong()},chatserver:function(g){b.client.login()},login:function(g){if(g.pkt.arg["e"]=="ok"){info=new WscPacket("info\n"+g.data);b.client.settings.username=g.pkt.param;b.client.settings.symbol=info.arg.symbol;b.client.settings.userinfo=info.arg;if(b.client.fresh){b.client.join(a.settings.autojoin)}else{for(key in b.client.channelo){if(b.client.channelo[key].info.namespace[0]!="~"){b.client.join(key)}}}}else{}if(b.client.fresh){b.client.fresh=false}},join:function(g){if(g.pkt.arg["e"]=="ok"){ns=b.client.deform_ns(g.pkt.param);b.client.createChannel(ns);b.client.channel(ns).serverMessage("You have joined "+ns)}else{b.client.cchannel.serverMessage("Failed to join "+b.client.deform_ns(g.pkt.param),g.pkt.arg["e"])}},part:function(g){ns=b.client.deform_ns(g.ns);c=b.client.channel(ns);if(g.e=="ok"){info="";if(g.r){info="["+g.r+"]"}msg="You have left "+ns;c.serverMessage(msg,info);if(info==""){b.client.removeChannel(ns)}if(b.client.channels()==0){switch(g.r){case"bad data":case"bad msg":case"msg too big":break;default:if(g.r.indexOf("killed:")<0){return}break}b.process_data({data:"disconnect\ne="+g.r+"\n"})}}else{b.client.monitor("Couldn't leave "+ns,g.e);c.serverMessage("Couldn't leave "+ns,g.e)}},property:function(g){chan=b.client.channel(g.pkt.param);if(!chan){return}chan.property(g)},recv_joinpart:function(g){c=b.client.channel(g.ns);if(g.name=="recv_join"){c.recv_join(g)}else{c.recv_part(g)}},recv_msg:function(g){b.client.channel(g.ns).recv_msg(g)},recv_privchg:function(g){b.client.channel(g.ns).recv_privchg(g)},recv_kicked:function(g){b.client.channel(g.ns).recv_kicked(g)}};b.init(a);return b}function hovering(e,a,g,b){o=e.offset();eb=e.outerHeight(true)+o.top;er=e.outerWidth(true)+o.left;if(a>o.left&&a<er&&g>o.top&&g<eb){return true}if(b===true){if(a<(er+10)&&a>o.left&&g>o.top&&g<(o.top+10)){return true}}return false}function wsc_extdefault(a){var b={init:function(e){this.client=e;this.client.bind("cmd.set",this.setter.bind(b));this.client.bind("cmd.connect",this.connect.bind(b));this.client.bind("cmd.join",this.join.bind(b));this.client.bind("cmd.part",this.part.bind(b));this.client.bind("cmd.title",this.title.bind(b));this.client.bind("cmd.promote",this.promote.bind(b));this.client.bind("cmd.me",this.action.bind(b));this.client.bind("cmd.kick",this.kick.bind(b));this.client.bind("cmd.raw",this.raw.bind(b));this.client.bind("cmd.say",this.say.bind(b));this.client.bind("cmd.npmsg",this.npmsg.bind(b));this.client.bind("cmd.clear",this.clear.bind(b));this.client.bind("set.userlist",this.setUsers.bind(b));this.client.bind("cmd.theme",this.theme.bind(b))},theme:function(j,g){theme=g.settings.theme;select=j.args.split(" ").shift();if(g.default_themes.indexOf(select)==-1||theme==select){return}g.view.removeClass(theme).addClass(select);g.settings.theme=select},setter:function(g){data=g.args.split(" ");setting=data.shift().toLowerCase();data=data.join(" ");if(data.length==0){this.client.cchannel.serverMessage("Could not set "+setting,"No data supplied");return}if(!(setting in this.client.settings)){this.client.cchannel.serverMessage('Unknown setting "'+setting+'"');return}this.client.settings[setting]=data;this.client.cchannel.serverMessage("Changed "+setting+" setting","value: "+data);this.client.control.setLabel()},connect:function(g){this.client.connect()},join:function(g){chans=g.args.split(" ");chans=chans.toString()==""?[]:chans;if(g.ns!=g.target){chans.unshift(g.target)}if(chans.toString()==""){return}for(index in chans){b.client.join(chans[index])}},part:function(g){chans=g.args.split(" ");if(g.ns!=g.target){chans.unshift(g.target)}if(chans.toString()==""){b.client.part(g.ns);return}for(index in chans){b.client.part(chans[index])}},title:function(g){b.client.title(g.target,g.args)},promote:function(g){bits=g.args.split(" ");b.client.promote(g.target,bits[0],bits[1])},action:function(g){b.client.action(g.target,g.args)},raw:function(g){b.client.send(g.args.replace(/\\n/gm,"\n"))},kick:function(g){d=g.args.split(" ");u=d.shift();r=d.length>0?d.join(" "):null;b.client.kick(g.target,u,r)},say:function(g){b.client.say(g.target,g.args)},npmsg:function(g){b.client.npmsg(g.target,g.args)},clear:function(g){this.client.cchannel.logpanel.find("p.logmsg").remove();this.client.cchannel.resize()},setUsers:function(j){var g=b.client.channel(j.ns);users=g.userpanel.find("li a");users.each(function(l,m){var y=g.userpanel.find(m);var z=y.html().substr(10);var x=g.info.members[z];var e=null;y.data("hover",0);function v(A){if(hovering(e,A.pageX,A.pageY,true)){return}e.remove()}ru=new RegExp("\\$un(\\[([0-9]+)\\])","g");function q(A,C,B){return x.username[B].toLowerCase()}y.hover(function(A){g.window.find(this).data("hover",1);rn=x.realname?"<li>"+x.realname+"</li>":"";tn=x.typename?"<li>"+x.typename+"</li>":"";pane='<div class="userinfo" id="'+x.username+'">                                <div class="avatar">                                    '+dAmn_avatar(x.username,x.usericon)+'                                </div><div class="info">                                <strong>                                '+x.symbol+'<a target="_blank" href="http://'+x.username+"."+b.client.settings.domain+'/">'+x.username+"</a>                                </strong>                                <ul>                                    "+rn+tn+"                                </ul></div>                            </div>";g.window.append(pane);e=g.window.find(".userinfo#"+x.username);pos=y.offset();e.css({top:(pos.top-y.height())+10,left:(pos.left-(e.width()))-6});e.hover(function(){g.window.find(this).data("hover",1)},v);e.data("hover",0);box=g.window.find("div.userinfo:not('#"+x.username+"')");box.remove()},function(A){g.window.find(this).data("hover",0);v(A)})})},};b.init(a);return b}function wsc_client(b,e,g){var a={view:null,mozilla:false,control:null,tabul:null,chatbook:null,connected:false,conn:null,fresh:true,evt_chains:[["recv","admin"]],events:null,attempts:0,default_themes:["wsct_default","wsct_test"],settings:{domain:"website.com",server:"ws://website.com/wsendpoint",agent:"wsc 0.1a",symbol:"",username:"",userinfo:{},pk:"",monitor:["~Monitor",true],welcome:"Welcome to the wsc web client!",autojoin:"chat:channel",protocol:wsc_protocol,extend:[wsc_extdefault],control:wsc_control,stype:"llama",client:"chatclient",clientver:"0.3",tablumps:null,avatarfile:"$un[0]/$un[1]/{un}",defaultavatar:"default.gif",avatarfolder:"/avatars/",emotefolder:"/emoticons/",thumbfolder:"/thumbs/",theme:"wsct_default",},protocol:null,channelo:{},cchannel:null,cmds:[],init:function(j,m,q){j.extend(this.settings,m);j.append('<div class="wsc '+this.settings.theme+'"></div>');this.attempts=0;this.view=j.find(".wsc");this.mozilla=q;this.connected=false;this.conn=null;this.events=new EventEmitter();this.mns=this.format_ns(this.settings.monitor[0]);this.lun=this.settings.username.toLowerCase();this.channelo={};this.protocol=this.settings.protocol(this);this.buildUI();this.cmds=[];for(var l in this.settings.extend){this.settings.extend[l](this)}this.monitor(this.settings.welcome)},registerExtension:function(j){if(container===undefined){return}a.settings.extend.push(j);j(a)},jq_registerExtension:function(j,l){a.registerExtension(l)},bind:function(l,j){this.events.addListener(l,j);if(l.indexOf("cmd.")!=0||l.length<=4){return}cmd=l.slice(4).toLowerCase();this.cmds.push(cmd)},jq_bind:function(j,l){a.bind(l.event,l.handler)},removeListeners:function(){this.events.removeListeners()},trigger:function(j,l){a.events.emit(j,l,a)},jq_trigger:function(j,l){a.trigger(l.event,l.data)},channel:function(j,l){j=this.deform_ns(j).slice(1).toLowerCase();if(!this.channelo[j]&&l){this.channelo[j]=l}return this.channelo[j]},channels:function(){chans=-1;for(ns in a.channelo){if(a.channelo[ns].hidden){continue}chans++}return chans},connect:function(){if(a.connected){return}this.attempts++;if(CanCreateWebsocket()){a.conn=a.createChatSocket();a.trigger("start",new WscPacket("client connecting\ne=ok\n\n"))}else{a.monitor("Your browser does not support WebSockets. Sorry.");a.trigger("start",new WscPacket("client connecting\ne=no websockets available\n\n"))}},jq_connect:function(){a.connect()},createChatSocket:function(){var j=this;return CreateWebSocket(this.settings.server,function(l){j.protocol.closed(l)},function(l){j.protocol.process_data(l)},function(l,m){j.protocol.connected(l,m)})},buildUI:function(){this.view.append(wsc_html_ui);this.control=this.settings.control(this);this.tabul=this.view.find("#chattabs");this.chatbook=this.view.find("div.chatbook");hide=this.settings.monitor[1];this.createChannel(this.mns,hide);this.control.setInput();this.control.focus()},resizeUI:function(){a.control.resize();a.view.height(a.view.parent().height());a.view.width("100%");h=(a.view.parent().height()-a.tabul.outerHeight(true)-a.control.height());a.chatbook.height(h);for(select in a.channelo){chan=a.channel(select);chan.resize()}},loop:function(){a.doLoop()},doLoop:function(){for(key in this.channelo){c=this.channelo[key];msgs=c.logpanel.find(".logmsg");if(msgs.length<200){continue}while(msgs.length>200){msgs.slice(0,10).remove();msgs=c.logpanel.find(".logmsg")}c.resize()}},createChannel:function(l,j){chan=this.channel(l,wsc_channel(this,l,j));chan.build();this.toggleChannel(l);this.resizeUI()},removeChannel:function(l){if(this.channels()==0){return}chan=this.channel(l);chan.remove();delete this.channelo[chan.info.selector];var j="";for(tmp in this.channelo){if(this.channelo.hasOwnProperty(tmp)&&tmp!=chan.info.selector){j=tmp}}this.toggleChannel(j);this.channel(j).resize()},toggleChannel:function(j){chan=this.channel(j);if(!chan){return}if(this.cchannel){if(this.cchannel==chan){return}this.cchannel.hideChannel();this.control.cacheInput()}chan.showChannel();this.control.focus();this.cchannel=chan;this.control.setLabel();if(this.settings.monitor[1]){mt=this.tabul.find("#"+this.channel(this.mns).info.selector+"-tab");mt.addClass(this.settings.monitor[1])}},log:function(j,m){var l=this.channel(j);if(!l){return}l.log(m)},logAll:function(j){for(ns in this.channelo){this.channlo[ns].log(j)}},logItemAll:function(j){for(ns in this.channelo){this.channelo[ns].logItem(j)}},monitorAll:function(l,j){for(ns in this.channelo){this.channelo[ns].serverMessage(l,j)}},serverMessage:function(j,q,m){var l=this.channel(j);if(!l){return}l.serverMessage(q,m)},monitor:function(l,j){this.serverMessage(this.mns,l,j)},deform_ns:function(j){if(j.indexOf("chat:")==0){return"#"+j.slice(5)}if(j.indexOf("server:")==0){return"~"+j.slice(7)}if(j.indexOf("pchat:")==0){var l=j.split(":");l.shift();for(i in l){name=l[i];if(name.toLowerCase()!=this.lun){return"@"+name}}}if(j.indexOf("login:")==0){return"@"+j.slice(6)}if(j[0]!="#"&&j[0]!="@"&&j[0]!="~"){return"#"+j}return j},format_ns:function(j){if(j.indexOf("#")==0){return"chat:"+j.slice(1)}if(j.indexOf("@")==0){var l=[j.slice(1),this.lun];l.sort(caseInsensitiveSort);l.unshift("pchat");return l.join(":")}if(j.indexOf("~")==0){return"server:"+j.slice(1)}if(j.indexOf("chat:")!=0&&j.indexOf("server:")!=0&&j.indexOf("pchat:")!=0){return"chat:"+j}return j},event_name:function(l){var q=l.cmd;var j=null;for(var m in this.evt_chains){j=this.evt_chains[m];if(j[0]!=q){continue}var v=new WscPacket(l.body);q=q+"_"+v.cmd;if(j.length>1&&v.param!=undefined){if(j[1]==v.cmd){return q+"_"+v.param}}}return q},send:function(j){if(this.connected){return this.conn.send(j)}return -1},handshake:function(){this.send(wsc_packetstr(this.settings.client,this.settings.clientver,{agent:this.settings.agent}))},pong:function(){this.send(wsc_packetstr("pong"))},login:function(){pkt="login "+this.settings.username+"\npk="+this.settings.pk+"\n";this.send(pkt)},join:function(j){this.send(wsc_packetstr("join",this.format_ns(j)))},part:function(j){this.send(wsc_packetstr("part",this.format_ns(j)))},promote:function(m,j,l){this.send(wsc_packetstr("send",this.format_ns(m),{},wsc_packetstr("promote",j,{},(!l?"":l))))},say:function(j,l){this.trigger({name:"send.msg.before",msg:l,ns:j});this.send(wsc_packetstr("send",this.format_ns(j),{},wsc_packetstr("msg","main",{},l)))},npmsg:function(j,l){this.send(wsc_packetstr("send",this.format_ns(j),{},wsc_packetstr("npmsg","main",{},l)))},action:function(j,l){this.send(wsc_packetstr("send",this.format_ns(j),{},wsc_packetstr("action","main",{},l)))},title:function(j,l){this.send(wsc_packetstr("set",this.format_ns(j),{p:"title"},l))},kick:function(l,j,m){this.send(wsc_packetstr("kick",this.format_ns(l),{u:j},m?m:null))},};a.init(b,e,g);return a}function wsc_control(a){var b={client:null,panel:null,form:null,history:{},tab:{hit:false,cache:"",matched:[],index:-1,type:0,prefix:["","/",""],},init:function(e){this.client=e;this.draw();this.panel=this.client.view.find("div.chatcontrol");this.form=this.panel.find("form.msg");this.input=this.form.find("input.msg")},draw:function(){this.client.view.append(wsc_html_control)},focus:function(){b.input.focus()},userLine:function(){return this.client.settings.symbol+this.client.settings.username},resize:function(){this.panel.css({width:"100%"});this.form.css({width:"100%"});this.input.css({width:this.client.view.width()-80})},height:function(){return this.panel.height()+17},setLabel:function(){ns=this.client.cchannel.info.namespace;this.untab();h=this.getHistory();this.input.val(h.index==-1?h.tmp:h.list[h.index]);if(h.index==-1){h.tmp=""}},cacheInput:function(){h=this.getHistory();if(h.index>-1){return}h.tmp=this.input.val()},setInput:function(){if(this.client.mozilla){this.input.keypress(this.keypress)}else{this.input.keydown(this.keypress)}this.form.submit(this.submit)},getHistory:function(){ns=this.client.cchannel.info.namespace;if(!this.history[ns]){this.history[ns]={index:-1,list:[],tmp:""}}return this.history[ns]},appendHistory:function(e){if(!e){return}h=this.getHistory();h.list.unshift(e);h.index=-1;if(h.list.length>100){h.list.pop()}},scrollHistory:function(e){history=this.getHistory();data=this.input.val();if(history.index==-1){if(data){history.tmp=data}else{history.list[history.index]=data}}if(e){if(history.list.length>0&&history.index<(history.list.length-1)){history.index++}}else{if(history.index>-1){history.index--}}this.setLabel()},keypress:function(e){key=e.which||e.keypress;ut=b.tab.hit;bubble=false;switch(key){case 13:b.submit(e);break;case 38:b.scrollHistory(true);break;case 40:b.scrollHistory(false);break;case 9:b.tabItem(e);ut=false;break;default:bubble=true;break}if(ut){b.untab(e)}return bubble},submit:function(e){msg=b.input.val();b.appendHistory(msg);b.input.val("");b.handleInput(e,msg);return false},untab:function(e){this.tab.hit=false;this.tab.matched=[];this.tab.cache="";this.tab.index=-1},newtab:function(e){this.tab.hit=true;this.tab.index=-1;this.tab.matched=[];this.tab.type=0;needle=this.chomp();this.unchomp(needle);if(needle[0]=="/"||needle[0]=="#"){this.tab.type=needle[0]=="/"?1:2;needle=needle.slice(1)}else{this.tab.type=0}this.tab.cache=needle;needle=needle.toLowerCase();this.tab.matched=[];if(this.tab.type==0){for(user in this.client.cchannel.info.members){if(user.toLowerCase().indexOf(needle)==0){this.tab.matched.push(user)}}}else{if(this.tab.type==1){for(i in this.client.cmds){cmd=this.client.cmds[i];if(cmd.indexOf(needle)==0){this.tab.matched.push(cmd)}}}else{if(this.tab.type==2){for(chan in this.client.channelo){if(chan.toLowerCase().indexOf(needle)==0){this.tab.matched.push(this.client.channel(chan).info.namespace)}}}}}},tabItem:function(e){if(!this.tab.hit){this.newtab(e)}this.chomp();this.tab.index++;if(this.tab.index>=this.tab.matched.length){this.tab.index=-1}if(this.tab.index==-1){this.unchomp(this.tab.prefix[this.tab.type]+this.tab.cache);return}suf=this.input.val()==""?(this.tab.type==0?": ":" "):"";this.unchomp(this.tab.prefix[this.tab.type]+this.tab.matched[this.tab.index]+suf)},chomp:function(){d=this.input.val();i=d.lastIndexOf(" ");if(i==-1){this.input.val("");return d}chunk=d.slice(i+1);this.input.val(d.slice(0,i));if(chunk.length==0){return this.chomp()}return chunk},unchomp:function(e){d=this.input.val();if(!d){this.input.val(e)}else{this.input.val(d+" "+e)}},handleInput:function(j,g){if(g==""){return}if(g[0]!="/"){if(!this.client.cchannel){return}}g=(j.shiftKey?"/npmsg ":(g[0]=="/"?"":"/say "))+g;g=g.slice(1);bits=g.split(" ");cmdn=bits.shift();ens=this.client.cchannel.info.namespace;etarget=ens;if(bits[0]){hash=bits[0][0];if((hash=="#"||hash=="@")&&bits[0].length>1){etarget=this.client.format_ns(bits.shift())}}arg=bits.join(" ");this.client.trigger("cmd."+cmdn,{name:"cmd",cmd:cmdn,args:arg,target:etarget,ns:ens})},};b.init(a);return b}(function(a){a("*").hover(function(b){a(this).data("hover",true)},function(b){a(this).data("hover",false)});a.fn.wsc=function(e,b){client=a(window).data("wscclient");if(e=="init"||client===undefined){if(client==undefined){client=wsc_client(a(this),b,a.browser.mozilla);a(window).resize(client.resizeUI);a(window).focus(function(){client.control.focus()});setInterval(client.loop,120000)}a(window).data("wscclient",client)}if(e!="init"&&e!=undefined){e="jq_"+e;if(e in client){client[e](a(this),b)}}return client}})(jQuery);